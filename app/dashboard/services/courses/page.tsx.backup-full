"use client"

import { useState, useEffect } from "react"
import MainLayout from "@/components/main-layout"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { LayoutDashboard, BookOpen, Users } from "lucide-react"
import HeroSection from "@/components/courses/HeroSection"
import DraftsDialog from "@/components/courses/DraftsDialog"
import ConfirmationDialog from "@/components/courses/ConfirmationDialog"
import AddCourseDialog from "@/components/courses/AddCourseDialog"
import DashboardTab from "@/components/courses/DashboardTab"
import CoursesTab from "@/components/courses/CoursesTab"
import CohortsTab from "@/components/courses/CohortsTab"

// Import the correct Course type
import { Course } from "@/types/course"

// Custom hooks
import { useCourseManagement } from "@/hooks/useCourseManagement"
import { useCourseFilters } from "@/hooks/useCourseFilters"
import { useColumnManagement } from "@/hooks/useColumnManagement"

type DraftType = {
  id: string
  name: string
  instructor: string
  description: string
  updatedAt: number
  level?: string
  type?: string
  priceINR?: number
  schedule?: string
  maxStudents?: number
  location?: string
  tags?: string[]
  status?: string
  courseCategory?: string
  [key: string]: any
}

interface Cohort {
  id: string;
  name: string;
  courseId: string;
  notes: string;
  status: string;
  startDate?: string;
  endDate?: string;
  startTime?: string;
  endTime?: string;
  capacity: number;
  members: { id: string; name: string; }[];
  location?: string;
  instructorName?: string;
}




export default function EnhancedCourseManagementPage() {
  // State management
  const [courses, setCourses] = useState<Course[]>([])
  const [studentCount, setStudentCount] = useState<number | null>(null);
  // Fetch student count from API (dashboard logic)
  useEffect(() => {
    fetch("/api/students")
      .then((res) => res.json())
      .then((data) => {
        if (data.count !== undefined) {
          setStudentCount(data.count);
        } else if (data.numStudents !== undefined) {
          setStudentCount(data.numStudents);
        } else {
          setStudentCount(null);
        }
      })
      .catch(() => setStudentCount(null));
  }, []);
  const [drafts, setDrafts] = useState<DraftType[]>([])
  const [cohorts, setCohorts] = useState<Cohort[]>([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState("")
  const [selectedCourse, setSelectedCourse] = useState<Course | null>(null)
  const [activeTab, setActiveTab] = useState("all")
  const [isEditMode, setIsEditMode] = useState(false)
  const [editCourseId, setEditCourseId] = useState<string | null>(null)
  const [currency, setCurrency] = useState<"USD" | "INR">("INR")
  const [viewMode, setViewMode] = useState<"grid" | "list">("grid")
  const [filterDropdownOpen, setFilterDropdownOpen] = useState(false)
  const [filterAction, setFilterAction] = useState<string | null>(null)
  const [showCohortInfo, setShowCohortInfo] = useState(false)
  
  // Filter states
  const [selectedFilters, setSelectedFilters] = useState({
    level: [] as string[],
    type: [] as string[],
    status: [] as string[],
    priceRange: [0, 100000] as [number, number],
    category: [] as string[],
  })

  const [pendingFilters, setPendingFilters] = useState({ ...selectedFilters })
  const [sortBy, setSortBy] = useState("name")
  const [sortOrder, setSortOrder] = useState<"asc" | "desc">("asc")
  
  // Dialog states
  const [isAddCourseDialogOpen, setIsAddCourseDialogOpen] = useState(false)
  const [isViewCourseDialogOpen, setIsViewCourseDialogOpen] = useState(false)
  const [isDraftsDialogOpen, setIsDraftsDialogOpen] = useState(false)
  const [isMarketingDialogOpen, setIsMarketingDialogOpen] = useState(false)
  const [isAnalyticsDialogOpen, setIsAnalyticsDialogOpen] = useState(false)
  const [isFinancialDialogOpen, setIsFinancialDialogOpen] = useState(false)
  
  // Navigation tab state
  const [currentTab, setCurrentTab] = useState("courses")
  
  // Column selection state
  const [isColumnSelectionOpen, setIsColumnSelectionOpen] = useState(false)
  const [selectedAvailableColumns, setSelectedAvailableColumns] = useState<string[]>([])
  const [selectedDisplayedColumns, setSelectedDisplayedColumns] = useState<string[]>([])

  // Define all available columns for the table
  const allColumns = [
    { id: 'courseId', label: 'Course ID' },
    { id: 'name', label: 'Course Name' },
    { id: 'instructor', label: 'Instructor' },
    { id: 'location', label: 'Location' },
    { id: 'type', label: 'Type' },
    { id: 'level', label: 'Level' },
    { id: 'priceINR', label: 'Price (INR)' },
    { id: 'status', label: 'Status' },
    { id: 'courseCategory', label: 'Category' },
    { id: 'maxStudents', label: 'Max Students' },
    { id: 'duration', label: 'Duration' },
    { id: 'description', label: 'Description' },
    { id: 'tags', label: 'Tags' },
    { id: 'skills', label: 'Skills' },
    { id: 'prerequisites', label: 'Prerequisites' }
  ]

  // Default displayed columns (similar to current table structure)
  const defaultDisplayedColumns = ['courseId', 'name', 'instructor', 'location', 'type', 'level', 'priceINR', 'status']
  
  const [displayedColumns, setDisplayedColumns] = useState<string[]>(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem('courseTableColumns')
      return saved ? JSON.parse(saved) : defaultDisplayedColumns
    }
    return defaultDisplayedColumns
  })
  
  // New course form state
  const [newCourseForm, setNewCourseForm] = useState({
    id: '',
    name: '',
    instructor: '',
    description: '',
    level: 'Beginner',
    type: 'Online',
    duration: '',
    priceINR: '',
    schedule: '',
    maxStudents: '',
    location: '',
    tags: ['Beginner'],
    schedulePeriod: { startDate: '', endDate: '', totalWeeks: '18' },
    sessionDetails: { sessionDuration: '', maxClasses: '18' },
    frequencyDetails: { selectedDays: [] as string[], dayTimes: {} as Record<string, any> },
    frequencies: [] as { days: string[]; start: string; end: string; sessions: string }[],
    chapters: [{ name: '', description: '' }],
    referralCode: '',
    commissionRate: '',
    referralStart: '',
    referralEnd: '',
    referralStatus: 'Inactive',
    faqs: [{ question: '', answer: '', isEditing: false }],
    reminderSettings: {
      pushEnabled: true,
      emailEnabled: true,
      smsEnabled: true,
      customSchedule: [] as {
        type: string;
        daysBefore: string;
        hoursBefore: string;
        timeOfDay: string;
        enabled: boolean;
        customType?: string;
      }[],
      frequency: '',
      customDays: '',
      customInterval: ''
    },
    freeGifts: [] as string[],
    status: "Active",
    courseCategory: "Regular"
  })
  
  // Confirmation dialog state
  const [deleteConfirmDialog, setDeleteConfirmDialog] = useState<{
    isOpen: boolean,
    title: string,
    message: string,
    onConfirm: () => void,
    itemName?: string,
    confirmButtonText?: string
  }>({
    isOpen: false,
    title: '',
    message: '',
    onConfirm: () => {},
    itemName: undefined,
    confirmButtonText: undefined
  })

  // Function to refetch drafts
  const refetchDrafts = async () => {
    try {
      console.log('ðŸ”„ Refetching drafts from API...');
      const response = await fetch("/api/drafts");
      const draftsData = await response.json();
      
      console.log(' Raw drafts API response:', draftsData);
      
      if (draftsData.success && draftsData.drafts) {
        console.log(' Refetched drafts (success):', draftsData.drafts.length, 'drafts');
        console.log(' Draft details:', draftsData.drafts.map((d: any) => ({ id: d.id, name: d.name, updatedAt: d.updatedAt })));
        setDrafts(draftsData.drafts);
      } else if (Array.isArray(draftsData)) {
        console.log(' Refetched drafts (array):', draftsData.length, 'drafts');
        console.log(' Draft details:', draftsData.map((d: any) => ({ id: d.id, name: d.name, updatedAt: d.updatedAt })));
        setDrafts(draftsData);
      } else {
        console.log(' No drafts found during refetch');
        setDrafts([]);
      }
    } catch (error) {
      console.error('âŒ Error refetching drafts:', error);
    }
  };

  // Event listener for opening drafts dialog and draft saved events
  useEffect(() => {
    const handleOpenDrafts = async () => {
      // Refetch drafts before opening the dialog to ensure latest data
      await refetchDrafts();
      setIsDraftsDialogOpen(true);
    };

    const handleDraftSaved = async () => {
      // Refetch drafts when a draft is saved
      console.log('Draft saved event received, refetching drafts...');
      await refetchDrafts();
    };
    
    window.addEventListener('openDraftsDialog', handleOpenDrafts);
    window.addEventListener('draftSaved', handleDraftSaved);
    
    return () => {
      window.removeEventListener('openDraftsDialog', handleOpenDrafts);
      window.removeEventListener('draftSaved', handleDraftSaved);
    };
  }, []);

  // Load initial data
  useEffect(() => {
    setLoading(true);
    Promise.all([
      fetch("/api/courses").then(res => res.json()),
      fetch("/api/drafts").then(res => res.json()).catch(() => []),
      fetch('/api/cohorts').then(res => res.json()).catch(() => [])
    ]).then(([coursesData, draftsData, cohortsData]) => {
      // Handle courses data
      if (coursesData.success && coursesData.courses) {
        setCourses(coursesData.courses);
      } else if (Array.isArray(coursesData)) {
        setCourses(coursesData);
      } else {
        setCourses([]);
      }
      
      // Handle drafts data
      console.log(' Raw drafts response during initial load:', draftsData);
      if (draftsData.success && draftsData.drafts) {
        console.log(' Setting drafts from success response:', draftsData.drafts.length, 'drafts');
        console.log(' Draft details:', draftsData.drafts.map((d: any) => ({ id: d.id, name: d.name, updatedAt: d.updatedAt })));
        setDrafts(draftsData.drafts);
      } else if (Array.isArray(draftsData)) {
        console.log(' Setting drafts from array response:', draftsData.length, 'drafts');
        console.log(' Draft details:', draftsData.map((d: any) => ({ id: d.id, name: d.name, updatedAt: d.updatedAt })));
        setDrafts(draftsData);
      } else {
        console.log(' No drafts found during initial load, setting empty array');
        setDrafts([]);
      }
      
      // Handle cohorts data
      if (cohortsData.success && cohortsData.cohorts) {
        // Ensure members are in the correct format
        const formattedCohorts = cohortsData.cohorts.map((cohort: any) => ({
          ...cohort,
          members: Array.isArray(cohort.members) 
            ? cohort.members.map((member: any) => 
                typeof member === 'string' 
                  ? { id: member, name: member }
                  : { id: member.id || '', name: member.name || '' }
              )
            : []
        }));
        setCohorts(formattedCohorts);
      } else if (Array.isArray(cohortsData)) {
        // Same transformation for array response
        const formattedCohorts = cohortsData.map((cohort: any) => ({
          ...cohort,
          members: Array.isArray(cohort.members)
            ? cohort.members.map((member: string | { id?: string; name?: string }) => 
                typeof member === 'string'
                  ? { id: member, name: member }
                  : { id: member.id || '', name: member.name || '' }
              )
            : []
        }));
        setCohorts(formattedCohorts);
      } else {
        setCohorts([]);
      }
      
      setLoading(false);
    }).catch((error) => {
      setCourses([]);
      setDrafts([]);
      setCohorts([]);
      setLoading(false);
    });
  }, []);

  // Calculate statistics with safety checks
  const stats = {
    totalCourses: Array.isArray(courses) ? courses.length : 0,
    activeCourses: Array.isArray(courses) ? courses.filter(c => c.status === "Active").length : 0,
    totalStudents: studentCount,
    totalRevenue: Array.isArray(courses) ? courses.reduce((sum, c) => sum + (currency === "INR" ? (c.priceINR || 0) : (c.price || 0)) * (c.enrolledStudents || 0), 0) : 0,
    averageRating: Array.isArray(courses) && courses.length > 0 ? courses.reduce((sum, c) => sum + (c.rating || 0), 0) / courses.length : 0,
    completionRate: Array.isArray(courses) && courses.length > 0 ? courses.reduce((sum, c) => sum + (c.completionRate || 0), 0) / courses.length : 0,
  }

  // Chart data preparation
  const courseStatusData = [
    { name: 'Active', value: stats.activeCourses, color: '#10b981' },
    { name: 'Inactive', value: stats.totalCourses - stats.activeCourses, color: '#ef4444' }
  ]

  const courseTypeData = Array.isArray(courses) ? (() => {
    const typeCounts: { [key: string]: number } = {}
    courses.forEach(course => {
      const type = course.type || 'Unknown'
      typeCounts[type] = (typeCounts[type] || 0) + (course.enrolledStudents || 0)
    })
    return Object.entries(typeCounts).map(([type, students]) => ({
      type,
      students,
      fill: type === 'Online' ? '#3b82f6' : type === 'Offline' ? '#f59e0b' : '#8b5cf6'
    }))
  })() : []

  const categoryData = Array.isArray(courses) ? (() => {
    const categoryCounts: { [key: string]: number } = {}
    courses.forEach(course => {
      const category = course.courseCategory || 'General'
      categoryCounts[category] = (categoryCounts[category] || 0) + 1
    })
    return Object.entries(categoryCounts).map(([category, count]) => ({
      category,
      count,
      fill: category === 'Regular' ? '#10b981' : category === 'Premium' ? '#f59e0b' : '#8b5cf6'
    }))
  })() : []

  // Mock revenue trend data (in real app, this would come from analytics)
  const revenueTrendData = [
    { month: 'Jan', revenue: 45000 },
    { month: 'Feb', revenue: 52000 },
    { month: 'Mar', revenue: 48000 },
    { month: 'Apr', revenue: 61000 },
    { month: 'May', revenue: 55000 },
    { month: 'Jun', revenue: 67000 }
  ]

  // Chart configurations
  const chartConfig = {
    active: { label: "Active Courses", color: "#10b981" },
    inactive: { label: "Inactive Courses", color: "#ef4444" },
    online: { label: "Online Courses", color: "#3b82f6" },
    offline: { label: "Offline Courses", color: "#f59e0b" },
    regular: { label: "Regular", color: "#10b981" },
    premium: { label: "Premium", color: "#f59e0b" },
    revenue: { label: "Revenue (INR)", color: "#8b5cf6" }
  }

  // Column management functions
  const availableColumns = useMemo(() => 
    allColumns.filter(col => !displayedColumns.includes(col.id)),
    [displayedColumns]
  )

  const moveColumnsToDisplayed = () => {
    const newDisplayed = [...displayedColumns, ...selectedAvailableColumns]
    setDisplayedColumns(newDisplayed)
    setSelectedAvailableColumns([])
  }

  const moveColumnsToAvailable = () => {
    const newDisplayed = displayedColumns.filter(col => !selectedDisplayedColumns.includes(col))
    setDisplayedColumns(newDisplayed)
    setSelectedDisplayedColumns([])
  }

  const moveColumnUp = (index: number) => {
    if (index > 0) {
      const newDisplayed = [...displayedColumns]
      const temp = newDisplayed[index]
      newDisplayed[index] = newDisplayed[index - 1]
      newDisplayed[index - 1] = temp
      setDisplayedColumns(newDisplayed)
    }
  }

  const moveColumnDown = (index: number) => {
    if (index < displayedColumns.length - 1) {
      const newDisplayed = [...displayedColumns]
      const temp = newDisplayed[index]
      newDisplayed[index] = newDisplayed[index + 1]
      newDisplayed[index + 1] = temp
      setDisplayedColumns(newDisplayed)
    }
  }

  const saveColumnConfiguration = () => {
    if (typeof window !== 'undefined') {
      localStorage.setItem('courseTableColumns', JSON.stringify(displayedColumns))
    }
    setIsColumnSelectionOpen(false)
    setSelectedAvailableColumns([])
    setSelectedDisplayedColumns([])
  }

  const resetColumnConfiguration = () => {
    setDisplayedColumns(defaultDisplayedColumns)
    setSelectedAvailableColumns([])
    setSelectedDisplayedColumns([])
    if (typeof window !== 'undefined') {
      localStorage.removeItem('courseTableColumns')
    }
  }
  // Fetch student count from API
  useEffect(() => {
    fetch("/api/students")
      .then((res) => res.json())
      .then((data) => {
        if (data.count !== undefined) {
          setStudentCount(data.count);
        } else if (data.numStudents !== undefined) {
          setStudentCount(data.numStudents);
        }
      })
      .catch(() => setStudentCount(0));
  }, []);

  // Filter and sort courses with safety checks
  const filteredAndSortedCourses = useMemo(() => {
    if (!Array.isArray(courses)) {
      return [];
    }
    
    return courses.filter((course) => {
      const matchesSearch = course.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        course.instructor?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        course.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    (course.tags && Array.isArray(course.tags) && course.tags.some((tag: string) => tag.toLowerCase().includes(searchTerm.toLowerCase())))

      const matchesLevel = selectedFilters.level.length === 0 || selectedFilters.level.includes(course.level)
      const matchesType = selectedFilters.type.length === 0 || selectedFilters.type.includes(course.type)
      const matchesStatus = selectedFilters.status.length === 0 || selectedFilters.status.includes(course.status)

      const price = currency === "INR" ? (course.priceINR || 0) : (course.price || 0)
      const matchesPrice = price >= selectedFilters.priceRange[0] && price <= selectedFilters.priceRange[1]

      const matchesTab = activeTab === "all" || course.status?.toLowerCase() === activeTab.toLowerCase()

      return matchesSearch && matchesLevel && matchesType && matchesStatus && matchesPrice && matchesTab
    }).sort((a, b) => {
      const aValue = a[sortBy as keyof Course]
      const bValue = b[sortBy as keyof Course]

      if (typeof aValue === "string" && typeof bValue === "string") {
        if (sortOrder === "asc") {
          return aValue.localeCompare(bValue)
        } else {
          return bValue.localeCompare(aValue)
        }
      } else if (typeof aValue === "number" && typeof bValue === "number") {
        if (sortOrder === "asc") {
          return aValue - bValue
        } else {
          return bValue - aValue
        }
      }
      return 0
    })
  }, [courses, searchTerm, selectedFilters, activeTab, currency, sortBy, sortOrder])

  // Handlers
  const handleSaveDraft = async () => {
    // Save draft implementation
  }

  const handleBulkAction = (action: string, selectedCourseIds: string[]) => {
    // Bulk action implementation
  }

  const handleCourseClick = (course: Course) => {
    setSelectedCourse(course)
    setIsViewCourseDialogOpen(true)
  }

  const handleEditCourse = (course: Course) => {
    setIsEditMode(true);
    setEditCourseId(course.id);
    setNewCourseForm({
      id: course.id || '',
      name: course.name || '',
      instructor: course.instructor || '',
      description: course.description || '',
      level: course.level || 'Beginner',
      type: course.type || 'Online',
      duration: course.duration !== undefined ? String(course.duration) : '',
      priceINR: course.priceINR !== undefined ? String(course.priceINR) : '',
      schedule: course.schedule || '',
      maxStudents: course.maxStudents !== undefined ? String(course.maxStudents) : '',
      location: course.location || '',
      tags: Array.isArray(course.tags) ? course.tags : ['Beginner'],
      schedulePeriod: course.schedulePeriod || { startDate: '', endDate: '', totalWeeks: '18' },
      sessionDetails: course.sessionDetails || { sessionDuration: '', maxClasses: '18' },
      frequencyDetails: course.frequencyDetails || { selectedDays: [] as string[], dayTimes: {} as Record<string, any> },
      frequencies: course.frequencies || [] as { days: string[]; start: string; end: string; sessions: string }[],
      chapters: course.chapters || [{ name: '', description: '' }],
      referralCode: course.referralCode || '',
      commissionRate: course.commissionRate || '',
      referralStart: course.referralStart || '',
      referralEnd: course.referralEnd || '',
      referralStatus: course.referralStatus || 'Inactive',
      faqs: course.faqs || [{ question: '', answer: '', isEditing: false }],
      reminderSettings: course.reminderSettings
        ? {
            ...course.reminderSettings,
            frequency: course.reminderSettings.frequency ?? '',
            customDays: course.reminderSettings.customDays ?? '',
            customInterval: course.reminderSettings.customInterval ?? '',
          }
        : {
            pushEnabled: true,
            emailEnabled: true,
            smsEnabled: true,
            customSchedule: [] as {
              type: string;
              daysBefore: string;
              hoursBefore: string;
              timeOfDay: string;
              enabled: boolean;
              customType?: string;
            }[],
            frequency: '',
            customDays: '',
            customInterval: ''
          },
      freeGifts: course.freeGifts || [] as string[],
      status: course.status || 'Active',
      courseCategory: course.courseCategory || 'Regular',
    });
    setIsAddCourseDialogOpen(true);
  }

  const handleEditDraft = (draft: DraftType) => {
    setIsEditMode(true);
    setEditCourseId(draft.id);
    
    // Generate a new course ID for the draft conversion
    const nextCourseNumber = (Array.isArray(courses) ? courses.length : 0) + 1;
    const newCourseId = `COURSE${nextCourseNumber.toString().padStart(4, '0')}`;
    
    // Convert draft data to course form format
    setNewCourseForm({
      id: newCourseId, // Use new course ID instead of draft ID
      name: draft.name || '',
      instructor: draft.instructor || '',
      description: draft.description || '',
      level: draft.level || 'Beginner',
      type: draft.type || 'Online',
      duration: draft.duration !== undefined ? String(draft.duration) : '',
      priceINR: draft.priceINR !== undefined ? String(draft.priceINR) : '',
      schedule: draft.schedule || '',
      maxStudents: draft.maxStudents !== undefined ? String(draft.maxStudents) : '',
      location: draft.location || '',
      tags: Array.isArray(draft.tags) ? draft.tags : [],
      schedulePeriod: draft.schedulePeriod || { startDate: '', endDate: '', totalWeeks: '18' },
      sessionDetails: draft.sessionDetails || { sessionDuration: '', maxClasses: '18' },
      frequencyDetails: draft.frequencyDetails || { selectedDays: [], dayTimes: {} },
      frequencies: draft.frequencies || [],
      chapters: draft.chapters || [{ name: '', description: '' }],
      referralCode: draft.referralCode || '',
      commissionRate: draft.commissionRate || '',
      referralStart: draft.referralStart || '',
      referralEnd: draft.referralEnd || '',
      referralStatus: draft.referralStatus || 'Inactive',
      faqs: draft.faqs || [{ question: '', answer: '', isEditing: false }],
      reminderSettings: draft.reminderSettings || {
        pushEnabled: true,
        emailEnabled: true,
        smsEnabled: true,
        customSchedule: [],
        frequency: '',
        customDays: '',
        customInterval: ''
      },
      freeGifts: draft.freeGifts || [],
      status: draft.status || 'Draft',
      courseCategory: draft.courseCategory || 'Regular'
    });
    
    // Close drafts dialog and open course form dialog
    setIsDraftsDialogOpen(false);
    setIsAddCourseDialogOpen(true);
  }

  const handleDeleteDraft = async (draft: DraftType) => {
    try {
      const response = await fetch(`/api/drafts?id=${draft.id}`, {
        method: 'DELETE',
      });

      const data = await response.json();
      
      if (data.success) {
        // Remove the draft from state
        setDrafts(prevDrafts => prevDrafts.filter(d => d.id !== draft.id));
        toast({
          title: "Draft Deleted",
          description: `${draft.name} has been deleted successfully.`,
        });
      } else {
        throw new Error(data.error || 'Failed to delete draft');
      }
    } catch (error) {
      toast({
        title: "Error",
        description: error instanceof Error ? error.message : "Failed to delete draft",
        variant: "destructive",
      });
    }
  }

  const handleDeleteCourse = async (course: Course) => {
    // First, check if there are any cohorts associated with this course
    const associatedCohorts = cohorts.filter(cohort => 
      cohort.courseId === course.id || cohort.courseId === course.courseId
    );

    try {
      const response = await fetch('/api/courses', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          id: course.id,
          cascadeDelete: true // Flag to indicate cascade deletion
        }),
      });

      const data = await response.json();
      
      if (data.success) {
        // Remove the course from the state
        setCourses(prevCourses => prevCourses.filter(c => c.id !== course.id));
        
        // Remove all associated cohorts from the state
        if (associatedCohorts.length > 0) {
          setCohorts(prevCohorts => prevCohorts.filter(cohort => 
            cohort.courseId !== course.id && cohort.courseId !== course.courseId
          ));
        }
        
        const deletedCohortsCount = associatedCohorts.length;
        const message = deletedCohortsCount > 0 
          ? `${course.name} and ${deletedCohortsCount} associated cohort${deletedCohortsCount > 1 ? 's' : ''} have been deleted successfully.`
          : `${course.name} has been deleted successfully.`;
        
        toast({
          title: "Course Deleted",
          description: message,
        });
      } else {
        throw new Error(data.error || 'Failed to delete course');
      }
    } catch (error) {
      toast({
        title: "Error",
        description: error instanceof Error ? error.message : "Failed to delete course",
        variant: "destructive",
      });
    }
  };

  const showDeleteConfirmation = (title: string, message: string, onConfirm: () => void, itemName?: string, confirmButtonText?: string) => {
    setDeleteConfirmDialog({
      isOpen: true,
      title,
      message,
      onConfirm,
      itemName,
      confirmButtonText
    })
  }

  return (
    <MainLayout>
      <div className="container mx-auto p-2 space-y-4">
        {loading ? (
          <div className="flex items-center justify-center h-64">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p className="text-gray-600">Loading courses...</p>
            </div>
          </div>
        ) : (
          <>
            <HeroSection 
              onCreateCourse={() => setIsAddCourseDialogOpen(true)}
              onOpenDrafts={() => setIsDraftsDialogOpen(true)}
              onOpenMarketing={() => setIsMarketingDialogOpen(true)}
            />

            {/* Navigation Tabs */}
            <Tabs value={currentTab} onValueChange={setCurrentTab} className="w-full">
              <TabsList className="grid w-full grid-cols-3 mb-6 bg-transparent gap-2 p-0 h-auto">
                <TabsTrigger 
                  value="dashboard" 
                  className="flex items-center justify-center gap-2 px-4 py-2 border-2 border-transparent bg-purple-500 text-white font-medium data-[state=active]:bg-purple-500 data-[state=active]:text-white data-[state=inactive]:bg-transparent data-[state=inactive]:border-orange-400 data-[state=inactive]:text-orange-600 hover:bg-purple-600 data-[state=inactive]:hover:bg-orange-50"
                >
                  <LayoutDashboard className="h-4 w-4" />
                  Dashboard
                </TabsTrigger>
                <TabsTrigger 
                  value="courses" 
                  className="flex items-center justify-center gap-2 px-4 py-2 border-2 border-orange-400 bg-transparent text-orange-600 font-medium data-[state=active]:bg-purple-500 data-[state=active]:text-white data-[state=active]:border-transparent data-[state=inactive]:bg-transparent data-[state=inactive]:border-orange-400 data-[state=inactive]:text-orange-600 hover:bg-orange-50 data-[state=active]:hover:bg-purple-600"
                >
                  <BookOpen className="h-4 w-4" />
                  Courses
                </TabsTrigger>
                <TabsTrigger 
                  value="cohorts" 
                  className="flex items-center justify-center gap-2 px-4 py-2 border-2 border-orange-400 bg-transparent text-orange-600 font-medium data-[state=active]:bg-purple-500 data-[state=active]:text-white data-[state=active]:border-transparent data-[state=inactive]:bg-transparent data-[state=inactive]:border-orange-400 data-[state=inactive]:text-orange-600 hover:bg-orange-50 data-[state=active]:hover:bg-purple-600"
                >
                  <Users className="h-4 w-4" />
                  Cohorts
                </TabsTrigger>
              </TabsList>

              {/* Dashboard Tab Content */}
              <TabsContent value="dashboard" className="space-y-6">
                {/* Statistics Cards */}
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-500">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-green-600">Active Courses</p>
                      <p className="text-2xl font-bold text-green-900">{Array.isArray(courses) ? courses.filter(c => c.status === "Active").length : 0}</p>
                    </div>
                    <Check className="h-8 w-8 text-green-500" />
                  </div>
                </CardContent>
              </Card>
              <Card className="bg-gradient-to-br from-purple-50 to-purple-100 border-purple-500">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-purple-600">Total Cohorts</p>
                      <p className="text-2xl font-bold text-purple-900">{Array.isArray(cohorts) ? cohorts.length : 0}</p>
                    </div>
                    <Users className="h-8 w-8 text-purple-500" />
                  </div>
                </CardContent>
              </Card>
              <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-500">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-blue-600">Total Students</p>
                      <p className="text-2xl font-bold text-blue-900">{studentCount !== null ? studentCount : '-'}</p>
                    </div>
                    <Users className="h-8 w-8 text-blue-500" />
                  </div>
                </CardContent>
              </Card>
              <Card className="bg-gradient-to-br from-orange-50 to-orange-100 border-orange-500">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-orange-600">Revenue (INR)</p>
                      <p className="text-2xl font-bold text-orange-900">{Array.isArray(courses) ? courses.reduce((sum, c) => sum + (currency === "INR" ? (c.priceINR || 0) : (c.price || 0)) * (c.enrolledStudents || 0), 0) : 0}</p>
                    </div>
                    <DollarSign className="h-8 w-8 text-orange-500" />
                  </div>
                </CardContent>
              </Card>
            </div>

                {/* Charts Section */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Course Status Distribution */}
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2">
                        <BarChart3 className="h-5 w-5" />
                        Course Status Distribution
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <ChartContainer config={chartConfig} className="h-[200px]">
                        <PieChart>
                          <Pie
                            data={courseStatusData}
                            cx="50%"
                            cy="50%"
                            innerRadius={40}
                            outerRadius={80}
                            dataKey="value"
                          >
                            {courseStatusData.map((entry, index) => (
                              <Cell key={`cell-${index}`} fill={entry.color} />
                            ))}
                          </Pie>
                          <Tooltip content={<ChartTooltipContent />} />
                        </PieChart>
                      </ChartContainer>
                      <div className="flex justify-center gap-4 mt-4">
                        {courseStatusData.map((item) => (
                          <div key={item.name} className="flex items-center gap-2">
                            <div
                              className="w-3 h-3 rounded-full"
                              style={{ backgroundColor: item.color }}
                            />
                            <span className="text-sm text-muted-foreground">
                              {item.name}: {item.value}
                            </span>
                          </div>
                        ))}
                      </div>
                    </CardContent>
                  </Card>

                  {/* Enrollment by Course Type */}
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2">
                        <Users className="h-5 w-5" />
                        Enrollment by Course Type
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <ChartContainer config={chartConfig} className="h-[200px]">
                        <BarChart data={courseTypeData}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="type" />
                          <YAxis />
                          <Tooltip content={<ChartTooltipContent />} />
                          <Bar dataKey="students" fill="#3b82f6" />
                        </BarChart>
                      </ChartContainer>
                    </CardContent>
                  </Card>

                  {/* Course Categories */}
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2">
                        <BookOpen className="h-5 w-5" />
                        Course Categories
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <ChartContainer config={chartConfig} className="h-[200px]">
                        <PieChart>
                          <Pie
                            data={categoryData}
                            cx="50%"
                            cy="50%"
                            innerRadius={40}
                            outerRadius={80}
                            dataKey="count"
                          >
                            {categoryData.map((entry, index) => (
                              <Cell key={`cell-${index}`} fill={entry.fill} />
                            ))}
                          </Pie>
                          <Tooltip content={<ChartTooltipContent />} />
                        </PieChart>
                      </ChartContainer>
                      <div className="flex justify-center gap-4 mt-4">
                        {categoryData.map((item) => (
                          <div key={item.category} className="flex items-center gap-2">
                            <div
                              className="w-3 h-3 rounded-full"
                              style={{ backgroundColor: item.fill }}
                            />
                            <span className="text-sm text-muted-foreground">
                              {item.category}: {item.count}
                            </span>
                          </div>
                        ))}
                      </div>
                    </CardContent>
                  </Card>

                  {/* Revenue Trend */}
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2">
                        <DollarSign className="h-5 w-5" />
                        Revenue Trend (6 Months)
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <ChartContainer config={chartConfig} className="h-[200px]">
                        <AreaChart data={revenueTrendData}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="month" />
                          <YAxis />
                          <Tooltip content={<ChartTooltipContent />} />
                          <Area
                            type="monotone"
                            dataKey="revenue"
                            stroke="#8b5cf6"
                            fill="#8b5cf6"
                            fillOpacity={0.3}
                          />
                        </AreaChart>
                      </ChartContainer>
                    </CardContent>
                  </Card>
                </div>

                {/* Feature Cards */}
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-4">
          

          <Card className="hover:shadow-md transition-shadow cursor-pointer">
            <CardContent className="p-4 text-center">
              <Bot className="h-8 w-8 text-yellow-600 mx-auto mb-2" />
              <h3 className="font-medium text-sm">AI Assistant <span title="Coming Soon"> ðŸ”œ</span></h3>
              <p className="text-xs text-gray-500">Smart scheduling</p>
            </CardContent>
          </Card>

          <Card className="hover:shadow-md transition-shadow cursor-pointer">
            <CardContent className="p-4 text-center">
              <Target className="h-8 w-8 text-green-600 mx-auto mb-2" />
              <h3 className="font-medium text-sm">Gamification <span title="Coming Soon"> ðŸ”œ</span></h3>
              <p className="text-xs text-gray-500">Badges & rewards</p>
            </CardContent>
          </Card>


  


<Card className="hover:shadow-md transition-shadow cursor-pointer">
  <CardContent className="p-4 text-center">
    <ClipboardCheck className="h-8 w-8 text-pink-600 mx-auto mb-2" />
    <h3 className="font-medium text-sm">Assignments <span title="Coming Soon"> ðŸ”œ</span></h3>
    <p className="text-xs text-gray-500">Auto grading</p>
  </CardContent>
</Card>


<Card className="hover:shadow-md transition-shadow cursor-pointer">
  <CardContent className="p-4 text-center">
    <Timer className="h-8 w-8 text-blue-600 mx-auto mb-2" />
    <h3 className="font-medium text-sm">Time Tracker <span title="Coming Soon"> ðŸ”œ</span></h3>
    <p className="text-xs text-gray-500">Study duration</p>
  </CardContent>
</Card>

          
                </div>
              </TabsContent>

              {/* Courses Tab Content */}
              <TabsContent value="courses" className="space-y-4">
                <Card>
                  <CardContent className="p-6">
                    <SearchAndFilters 
                      searchTerm={searchTerm}
                      setSearchTerm={setSearchTerm}
                      sortBy={sortBy}
                      setSortBy={setSortBy}
                      sortOrder={sortOrder}
                      setSortOrder={setSortOrder}
                      viewMode={viewMode}
                      setViewMode={setViewMode}
                      selectedFilters={selectedFilters}
                      setSelectedFilters={setSelectedFilters}
                      pendingFilters={pendingFilters}
                      setPendingFilters={setPendingFilters}
                      courses={courses}
                      setCourses={setCourses}
                      filteredCourses={filteredAndSortedCourses}
                      courseTypeOptions={['Offline', 'Online', 'Hybrid']}
                      onCreateCourse={() => {
                        setIsEditMode(false);
                        setEditCourseId(null);
                        setIsAddCourseDialogOpen(true);
                      }}
                      onOpenDrafts={() => setIsDraftsDialogOpen(true)}
                    />
                    
                    {/* Results Counter */}
                    <div className="flex flex-wrap items-center justify-between gap-4 mb-4 p-3 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border border-purple-200">
                      <div className="flex items-center gap-2">
                        <div className="w-2 h-2 bg-purple-500 rounded-full"></div>
                        <span className="text-sm font-medium text-purple-700">
                          {filteredAndSortedCourses.length} course{filteredAndSortedCourses.length !== 1 ? 's' : ''} found
                        </span>
                      </div>
                      
                      {/* Column Selection Button */}
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setIsColumnSelectionOpen(true)}
                        className="flex items-center gap-2 h-8 px-3 border-purple-300 hover:bg-purple-100"
                        title="Column Selection"
                      >
                        <Grid3X3 className="h-4 w-4 text-purple-600" />
                        <span className="text-xs text-purple-700">Columns</span>
                      </Button>
                    </div>
                    
                    <div className="overflow-x-auto">
                      <CourseList 
                        courses={filteredAndSortedCourses}
                        viewMode={viewMode}
                        onCourseClick={handleCourseClick}
                        onEditCourse={handleEditCourse}
                        onDeleteCourse={handleDeleteCourse}
                        cohorts={cohorts}
                        displayedColumns={displayedColumns}
                      />
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>

              {/* Cohorts Tab Content */}
              <TabsContent value="cohorts" className="space-y-4">
                <CohortManagement 
                  courses={courses}
                  cohorts={cohorts}
                  setCohorts={setCohorts}
                  showDeleteConfirmation={showDeleteConfirmation}
                />
              </TabsContent>

            </Tabs>

        {/* Global dialogs (mounted outside tabs for instant open) */}
        <DraftsDialog 
          isOpen={isDraftsDialogOpen}
          onOpenChange={setIsDraftsDialogOpen}
          drafts={drafts}
          onEditDraft={handleEditDraft}
          onDeleteDraft={handleDeleteDraft}
          onRefreshDrafts={refetchDrafts}
        />

        <ConfirmationDialog 
          isOpen={deleteConfirmDialog.isOpen}
          title={deleteConfirmDialog.title}
          message={deleteConfirmDialog.message}
          itemName={deleteConfirmDialog.itemName}
          onConfirm={deleteConfirmDialog.onConfirm}
          onCancel={() => setDeleteConfirmDialog(prev => ({ ...prev, isOpen: false }))}
          confirmButtonText={deleteConfirmDialog.confirmButtonText}
        />

        <AddCourseDialog 
          isOpen={isAddCourseDialogOpen}
          onOpenChange={(open) => {
            setIsAddCourseDialogOpen(open);
            if (!open) {
              setIsEditMode(false);
              setEditCourseId(null);
            }
          }}
          isEditMode={isEditMode}
          editCourseId={editCourseId}
          courses={courses}
          setCourses={setCourses}
          newCourseForm={{
            ...newCourseForm,
            id: newCourseForm.id || uuidv4()
          }}
          setNewCourseForm={setNewCourseForm}
          showDeleteConfirmation={showDeleteConfirmation}
        />

        {/* Additional Dialog Components */}
        <Dialog open={isViewCourseDialogOpen} onOpenChange={setIsViewCourseDialogOpen}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle className="text-xl font-bold">Course Details</DialogTitle>
            </DialogHeader>
            {selectedCourse && (
              <div className="space-y-4">
                <div className="border-b pb-3">
                  <h3 className="font-semibold text-lg">{selectedCourse.name}</h3>
                  <p className="text-gray-600">{selectedCourse.instructor}</p>
                  <p className="text-sm text-gray-500 mt-1">{selectedCourse.description}</p>
                </div>

                <div className="grid grid-cols-2 gap-x-6 gap-y-1">
                  <div>
                    <h4 className="font-semibold mb-2">Course Settings</h4>
                    <dl className="grid grid-cols-[100px_1fr] gap-y-1 text-sm">
                      <dt className="text-gray-500">Level:</dt>
                      <dd>{selectedCourse.level}</dd>
                      <dt className="text-gray-500">Type:</dt>
                      <dd className="capitalize">{selectedCourse.type?.toLowerCase()}</dd>
                      <dt className="text-gray-500">Duration:</dt>
                      <dd>{selectedCourse.duration}</dd>
                      <dt className="text-gray-500">Location:</dt>
                      <dd>{selectedCourse.location}</dd>
                    </dl>
                  </div>
                  
                  <div>
                    <h4 className="font-semibold mb-2">Capacity & Pricing</h4>
                    <dl className="grid grid-cols-[120px_1fr] gap-y-1 text-sm">
                      <dt className="text-gray-500">Price:</dt>
                      <dd className="text-green-600 font-semibold">INR {selectedCourse.priceINR?.toLocaleString()}</dd>
                      <dt className="text-gray-500">Max Students:</dt>
                      <dd>{selectedCourse.maxStudents}</dd>
                    </dl>
                  </div>
                </div>

                <div className="border-t pt-3">
                  <h4 className="font-semibold mb-2">Schedule</h4>
                  <div className="grid grid-cols-2 gap-x-6 text-sm">
                    <div>
                      <span className="text-gray-500">Period:</span>
                      <div className="mt-1">
                        {selectedCourse.schedulePeriod?.startDate && selectedCourse.schedulePeriod?.endDate ? (
                          <div className="space-y-0.5">
                            <div>Start: {selectedCourse.schedulePeriod.startDate}</div>
                            <div>End: {selectedCourse.schedulePeriod.endDate}</div>
                          </div>
                        ) : (
                          <span className="text-gray-400">Not set</span>
                        )}
                      </div>
                    </div>
                    <div>
                      <span className="text-gray-500">Total Weeks:</span>
                      <div className="mt-1">
                        {selectedCourse.schedulePeriod?.totalWeeks || <span className="text-gray-400">Not set</span>}
                      </div>
                    </div>
                  </div>
                </div>

                {selectedCourse.tags && selectedCourse.tags.length > 0 && (
                  <div className="border-t pt-3">
                    <h4 className="font-semibold mb-2">Tags</h4>
                    <div className="flex flex-wrap gap-1.5">
                      {selectedCourse.tags.map((tag, index) => (
                        <span key={index} className="px-2 py-0.5 bg-gray-100 text-gray-700 text-xs rounded">
                          {tag}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
          </DialogContent>
        </Dialog>

        <Dialog open={isMarketingDialogOpen} onOpenChange={setIsMarketingDialogOpen}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle>Marketing Tools ðŸ”œ</DialogTitle>
            </DialogHeader>
            <div className="p-8 text-center text-gray-500">
              <Megaphone className="h-16 w-16 mx-auto mb-4 text-gray-400" />
              <p>Marketing tools and promotional features coming soon!</p>
            </div>
          </DialogContent>
        </Dialog>

        <Dialog open={isAnalyticsDialogOpen} onOpenChange={setIsAnalyticsDialogOpen}>
          <DialogContent className="max-w-4xl">
            <DialogHeader>
              <DialogTitle>Analytics Dashboard</DialogTitle>
            </DialogHeader>
            <div className="p-8 text-center text-gray-500">
              <BarChart3 className="h-16 w-16 mx-auto mb-4 text-gray-400" />
              <p>Advanced analytics and reporting features would be implemented here.</p>
            </div>
          </DialogContent>
        </Dialog>

        <Dialog open={isFinancialDialogOpen} onOpenChange={setIsFinancialDialogOpen}>
          <DialogContent className="max-w-4xl">
            <DialogHeader>
              <DialogTitle>Financial Management</DialogTitle>
            </DialogHeader>
            <div className="p-8 text-center text-gray-500">
              <DollarSign className="h-16 w-16 mx-auto mb-4 text-gray-400" />
              <p>Financial tracking and revenue management features would be implemented here.</p>
            </div>
          </DialogContent>
        </Dialog>

        {/* Column Selection Dialog */}
        <Dialog open={isColumnSelectionOpen} onOpenChange={setIsColumnSelectionOpen}>
          <DialogContent className="max-w-4xl max-h-[80vh] overflow-hidden">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <Grid3X3 className="h-5 w-5" />
                Column Selection
              </DialogTitle>
            </DialogHeader>
            
            <div className="flex gap-4 h-96">
              {/* Available Columns */}
              <div className="flex-1 border rounded-lg p-4">
                <h3 className="font-medium text-sm mb-3 text-gray-700">Available Columns</h3>
                <div className="border rounded h-64 overflow-y-auto bg-gray-50 p-2">
                  {availableColumns.length === 0 ? (
                    <div className="text-center text-gray-500 text-sm py-8">
                      All columns are displayed
                    </div>
                  ) : (
                    availableColumns.map(col => (
                      <div 
                        key={col.id}
                        className={`p-2 cursor-pointer hover:bg-blue-50 rounded text-sm border mb-1 ${
                          selectedAvailableColumns.includes(col.id) 
                            ? 'bg-blue-100 border-blue-300' 
                            : 'bg-white border-gray-200'
                        }`}
                        onClick={() => {
                          setSelectedAvailableColumns(prev => 
                            prev.includes(col.id) 
                              ? prev.filter(id => id !== col.id)
                              : [...prev, col.id]
                          )
                        }}
                      >
                        {col.label}
                      </div>
                    ))
                  )}
                </div>
              </div>

              {/* Transfer Controls */}
              <div className="flex flex-col justify-center gap-2">
                <Button
                  size="sm"
                  variant="outline"
                  onClick={moveColumnsToDisplayed}
                  disabled={selectedAvailableColumns.length === 0}
                  className="px-2"
                  title="Move selected to displayed"
                >
                  <ChevronRight className="h-4 w-4" />
                </Button>
                <Button
                  size="sm"
                  variant="outline"
                  onClick={moveColumnsToAvailable}
                  disabled={selectedDisplayedColumns.length === 0}
                  className="px-2"
                  title="Move selected to available"
                >
                  <ChevronLeft className="h-4 w-4" />
                </Button>
              </div>

              {/* Displayed Columns */}
              <div className="flex-1 border rounded-lg p-4">
                <h3 className="font-medium text-sm mb-3 text-gray-700">Displayed Columns</h3>
                <div className="border rounded h-64 overflow-y-auto bg-gray-50 p-2">
                  {displayedColumns.length === 0 ? (
                    <div className="text-center text-gray-500 text-sm py-8">
                      No columns selected
                    </div>
                  ) : (
                    displayedColumns.map((colId, index) => {
                      const col = allColumns.find(c => c.id === colId)
                      return (
                        <div 
                          key={colId}
                          className={`flex items-center justify-between p-2 cursor-pointer hover:bg-blue-50 rounded text-sm border mb-1 ${
                            selectedDisplayedColumns.includes(colId) 
                              ? 'bg-blue-100 border-blue-300' 
                              : 'bg-white border-gray-200'
                          }`}
                          onClick={() => {
                            setSelectedDisplayedColumns(prev => 
                              prev.includes(colId) 
                                ? prev.filter(id => id !== colId)
                                : [...prev, colId]
                            )
                          }}
                        >
                          <span>{col?.label || colId}</span>
                          <div className="flex gap-1">
                            <Button
                              size="sm"
                              variant="ghost"
                              onClick={(e) => {
                                e.stopPropagation()
                                moveColumnUp(index)
                              }}
                              disabled={index === 0}
                              className="p-1 h-6 w-6"
                              title="Move up"
                            >
                              <ChevronUp className="h-3 w-3" />
                            </Button>
                            <Button
                              size="sm"
                              variant="ghost"
                              onClick={(e) => {
                                e.stopPropagation()
                                moveColumnDown(index)
                              }}
                              disabled={index === displayedColumns.length - 1}
                              className="p-1 h-6 w-6"
                              title="Move down"
                            >
                              <ChevronDown className="h-3 w-3" />
                            </Button>
                          </div>
                        </div>
                      )
                    })
                  )}
                </div>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex justify-between pt-4 border-t">
              <Button
                variant="outline"
                onClick={resetColumnConfiguration}
                className="flex items-center gap-2"
              >
                <RotateCcw className="h-4 w-4" />
                Reset to Default
              </Button>
              <div className="flex gap-2">
                <Button
                  variant="outline"
                  onClick={() => setIsColumnSelectionOpen(false)}
                >
                  Cancel
                </Button>
                <Button
                  onClick={saveColumnConfiguration}
                  className="bg-purple-600 hover:bg-purple-700"
                >
                  Save & Apply
                </Button>
              </div>
            </div>
          </DialogContent>
        </Dialog>

          </>
        )}
      </div>
    </MainLayout>
  )
}