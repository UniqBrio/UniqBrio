"use client"

import { useState, useEffect, useMemo } from "react"
import { v4 as uuidv4 } from 'uuid';
import MainLayout from "@/components/main-layout"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Checkbox } from "@/components/ui/checkbox"
import { toast } from "@/hooks/use-toast"
import { ToastAction } from "@/components/ui/toast"
import { Badge } from "@/components/ui/badge"
import { Progress } from "@/components/ui/progress"
import { Separator } from "@/components/ui/separator"
import { Switch } from "@/components/ui/switch"
import { Textarea } from "@/components/ui/textarea"
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip"
import {
  Search,
  Plus,
  BookOpen,
  Download,
  Upload,
  MessageSquare,
  Video,
  Filter,
  ArrowUpDown,
  Trophy,
  DollarSign,
  Calendar,
  Users,
  Star,
  Clock,
  Globe,
  Shield,
  Zap,
  TrendingUp,
  Bell,
  CreditCard,
  Smartphone,
  Headphones,
  FileText,
  Eye,
  Settings,
  Trash2,
  BarChart3,
  Target,
  Lightbulb,
  Share2,
  Gift,
  Briefcase,
  GraduationCap,
  Megaphone,
  CalendarIcon,
  IndianRupee,
  AlertCircle,
  CheckCircle,
  WifiOff,
  MapPin,
  Mail,
  MessageCircle,
  Shirt,
  Utensils,
  Banknote,
  Pencil,
  Save,
  X,
  Check
} from "lucide-react"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
  DropdownMenuCheckboxItem,
  DropdownMenuLabel,
} from "@/components/ui/dropdown-menu"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import CourseCard from "@/components/course-card"
import type { Course } from "@/types/course"

// Import decomposed components
import CourseManagementHeader from "@/components/courses/course-management-header"
import CourseStatsCard from "@/components/courses/course-stats-card"
import CourseFiltersAndSearch from "@/components/courses/course-filters-and-search"
import BasicInfoTab from "@/components/courses/course-form-tabs/basic-info-tab"
import ChaptersTab from "@/components/courses/course-form-tabs/chapters-tab"
import PricingTab from "@/components/courses/course-form-tabs/pricing-tab"
import ScheduleTab from "@/components/courses/course-form-tabs/schedule-tab"
import ContentTab from "@/components/courses/course-form-tabs/content-tab"
import SettingsTab from "@/components/courses/course-form-tabs/settings-tab"
import MarketingTab from "@/components/courses/course-form-tabs/marketing-tab"

// Type definitions
type DraftType = {
  id: string;
  name: string;
  updatedAt: number;
  [key: string]: any;
};

// Local Cohort type for state
interface Cohort {
  id: string;
  name: string;
  courseId: string;
  notes: string;
  startTime?: string;
  endTime?: string;
  capacity: number;
  members: string[];
}

// Enhanced sample data with all new features
const sampleCourses: Course[] = [
  {
    id: "CRS001",
    name: "Advanced Painting Techniques",
    instructor: "Jane Smith",
    instructorId: "INST001",
    description: "Learn advanced painting techniques from professional artists with personalized coaching and industry insights.",
    level: "Advanced",
    type: "Offline",
    duration: "12 weeks",
    priceINR: 24999,
    price: 300,
    currency: "INR",
    schedule: "Mon, Wed 4:00 PM - 6:00 PM",
    maxStudents: 20,
    enrolledStudents: 12,
    location: "Studio A",
    tags: ["Art", "Painting", "Advanced", "Professional"],
    modules: [],
    completionRate: 85,
    schedulePeriod: { startDate: "2024-01-01", endDate: "2024-03-31", totalWeeks: "12" },
    sessionDetails: { sessionDuration: "2", maxClasses: "2" },
    frequencyDetails: { selectedDays: ["Monday", "Wednesday"], dayTimes: {} },
    frequencies: [{ days: ["Monday", "Wednesday"], start: "16:00", end: "18:00", sessions: "1" }],
    chapters: [{ name: "Oil Painting Fundamentals", description: "Master the basics of oil painting with hands-on practice." }],
    referralCode: "ART2024",
    commissionRate: "10",
    referralStart: "2024-01-01",
    referralEnd: "2024-03-31",
    referralStatus: "Active",
    affiliateTracking: {
      enabled: true,
      referralCode: "ART2024",
      commissionRate: 10,
      totalReferrals: 5,
      totalCommission: 500,
    },
    emiPlans: [
      {
        id: "EMI001",
        name: "Standard EMI",
        installments: 3,
        interestRate: 8.5,
        processingFee: 500,
        eligibilityCriteria: ["Valid ID", "Minimum age 18"],
        isActive: true,
      },
    ],
    scholarships: [
      {
        id: "SCH001",
        name: "Merit Scholarship",
        amount: 2000,
        percentage: 10,
        criteria: ["Top 10% in entrance test"],
        status: "Active",
        applicants: ["STU001", "STU002"],
        recipients: ["STU001"],
      },
    ],
    taxInfo: {
      gstEnabled: true,
      gstRate: 18,
      educationTaxRate: 0,
      pan: "ABCDE1234F",
      autoGeneration: true,
      invoicePrefix: "INV2025",
      lastInvoiceNumber: 1001,
      taxDocuments: [
        {
          id: "DOC001",
          name: "Invoice Jan 2025",
          url: "https://example.com/invoice-jan-2025.pdf",
          date: "2025-01-31",
          type: "Invoice",
          documentUrl: "https://example.com/invoice-jan-2025.pdf",
          generatedAt: new Date("2025-01-31"),
        },
        {
          id: "DOC002",
          name: "Invoice Feb 2025",
          url: "https://example.com/invoice-feb-2025.pdf",
          date: "2025-02-28",
          type: "Invoice",
          documentUrl: "https://example.com/invoice-feb-2025.pdf",
          generatedAt: new Date("2025-02-28"),
        },
      ],
    },
    faqs: [
      {
        question: "What materials are provided?",
        answer: "We provide canvases, paints, easels, and basic brushes. You may bring your own brushes if preferred.",
        isEditing: false
      },
      {
        question: "Can I make up missed classes?",
        answer: "Yes, we offer makeup sessions on Saturdays. Please inform us 24 hours in advance.",
        isEditing: false
      },
    ],
    reminderSettings: {
      pushEnabled: true,
      emailEnabled: true,
      smsEnabled: true,
      customSchedule: [],
      frequency: "weekly",
      customDays: "",
      customInterval: ""
    },
    freeGifts: ["Apron", "Notebook"],
    status: "Active",
    courseCategory: "Regular",
    rating: 4.7,
    cohortAnalysis: [],
    learningBehavior: {
      bestLearningTimes: [],
      engagementWindows: [],
      preferredContentTypes: [],
      averageSessionDuration: 0,
      peakActivityDays: []
    },
    roiCalculator: {
      courseCost: 0,
      expectedSalaryIncrease: 0,
      timeToROI: 0,
      industryAverageSalary: 0,
      skillDemandScore: 0
    },
    dropoffPrediction: {
      riskScore: 0,
      riskFactors: [],
      interventionSuggestions: []
    },
    sharedResources: [],
    versionControl: [],
    materialAnalytics: {
      resourceId: "MAT001",
      views: 0,
      downloads: 0,
      averageRating: 0,
      successRate: 0,
      engagementTime: 0,
    },
    credentialVerification: false,
    marketplaceEnabled: false,
    ltiIntegration: false,
    contentSecurity: {
      watermarkEnabled: false,
      downloadProtection: false,
      screenRecordingProtection: false,
      accessLogging: false,
      licenseTracking: false,
    },
    offlineAccess: {
      enabled: false,
      downloadLimit: 0,
      currentDownloads: 0,
      expiryDays: 0,
      accessLogs: [],
    },
    industryPartners: [],
    events: [],
    alumniNetwork: [],
    promotionTemplates: [],
    seasonalPromos: [],
    growthAnalytics: {
      enrollmentTrend: [],
      revenueTrend: [],
      completionTrend: [],
      satisfactionTrend: [],
    },
  },
  // Mock Course 2
  {
    id: "CRS002",
    name: "Digital Illustration Basics",
    instructor: "John Doe",
    instructorId: "INST002",
    description: "Learn the basics of digital illustration using tablets and software.",
    level: "Beginner",
    type: "Online",
    duration: "8 weeks",
    priceINR: 12000,
    price: 150,
    currency: "INR",
    schedule: "Tue, Thu 6:00 PM - 7:30 PM",
    maxStudents: 25,
    enrolledStudents: 18,
    location: "Online",
    tags: ["Art", "Digital", "Beginner"],
    modules: [],
    completionRate: 90,
    schedulePeriod: { startDate: "2024-02-01", endDate: "2024-03-31", totalWeeks: "8" },
    sessionDetails: { sessionDuration: "1.5", maxClasses: "2" },
    frequencyDetails: { selectedDays: ["Tuesday", "Thursday"], dayTimes: {} },
    frequencies: [{ days: ["Tuesday", "Thursday"], start: "18:00", end: "19:30", sessions: "1" }],
    chapters: [{ name: "Tablet Setup", description: "Introduction to digital drawing tools." }],
    referralCode: "DIGI2024",
    commissionRate: "8",
    referralStart: "2024-02-01",
    referralEnd: "2024-03-31",
    referralStatus: "Active",
    affiliateTracking: {
      enabled: true,
      referralCode: "DIGI2024",
      commissionRate: 8,
      totalReferrals: 3,
      totalCommission: 200,
    },
    emiPlans: [],
    scholarships: [],
    taxInfo: {
      gstEnabled: true,
      gstRate: 18,
      educationTaxRate: 0,
      pan: "ABCDE5678G",
      autoGeneration: true,
      invoicePrefix: "INV2026",
      lastInvoiceNumber: 1002,
      taxDocuments: [],
    },
    faqs: [],
    reminderSettings: {
      pushEnabled: true,
      emailEnabled: true,
      smsEnabled: true,
      customSchedule: [],
      frequency: "weekly",
      customDays: "",
      customInterval: ""
    },
    freeGifts: ["Pen", "Notebook"],
    status: "Active",
    courseCategory: "Regular",
    rating: 4.5,
    cohortAnalysis: [],
    learningBehavior: {
      bestLearningTimes: [],
      engagementWindows: [],
      preferredContentTypes: [],
      averageSessionDuration: 0,
      peakActivityDays: []
    },
    roiCalculator: {
      courseCost: 0,
      expectedSalaryIncrease: 0,
      timeToROI: 0,
      industryAverageSalary: 0,
      skillDemandScore: 0
    },
    dropoffPrediction: {
      riskScore: 0,
      riskFactors: [],
      interventionSuggestions: []
    },
    sharedResources: [],
    versionControl: [],
    materialAnalytics: {
      resourceId: "MAT002",
      views: 0,
      downloads: 0,
      averageRating: 0,
      successRate: 0,
      engagementTime: 0,
    },
    credentialVerification: false,
    marketplaceEnabled: false,
    ltiIntegration: false,
    contentSecurity: {
      watermarkEnabled: false,
      downloadProtection: false,
      screenRecordingProtection: false,
      accessLogging: false,
      licenseTracking: false,
    },
    offlineAccess: {
      enabled: false,
      downloadLimit: 0,
      currentDownloads: 0,
      expiryDays: 0,
      accessLogs: [],
    },
    industryPartners: [],
    events: [],
    alumniNetwork: [],
    promotionTemplates: [],
    seasonalPromos: [],
    growthAnalytics: {
      enrollmentTrend: [],
      revenueTrend: [],
      completionTrend: [],
      satisfactionTrend: [],
    },
  },
  // Mock Course 3
  {
    id: "CRS003",
    name: "Sculpture Workshop",
    instructor: "Priya Patel",
    instructorId: "INST003",
    description: "Hands-on workshop for clay and stone sculpture.",
    level: "Intermediate",
    type: "Offline",
    duration: "10 weeks",
    priceINR: 18000,
    price: 220,
    currency: "INR",
    schedule: "Sat 10:00 AM - 1:00 PM",
    maxStudents: 15,
    enrolledStudents: 10,
    location: "Studio B",
    tags: ["Art", "Sculpture", "Intermediate"],
    modules: [],
    completionRate: 80,
    schedulePeriod: { startDate: "2024-03-01", endDate: "2024-05-10", totalWeeks: "10" },
    sessionDetails: { sessionDuration: "3", maxClasses: "2" },
    frequencyDetails: { selectedDays: ["Saturday"], dayTimes: {} },
    frequencies: [{ days: ["Saturday"], start: "10:00", end: "13:00", sessions: "1" }],
    chapters: [{ name: "Clay Basics", description: "Introduction to clay modeling." }],
    referralCode: "SCULPT2024",
    commissionRate: "12",
    referralStart: "2024-03-01",
    referralEnd: "2024-05-10",
    referralStatus: "Active",
    affiliateTracking: {
      enabled: true,
      referralCode: "SCULPT2024",
      commissionRate: 12,
      totalReferrals: 2,
      totalCommission: 150,
    },
    emiPlans: [],
    scholarships: [],
    taxInfo: {
      gstEnabled: true,
      gstRate: 18,
      educationTaxRate: 0,
      pan: "ABCDE9999Z",
      autoGeneration: true,
      invoicePrefix: "INV2027",
      lastInvoiceNumber: 1003,
      taxDocuments: [],
    },
    faqs: [],
    reminderSettings: {
      pushEnabled: true,
      emailEnabled: true,
      smsEnabled: true,
      customSchedule: [],
      frequency: "weekly",
      customDays: "",
      customInterval: ""
    },
    freeGifts: ["Badge", "Keychain"],
    status: "Active",
    courseCategory: "Regular",
    rating: 4.6,
    cohortAnalysis: [],
    learningBehavior: {
      bestLearningTimes: [],
      engagementWindows: [],
      preferredContentTypes: [],
      averageSessionDuration: 0,
      peakActivityDays: []
    },
    roiCalculator: {
      courseCost: 0,
      expectedSalaryIncrease: 0,
      timeToROI: 0,
      industryAverageSalary: 0,
      skillDemandScore: 0
    },
    dropoffPrediction: {
      riskScore: 0,
      riskFactors: [],
      interventionSuggestions: []
    },
    sharedResources: [],
    versionControl: [],
    materialAnalytics: {
      resourceId: "MAT003",
      views: 0,
      downloads: 0,
      averageRating: 0,
      successRate: 0,
      engagementTime: 0,
    },
    credentialVerification: false,
    marketplaceEnabled: false,
    ltiIntegration: false,
    contentSecurity: {
      watermarkEnabled: false,
      downloadProtection: false,
      screenRecordingProtection: false,
      accessLogging: false,
      licenseTracking: false,
    },
    offlineAccess: {
      enabled: false,
      downloadLimit: 0,
      currentDownloads: 0,
      expiryDays: 0,
      accessLogs: [],
    },
    industryPartners: [],
    events: [],
    alumniNetwork: [],
    promotionTemplates: [],
    seasonalPromos: [],
    growthAnalytics: {
      enrollmentTrend: [],
      revenueTrend: [],
      completionTrend: [],
      satisfactionTrend: [],
    },
  },
  // Mock Course 4
  {
    id: "CRS004",
    name: "Portfolio Building",
    instructor: "Jane Smith",
    instructorId: "INST001",
    description: "Build your professional art portfolio with expert guidance.",
    level: "Advanced",
    type: "Hybrid",
    duration: "6 weeks",
    priceINR: 22000,
    price: 270,
    currency: "INR",
    schedule: "Fri 5:00 PM - 7:00 PM",
    maxStudents: 18,
    enrolledStudents: 8,
    location: "Studio C & Online",
    tags: ["Art", "Portfolio", "Advanced"],
    modules: [],
    completionRate: 88,
    schedulePeriod: { startDate: "2024-04-01", endDate: "2024-05-15", totalWeeks: "6" },
    sessionDetails: { sessionDuration: "2", maxClasses: "2" },
    frequencyDetails: { selectedDays: ["Friday"], dayTimes: {} },
    frequencies: [{ days: ["Friday"], start: "17:00", end: "19:00", sessions: "1" }],
    chapters: [{ name: "Portfolio Review", description: "Guided review and feedback on student portfolios." }],
    referralCode: "PORT2024",
    commissionRate: "9",
    referralStart: "2024-04-01",
    referralEnd: "2024-05-15",
    referralStatus: "Active",
    affiliateTracking: {
      enabled: true,
      referralCode: "PORT2024",
      commissionRate: 9,
      totalReferrals: 1,
      totalCommission: 80,
    },
    emiPlans: [],
    scholarships: [],
    taxInfo: {
      gstEnabled: true,
      gstRate: 18,
      educationTaxRate: 0,
      pan: "ABCDE1234F",
      autoGeneration: true,
      invoicePrefix: "INV2028",
      lastInvoiceNumber: 1004,
      taxDocuments: [],
    },
    faqs: [],
    reminderSettings: {
      pushEnabled: true,
      emailEnabled: true,
      smsEnabled: true,
      customSchedule: [],
      frequency: "weekly",
      customDays: "",
      customInterval: ""
    },
    freeGifts: ["Certificate", "Sticker"],
    status: "Active",
    courseCategory: "Regular",
    rating: 4.8,
    cohortAnalysis: [],
    learningBehavior: {
      bestLearningTimes: [],
      engagementWindows: [],
      preferredContentTypes: [],
      averageSessionDuration: 0,
      peakActivityDays: []
    },
    roiCalculator: {
      courseCost: 0,
      expectedSalaryIncrease: 0,
      timeToROI: 0,
      industryAverageSalary: 0,
      skillDemandScore: 0
    },
    dropoffPrediction: {
      riskScore: 0,
      riskFactors: [],
      interventionSuggestions: []
    },
    sharedResources: [],
    versionControl: [],
    materialAnalytics: {
      resourceId: "MAT004",
      views: 0,
      downloads: 0,
      averageRating: 0,
      successRate: 0,
      engagementTime: 0,
    },
    credentialVerification: false,
    marketplaceEnabled: false,
    ltiIntegration: false,
    contentSecurity: {
      watermarkEnabled: false,
      downloadProtection: false,
      screenRecordingProtection: false,
      accessLogging: false,
      licenseTracking: false,
    },
    offlineAccess: {
      enabled: false,
      downloadLimit: 0,
      currentDownloads: 0,
      expiryDays: 0,
      accessLogs: [],
    },
    industryPartners: [],
    events: [],
    alumniNetwork: [],
    promotionTemplates: [],
    seasonalPromos: [],
    growthAnalytics: {
      enrollmentTrend: [],
      revenueTrend: [],
      completionTrend: [],
      satisfactionTrend: [],
    },
  },
  // Add more sample courses with only Create Course fields...
]

export default function EnhancedCourseManagementPage() {
  
  // State for filter dropdown open/close
  const [filterDropdownOpen, setFilterDropdownOpen] = useState(false);
  const [filterAction, setFilterAction] = useState<string | null>(null);
  // ...existing code...
  const [showCohortInfo, setShowCohortInfo] = useState(false);
  // --- Draft Management State ---
  const DRAFTS_KEY = 'courseDrafts';
  // Sample drafts
  const sampleDrafts = [
    {
      id: 'DRAFT001',
      name: 'Digital Illustration Basics',
      instructor: 'John Doe',
      description: 'Learn the basics of digital illustration using tablets and software.',
      updatedAt: Date.now() - 100000,
      status: 'Draft',
      type: 'Online',
      level: 'Beginner',
      priceINR: 12000,
      tags: ['Art', 'Digital', 'Beginner'],
    },
    {
      id: 'DRAFT002',
      name: 'Sculpture Workshop',
      instructor: 'Priya Patel',
      description: 'Hands-on workshop for clay and stone sculpture.',
      updatedAt: Date.now() - 90000,
      status: 'Draft',
      type: 'Offline',
      level: 'Intermediate',
      priceINR: 18000,
      tags: ['Art', 'Sculpture', 'Intermediate'],
    },
    {
      id: 'DRAFT003',
      name: 'Portfolio Building',
      instructor: 'Jane Smith',
      description: 'Build your professional art portfolio with expert guidance.',
      updatedAt: Date.now() - 80000,
      status: 'Draft',
      type: 'Hybrid',
      level: 'Advanced',
      priceINR: 22000,
      tags: ['Art', 'Portfolio', 'Advanced'],
    },
    
    
  ];
const [drafts, setDrafts] = useState<DraftType[]>([])

  // Persist drafts to localStorage
  useEffect(() => {
      fetch("/api/drafts")
      .then((res) => res.json())
      .then(setDrafts)
      .catch(() => setDrafts(sampleDrafts))
  }, []);
 

  // Drafts dialog state
  const [isDraftsDialogOpen, setIsDraftsDialogOpen] = useState(false);

  // Save Draft handler
const handleSaveDraft = async () => {
    const now = Date.now()
    const draft = {
      ...newCourseForm,
      id: newCourseForm.id || `DRAFT${now}`,
      updatedAt: now,
      status: 'Draft',
      priceINR: Number(newCourseForm.priceINR) || 0,
    }
    await fetch('/api/drafts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(draft),
    })
    setDrafts((prev: DraftType[]) => [draft, ...prev.filter((d: DraftType) => d.id !== draft.id)])
    setIsAddCourseDialogOpen(false)
    setNewCourseForm({
      id: '',
      name: '',
      instructor: '',
      description: '',
      level: '',
      type: '',
      duration: '',
      priceINR: '',
      schedule: '',
      maxStudents: '',
      location: '',
      tags: [],
      schedulePeriod: { startDate: '', endDate: '', totalWeeks: '18' },
      sessionDetails: { sessionDuration: '', maxClasses: '18' },
      frequencyDetails: { selectedDays: [], dayTimes: {} },
      frequencies: [],
      chapters: [{ name: '', description: '', referencePdf: undefined, assignmentPdf: undefined }],
      referralCode: '',
      commissionRate: '',
      referralStart: '',
      referralEnd: '',
      referralStatus: 'Inactive',
      faqs: [{ question: '', answer: '', isEditing: false }],
      reminderSettings: {
        pushEnabled: true,
        emailEnabled: true,
        smsEnabled: true,
        customSchedule: [],
        frequency: '',
        customDays: '',
        customInterval: '',
      },
      freeGifts: [],
      status: 'Active',
      courseCategory: 'Regular',
    });
    toast({ title: 'Draft Saved', description: 'Your draft has been saved.' });
  };
  const [isEditCourseDialogOpen, setIsEditCourseDialogOpen] = useState(false);
  const [courses, setCourses] = useState<Course[]>([])
  useEffect(() => {
    fetch("/api/courses")
      .then((res) => res.json())
      .then(setCourses)
      .catch(() => setCourses(sampleCourses))
  }, []);
  const [searchTerm, setSearchTerm] = useState("")
  const [selectedCourse, setSelectedCourse] = useState<Course | null>(null)
  const [activeTab, setActiveTab] = useState("all")
  const [isEditMode, setIsEditMode] = useState(false)
  const [editCourseId, setEditCourseId] = useState<string | null>(null)
  const [currency, setCurrency] = useState<"USD" | "INR">("INR")
  const [selectedFilters, setSelectedFilters] = useState<{
    level: string[]
    type: string[]
    status: string[]
    priceRange: [number, number]
  }>({
    level: [],
    type: [],
    status: [],
    priceRange: [0, 100000],
  })
  // For staged filter changes before applying
  const [pendingFilters, setPendingFilters] = useState<{
    level: string[]
    type: string[]
    status: string[]
    priceRange: [number, number]
  }>({
    level: [],
    type: [],
    status: [],
    priceRange: [0, 100000],
  })
  const [sortBy, setSortBy] = useState("name")
  const [sortOrder, setSortOrder] = useState<"asc" | "desc">("asc")
  const [viewMode, setViewMode] = useState<"grid" | "list">("grid")

  // Dialog states
  const [isAddCourseDialogOpen, setIsAddCourseDialogOpen] = useState(false)
  // Advanced Schedule State
  const [schedulePeriod, setSchedulePeriod] = useState({
    startDate: '',
    endDate: '',
    totalWeeks: '18',
  })

  // Auto-calculate totalWeeks when startDate or endDate changes
  useEffect(() => {
    if (schedulePeriod.startDate && schedulePeriod.endDate) {
      const start = new Date(schedulePeriod.startDate)
      const end = new Date(schedulePeriod.endDate)
      if (!isNaN(start.getTime()) && !isNaN(end.getTime()) && end > start) {
        const diffMs = end.getTime() - start.getTime()
        const diffWeeks = Math.ceil(diffMs / (1000 * 60 * 60 * 24 * 7))
        setSchedulePeriod(p => ({ ...p, totalWeeks: diffWeeks.toString() }))
        setNewCourseForm(f => ({ ...f, schedulePeriod: { ...f.schedulePeriod, totalWeeks: diffWeeks.toString() } }))
      }
    }
  }, [schedulePeriod.startDate, schedulePeriod.endDate])
  const [sessionDetails, setSessionDetails] = useState({
    sessionDuration: '', // in hours
    maxClasses: '18',
  })
  type DayTimes = {
    [day: string]: {
      start?: string;
      end?: string;
      sessions?: string;
      minGapHours?: string;
    };
  };
  const [frequencyDetails, setFrequencyDetails] = useState<{
    selectedDays: string[];
    dayTimes: DayTimes;
  }>({
    selectedDays: [],
    dayTimes: {},
  })
  // Mock data for dropdowns
  const instructorOptions = [
    { id: 'INST001', name: 'Jane Smith' },
    { id: 'INST002', name: 'John Doe' },
    { id: 'INST003', name: 'Priya Patel' },
  ];
  const tagOptions = [
    'Art', 'Painting', 'Advanced', 'Professional', 'Beginner', 'Digital', 'Sculpture', 'Portfolio',
  ];
  const courseTypeOptions = [
    'Offline', 'Online', 'Hybrid',
  ];

  // Add Course form state for required fields
  type Frequency = {
    days: string[];
    start: string;
    end: string;
    sessions: string;
  };

  // Mock referral codes for dropdown
  const mockReferralCodes = [
    { code: 'ART2024', status: 'Active' },
    { code: 'PAINT50', status: 'Active' },
    { code: 'SUMMER25', status: 'Inactive' },
    { code: 'NEWUSER10', status: 'Active' },
    { code: 'DIWALI2025', status: 'Inactive' },
  ];

  const [newCourseForm, setNewCourseForm] = useState<{
    id?: string;
    name: string;
    instructor: string;
    description: string;
    level: string;
    type: string;
    duration: string;
    priceINR: string;
    schedule: string;
    maxStudents: string;
    location: string;
    tags: string[];
    schedulePeriod: typeof schedulePeriod;
    sessionDetails: typeof sessionDetails;
    frequencyDetails: typeof frequencyDetails;
    frequencies: Frequency[];
    chapters: { name: string; description: string; referencePdf?: File; assignmentPdf?: File }[];
    referralCode?: string;
    commissionRate?: string;
    referralStart?: string;
    referralEnd?: string;
    referralStatus?: string;
    faqs: { question: string; answer: string; isEditing: boolean }[];
    reminderSettings: {
      pushEnabled: boolean;
      emailEnabled: boolean;
      smsEnabled: boolean;
      customSchedule: { type: string; daysBefore: string; hoursBefore: string; timeOfDay: string; enabled: boolean; customType?: string }[];
      frequency?: string;
      customDays?: string;
      customInterval?: string;
    };
    freeGifts: string[];
    status: "Active" | "Upcoming" | "Completed" | "Draft";
    courseCategory: "Regular" | "Special";
  }>({
    id: '',
    name: '',
    instructor: '',
    description: '',
    level: '',
    type: '',
    duration: '',
    priceINR: '',
    schedule: '',
    maxStudents: '',
    location: '',
    tags: [],
    schedulePeriod,
    sessionDetails,
    frequencyDetails,
    frequencies: [],
    chapters: [{ name: '', description: '', referencePdf: undefined, assignmentPdf: undefined }],
    referralCode: '',
    commissionRate: '',
    referralStart: '',
    referralEnd: '',
    referralStatus: 'Inactive',
    faqs: [{ question: '', answer: '', isEditing: false }],
    reminderSettings: {
      pushEnabled: true,
      emailEnabled: true,
      smsEnabled: true,
      customSchedule: [],
      frequency: '',
      customDays: '',
      customInterval: '',
    },
    freeGifts: [],
    status: "Active",
    courseCategory: "Regular",
  })
  // Validation for mandatory fields (exclude coming soon features)
  const isCreateCourseDisabled =
    !newCourseForm.name.trim() ||
    !newCourseForm.instructor.trim() ||
    !newCourseForm.description.trim() ||
    !newCourseForm.level.trim() ||
    !newCourseForm.type.trim() ||
    !newCourseForm.duration.trim() ||
    !newCourseForm.priceINR.trim() ||
    !newCourseForm.schedule.trim() ||
    !newCourseForm.maxStudents.trim() ||
    newCourseForm.tags.length === 0 ||
    newCourseForm.status === 'Draft'
  const [isViewCourseDialogOpen, setIsViewCourseDialogOpen] = useState(false)
  const [isAnalyticsDialogOpen, setIsAnalyticsDialogOpen] = useState(false)
  const [isFinancialDialogOpen, setIsFinancialDialogOpen] = useState(false)
  const [isMarketingDialogOpen, setIsMarketingDialogOpen] = useState(false)

  // Filter and sort courses
 const filteredAndSortedCourses = useMemo(() => {
    return (Array.isArray(courses) ? courses : [])
      .filter((course) => {
        const matchesSearch =
          course.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          course.instructor.toLowerCase().includes(searchTerm.toLowerCase()) ||
          course.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
          course.tags.some((tag) => tag.toLowerCase().includes(searchTerm.toLowerCase()))

        const matchesLevel =
          selectedFilters.level.length === 0 || selectedFilters.level.includes(course.level)
        const matchesType =
          selectedFilters.type.length === 0 || selectedFilters.type.includes(course.type)
        const matchesStatus =
          selectedFilters.status.length === 0 || selectedFilters.status.includes(course.status)

        const price = currency === "INR" ? course.priceINR : course.price
        const matchesPrice =
          price >= selectedFilters.priceRange[0] && price <= selectedFilters.priceRange[1]

        const matchesTab =
          activeTab === "all" || course.status.toLowerCase() === activeTab.toLowerCase()

        return (
          matchesSearch &&
          matchesLevel &&
          matchesType &&
          matchesStatus &&
          matchesPrice &&
          matchesTab
        )
      })
      .sort((a, b) => {
        let aValue: any, bValue: any
        switch (sortBy) {
          case "name":
            aValue = a.name?.toLowerCase?.() ?? ""
            bValue = b.name?.toLowerCase?.() ?? ""
            break
          case "priceINR":
            aValue = Number(a.priceINR) ?? 0
            bValue = Number(b.priceINR) ?? 0
            break
          case "instructor":
            aValue = a.instructor?.toLowerCase?.() ?? ""
            bValue = b.instructor?.toLowerCase?.() ?? ""
            break
          case "type":
            aValue = a.type?.toLowerCase?.() ?? ""
            bValue = b.type?.toLowerCase?.() ?? ""
            break
          case "level":
            aValue = a.level?.toLowerCase?.() ?? ""
            bValue = b.level?.toLowerCase?.() ?? ""
            break
          case "duration":
            aValue = a.duration?.toLowerCase?.() ?? ""
            bValue = b.duration?.toLowerCase?.() ?? ""
            break
          case "status":
            aValue = a.status?.toLowerCase?.() ?? ""
            bValue = b.status?.toLowerCase?.() ?? ""
            break
          default:
            aValue = a.name?.toLowerCase?.() ?? ""
            bValue = b.name?.toLowerCase?.() ?? ""
        }
        if (typeof aValue === "string" && typeof bValue === "string") {
          return sortOrder === "asc" ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue)
        } else if (typeof aValue === "number" && typeof bValue === "number") {
          return sortOrder === "asc" ? aValue - bValue : bValue - aValue
        } else {
          return sortOrder === "asc"
            ? aValue > bValue
              ? 1
              : aValue < bValue
                ? -1
                : 0
            : aValue < bValue
              ? 1
              : aValue > bValue
                ? -1
                : 0
        }
      })
  }, [courses, searchTerm, selectedFilters, activeTab, currency, sortBy, sortOrder])

  // Calculate statistics
  const courseList = Array.isArray(courses) ? courses : [];
  const stats = {
    totalCourses: courseList.length,
    activeCourses: courseList.filter((c) => c.status === "Active").length,
    totalStudents: courseList.reduce((sum, c) => sum + c.enrolledStudents, 0),
    totalRevenue: courseList.reduce((sum, c) => sum + (currency === "INR" ? c.priceINR : c.price) * c.enrolledStudents, 0),
    averageRating: courseList.length > 0 ? courseList.reduce((sum, c) => sum + c.rating, 0) / courseList.length : 0,
    completionRate: courseList.length > 0 ? courseList.reduce((sum, c) => sum + c.completionRate, 0) / courseList.length : 0,
  }

  const formatCurrency = (amount: number) => {
    if (currency === "INR") {
      return new Intl.NumberFormat("en-IN", {
        style: "currency",
        currency: "INR",
        maximumFractionDigits: 0,
      }).format(amount)
    } else {
      return new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
      }).format(amount)
    }
  }

  const handleBulkAction = (action: string, selectedCourseIds: string[]) => {
    switch (action) {
      case "activate":
        setCourses((prev) =>
          prev.map((course) =>
            selectedCourseIds.includes(course.id) ? { ...course, status: "Active" as const } : course,
          ),
        )
        toast({
          title: "Courses Activated",
          description: `${selectedCourseIds.length} courses have been activated.`,
        })
        break
      case "deactivate":
        setCourses((prev) =>
          prev.map((course) =>
            selectedCourseIds.includes(course.id) ? { ...course, status: "Completed" as const } : course,
          ),
        )
        toast({
          title: "Courses Deactivated",
          description: `${selectedCourseIds.length} courses have been deactivated.`,
        })
        break
      case "updatePricing":
        // This would open a bulk pricing dialog
        toast({
          title: "Bulk Pricing Update",
          description: "Bulk pricing update dialog would open here.",
        })
        break
    }
  }

  // Removed duplicate viewMode declaration to fix build error
  // ...existing code...
  // Cohort Management State (must be inside component to access courses)
    const [cohorts, setCohorts] = useState<any[]>([])
  useEffect(() => {
    fetch('/api/cohorts')
      .then(res => res.json())
      .then(setCohorts)
      .catch(() => setCohorts([]))
  }, []);
  // Add 1 default cohort for each course on mount (if not already present)
  useEffect(() => {
    if (courses && courses.length > 0 && cohorts.length === 0) {
      // Add a few default members to each cohort (use student IDs for name+id rendering)
      const defaultMembers = [
        'STU001',
        'STU002',
        'STU003',
        'STU004',
        'STU005',
      ];
      const defaultCohorts = courses.map((course: any, idx: number) => ({
        id: `COHORT-${course.id}`,
        name: 'Cohort 1',
        courseId: course.id,
        notes: ``,
        members: defaultMembers.slice(0, 2 + (idx % 3)),   // 2-4 members per cohort
        capacity: course.maxStudents || 30,
      }));
      setCohorts(defaultCohorts);
    }
  }, [courses]);
  const [isAddCohortOpen, setIsAddCohortOpen] = useState(false);
  const [newCohort, setNewCohort] = useState<{ name: string; id: string; courseId: string; notes: string; startTime?: string; endTime?: string; capacity?: string }>({ name: '', id: '', courseId: '', notes: '', startTime: '', endTime: '', capacity: '' });
  const [newCohortEditId, setNewCohortEditId] = useState<string | null>(null);
  // Mock student list for dropdown
  const allStudents = [
    { id: 'STU001', name: 'Amit Kumar' },
    { id: 'STU002', name: 'Priya Sharma' },
    { id: 'STU003', name: 'Rahul Verma' },
    { id: 'STU004', name: 'Sneha Singh' },
    { id: 'STU005', name: 'Vikram Patel' },
    { id: 'STU006', name: 'Anjali Rao' },
    { id: 'STU007', name: 'Rohit Das' },
    { id: 'STU008', name: 'Meera Joshi' },
    { id: 'STU009', name: 'Karan Mehta' },
    { id: 'STU010', name: 'Divya Nair' },
    // ...add more as needed
  ];
  const [studentSearch, setStudentSearch] = useState('');
  const [addMembersCohortId, setAddMembersCohortId] = useState<string | null>(null);
  const [memberInput, setMemberInput] = useState<string>('');
  const [selectedMembers, setSelectedMembers] = useState<string[]>([]);

  // Add freeGiftOptions and freeGiftSearchTerm state
  const [freeGiftSearchTerm, setFreeGiftSearchTerm] = useState('');
  const freeGiftOptions: string[] = [
    'T-Shirt',
    'Water Bottle',
    'Notebook',
    'Pen',
    'Badge',
    'Cap',
    'Backpack',
    'Voucher',
    'Keychain',
    'Sticker',
    'Certificate',
  ];

  // Confirmation dialog states
  const [deleteConfirmDialog, setDeleteConfirmDialog] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
    itemName?: string;
  }>({
    isOpen: false,
    title: '',
    message: '',
    onConfirm: () => {},
    itemName: ''
  });

  // Helper function to show confirmation dialog
  const showDeleteConfirmation = (title: string, message: string, onConfirm: () => void, itemName?: string) => {
    setDeleteConfirmDialog({
      isOpen: true,
      title,
      message,
      onConfirm,
      itemName
    });
  };
  // ...existing code...
  // ...existing code...
  return (
    <MainLayout>
      <div className="container mx-auto py-6 space-y-6">
        {/* Enhanced Hero Section */}
        <div className="bg-gradient-to-r from-purple-700 via-purple-600 to-orange-500 text-white rounded-xl p-8 relative overflow-hidden">
          <div className="absolute inset-0 bg-black/10"></div>
          <div className="relative z-10 max-w-4xl">
            <div className="flex items-center gap-3 mb-4">
              <GraduationCap className="h-8 w-8" />
              <h1 className="text-3xl md:text-4xl font-bold">Course Management </h1>
            </div>
            <p className="text-lg mb-6 opacity-90">
              Comprehensive course management with AI-powered insights, and advanced analytics.
              Empowering educators and learners with cutting-edge technology.
            </p>
            <div className="flex flex-wrap gap-4">
              <Button
                variant="secondary"
                className="bg-white text-purple-700 hover:bg-gray-100"
                onClick={() => setIsAddCourseDialogOpen(true)}
              >
                <Plus className="mr-2 h-4 w-4" />
                Create Course
              </Button>
              
              <Button
                variant="outline"
                className="border-white text-purple-700 hover:bg-gray-100 bg-white"
                onClick={() => setIsDraftsDialogOpen(true)}
              >
                <FileText className="mr-2 h-4 w-4" />
                Drafts
              </Button>

      {/* Drafts Dialog Popup */}
      <Dialog open={isDraftsDialogOpen} onOpenChange={setIsDraftsDialogOpen}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>Drafts</DialogTitle>
            <DialogDescription>Manage your saved drafts. Click to view, edit, or delete.</DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            {drafts.length === 0 ? (
              <div className="text-center text-gray-500">No drafts found.</div>
            ) : (
              (Array.isArray(drafts) ? drafts : [])
                .sort((a: DraftType, b: DraftType) => b.updatedAt - a.updatedAt)
                .map((draft: DraftType) => (
                  <Card key={draft.id} className="hover:shadow-md transition-shadow cursor-pointer flex flex-col md:flex-row md:items-center md:justify-between p-4">
                    <div className="flex-1 min-w-0">
                      <div className="font-bold text-lg mb-1">{draft.name}</div>
                      <div className="text-sm text-gray-700 mb-1">{draft.instructor}</div>
                      <div className="text-xs text-gray-500 mb-2">{draft.description}</div>
                      <div className="flex flex-wrap gap-2 mb-2">
                        {draft.tags && draft.tags.map((tag: string, i: number) => (
                          <span key={i} className="bg-gray-100 px-2 py-0.5 rounded text-xs font-medium border border-gray-200">{tag}</span>
                        ))}
                      </div>
                      <div className="text-xs text-gray-400">Last updated: {new Date(draft.updatedAt).toLocaleString()}</div>
                    </div>
                    <div className="flex flex-col md:flex-row items-center gap-2 mt-2 md:mt-0 md:ml-4">
                      
                      {/* Edit icon button */}
                      <button
                        type="button"
                        className="p-2 rounded hover:bg-gray-200 border border-gray-200 flex items-center"
                        title="Edit Draft"
                        onClick={() => {
                          setIsAddCourseDialogOpen(true);
                          setIsEditMode(false);
                          setNewCourseForm({
                            id: draft.id || '',
                            name: draft.name || '',
                            instructor: draft.instructor || '',
                            description: draft.description || '',
                            level: draft.level || '',
                            type: draft.type || '',
                            duration: draft.duration || '',
                            priceINR: draft.priceINR?.toString() || '',
                            schedule: draft.schedule || '',
                            maxStudents: draft.maxStudents?.toString() || '',
                            location: draft.location || '',
                            tags: draft.tags || [],
                            schedulePeriod: draft.schedulePeriod || { startDate: '', endDate: '', totalWeeks: '18' },
                            sessionDetails: draft.sessionDetails || { sessionDuration: '', maxClasses: '18' },
                            frequencyDetails: draft.frequencyDetails || { selectedDays: [], dayTimes: {} },
                            frequencies: draft.frequencies || [],
                            chapters: draft.chapters || [{ name: '', description: '', referencePdf: undefined, assignmentPdf: undefined }],
                            referralCode: draft.referralCode || '',
                            commissionRate: draft.commissionRate || '',
                            referralStart: draft.referralStart || '',
                            referralEnd: draft.referralEnd || '',
                            referralStatus: draft.referralStatus || 'Inactive',
                            faqs: draft.faqs || [{ question: '', answer: '', isEditing: false }],
                            reminderSettings: draft.reminderSettings || {
                              pushEnabled: true,
                              emailEnabled: true,
                              smsEnabled: true,
                              customSchedule: [],
                              frequency: '',
                              customDays: '',
                              customInterval: '',
                            },
                            freeGifts: draft.freeGifts || [],
                            status: draft.status || 'Draft',
                            courseCategory: draft.courseCategory || 'Regular',
                          });
                          setIsDraftsDialogOpen(false);
                        }}
                      >
                        <span role="img" aria-label="Edit">‚úèÔ∏è</span> <span className="ml-1 text-sm hidden md:inline"></span>
                      </button>
                      {/* Delete icon button */}
                      <button
                        type="button"
                        className="p-2 rounded hover:bg-red-100 text-red-500 border border-gray-200 flex items-center"
                        title="Delete Draft"
                        onClick={() => {
                          showDeleteConfirmation(
                            "Delete Draft",
                            "Are you sure you want to delete this draft? This action cannot be undone.",
                            async () => {
                              await fetch('/api/drafts', {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id: draft.id }),
                              })
                              setDrafts((prev: DraftType[]) => prev.filter((d: DraftType) => d.id !== draft.id))
                            },
                            draft.name
                          );
                        }}
                      >
                        <span title="Delete">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="purple" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="3 6 5 6 21 6"></polyline>
  <path d="M19 6l-1 14H6L5 6"></path>
  <path d="M10 11v6"></path>
  <path d="M14 11v6"></path>
  <path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"></path>
</svg>
</span>
<span className="ml-1 text-sm hidden md:inline"></span>
                      </button>
                    </div>
                  </Card>
                ))
            )}
          </div>
        </DialogContent>
        
      </Dialog>
              <Button
                variant="outline"
                className="border-white text-purple-700 hover:bg-gray-100 bg-white"
                onClick={() => setIsMarketingDialogOpen(true)}
              >
                <Megaphone className="mr-2 h-4 w-4" />
                Marketing Tools <span title="Coming Soon"> üîú</span>
              </Button>

             
            </div>
          </div>
        </div>

        {/* Enhanced Statistics Dashboard */}
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
          <Card className="bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-purple-600">Total Courses</p>
                  <p className="text-2xl font-bold text-purple-900">{stats.totalCourses}</p>
                </div>
                <BookOpen className="h-8 w-8 text-purple-500" />
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-green-600">Active Courses</p>
                  <p className="text-2xl font-bold text-green-900">{stats.activeCourses}</p>
                </div>
                <CheckCircle className="h-8 w-8 text-green-500" />
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-blue-600">Total Students</p>
                  <p className="text-2xl font-bold text-blue-900">{stats.totalStudents}</p>
                </div>
                <Users className="h-8 w-8 text-blue-500" />
              </div>
            </CardContent>
          </Card>

<Card className="bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200">
  <CardContent className="p-4">
    <div className="flex items-center justify-between">
      <div>
        <p className="text-sm font-medium text-orange-600">Revenue (INR)</p>
        <p className="text-2xl font-bold text-orange-900">{stats.totalRevenue.toLocaleString('en-IN')}  </p>
      </div>
      <Banknote className="h-8 w-8 text-orange-500" />
    </div>
  </CardContent>
</Card>

          <Card className="bg-gradient-to-br from-yellow-50 to-yellow-100 border-yellow-200">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-yellow-600">Avg Rating</p>
                  <p className="text-2xl font-bold text-yellow-900">{stats.averageRating.toFixed(1)}</p>
                </div>
                <Star className="h-8 w-8 text-yellow-500" />
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-indigo-50 to-indigo-100 border-indigo-200">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-indigo-600">Completion</p>
                  <p className="text-2xl font-bold text-indigo-900">{stats.completionRate.toFixed(0)}%</p>
                </div>
                <Trophy className="h-8 w-8 text-indigo-500" />
              </div>
            </CardContent>
          </Card>
        </div>

        

        {/* Enhanced Search and Filters */}
        <Card>
          <CardContent className="p-6">
              <div className="flex flex-col lg:flex-row gap-2 mb-4">
              <div className="relative flex-1">
                <Search className="absolute left-3 top-3 h-4 w-4 text-gray-400" />
                <Input
                  placeholder="Search courses, instructors, tags..."
                  className="pl-10"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
              </div>

              <div className="flex gap-2">
                

                {/* Filter Button and Dropdown */}
                <DropdownMenu open={filterDropdownOpen} onOpenChange={setFilterDropdownOpen}>
                  <DropdownMenuTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      className="h-9 flex items-center gap-1 relative"
                      aria-label="Filter options"
                    >
                      <span className="relative inline-block">
                        <Filter className="h-3.5 w-3.5 text-purple-500" />
                        {filterAction === "applied" && (
                          <span className="absolute top-0 right-0 transform translate-x-1/4 -translate-y-1/4">
                            <span className="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-green-500">
                              <Check className="w-2 h-2 text-white" />
                            </span>
                          </span>
                        )}
                        {filterAction === "cleared" && (
                          <span className="absolute top-0 right-0 transform translate-x-1/4 -translate-y-1/4">
                            <span className="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-red-500">
                              <X className="w-2 h-2 text-white" />
                            </span>
                          </span>
                        )}
                      </span>
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent className="w-64 p-4">
                    <div className="mb-2 font-semibold text-sm">Filter by Type</div>
                    <div className="flex flex-wrap gap-2 mb-3">
                      {courseTypeOptions.map((type) => (
                        <label key={type} className="flex items-center gap-1 text-xs">
                          <input
                            type="checkbox"
                            checked={pendingFilters.type.includes(type)}
                            onChange={() => {
                              setPendingFilters((prev) => ({
                                ...prev,
                                type: prev.type.includes(type)
                                  ? prev.type.filter((t) => t !== type)
                                  : [...prev.type, type],
                              }));
                            }}
                          />
                          {type}
                        </label>
                      ))}
                    </div>
                    <div className="mb-2 font-semibold text-sm">Filter by Level</div>
                    <div className="flex flex-wrap gap-2 mb-3">
                      {["Beginner", "Intermediate", "Advanced"].map((level) => (
                        <label key={level} className="flex items-center gap-1 text-xs">
                          <input
                            type="checkbox"
                            checked={pendingFilters.level.includes(level)}
                            onChange={() => {
                              setPendingFilters((prev) => ({
                                ...prev,
                                level: prev.level.includes(level)
                                  ? prev.level.filter((l) => l !== level)
                                  : [...prev.level, level],
                              }));
                            }}
                          />
                          {level}
                        </label>
                      ))}
                    </div>
                    <div className="mb-2 font-semibold text-sm">Filter by Status</div>
                    <div className="flex flex-wrap gap-2 mb-3">
                      {["Active", "Inactive", "Draft"].map((status) => (
                        <label key={status} className="flex items-center gap-1 text-xs">
                          <input
                            type="checkbox"
                            checked={pendingFilters.status.includes(status)}
                            onChange={() => {
                              setPendingFilters((prev) => ({
                                ...prev,
                                status: prev.status.includes(status)
                                  ? prev.status.filter((s) => s !== status)
                                  : [...prev.status, status],
                              }));
                            }}
                          />
                          {status}
                        </label>
                      ))}
                    </div>
                    <div className="flex justify-between gap-2 mt-4">
                      <Button
                        size="sm"
                        variant="default"
                        className="flex-1"
                        onClick={() => {
                          setSelectedFilters({ ...pendingFilters });
                          setFilterDropdownOpen(false);
                          setFilterAction("applied");
                        }}
                      >
                        Apply Filters
                      </Button>
                      <Button
                        size="sm"
                        variant="outline"
                        className="flex-1"
                        onClick={() => {
                          setPendingFilters({ ...pendingFilters, type: [], level: [], status: [] });
                          setSelectedFilters({ ...selectedFilters, type: [], level: [], status: [] });
                          setFilterDropdownOpen(false);
                          setFilterAction("cleared");
                        }}
                      >
                        Clear All
                      </Button>
                    </div>
                  </DropdownMenuContent>
                </DropdownMenu>

                {/* Sort Field Dropdown */}
                <DropdownMenu>

                  <DropdownMenuTrigger asChild>
                    <Button variant="outline">
                      <ArrowUpDown className="mr-2 h-4 w-4" />
                      {(() => {
                        const label = [
                          { value: "name", label: "Name" },
                          { value: "priceINR", label: "Price (INR)" },
                          
                          { value: "duration", label: "Duration" },
                         
                        ].find(o => o.value === sortBy)?.label;
                        return label ? <span className="ml-1 text-xs text-gray-600">{label}</span> : null;
                      })()}
                      <span className="ml-2 text-xs text-gray-500">{sortOrder === "asc" ? "‚Üë" : "‚Üì"}</span>
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent>
                    <DropdownMenuLabel>Sort By</DropdownMenuLabel>
                    {[
                      { value: "name", label: "Name" },
                      { value: "priceINR", label: "Price (INR)" },                                
                      { value: "duration", label: "Duration" },
                      
                    ].map((option) => (
                      <DropdownMenuItem
                        key={option.value}
                        onClick={() => {
                          setSortBy(option.value);
                        }}
                      >
                        {option.label}
                        {sortBy === option.value && <span className="ml-2">‚úî</span>}
                      </DropdownMenuItem>
                    ))}
                    <DropdownMenuSeparator />
                    <DropdownMenuLabel>Order</DropdownMenuLabel>
                    <DropdownMenuItem
                      onClick={() => setSortOrder("asc")}
                    >
                      Ascending ‚Üë {sortOrder === "asc" && <span className="ml-2">‚úî</span>}
                    </DropdownMenuItem>
                    <DropdownMenuItem
                      onClick={() => setSortOrder("desc")}
                    >
                      Descending ‚Üì {sortOrder === "desc" && <span className="ml-2">‚úî</span>}
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>



                <div className="flex border rounded-md">
                  <Button
                    variant={viewMode === "grid" ? "default" : "ghost"}
                    size="sm"
                    onClick={() => setViewMode("grid")}
                    className="rounded-r-none"
                  >
                    <div className="grid grid-cols-2 gap-0.5 w-4 h-4">
                      <div className="bg-current rounded-sm"></div>
                      <div className="bg-current rounded-sm"></div>
                      <div className="bg-current rounded-sm"></div>
                      <div className="bg-current rounded-sm"></div>
                    </div>
                  </Button>
                  <Button
                    variant={viewMode === "list" ? "default" : "ghost"}
                    size="sm"
                    onClick={() => setViewMode("list")}
                    className="rounded-l-none border-l"
                  >
                    <div className="flex flex-col gap-0.5 w-4 h-4">
                      <div className="bg-current h-0.5 rounded-sm"></div>
                      <div className="bg-current h-0.5 rounded-sm"></div>
                      <div className="bg-current h-0.5 rounded-sm"></div>
                    </div>
                  </Button>
                </div>
              </div>
            

            <div className="flex flex-wrap gap-2">
              {/* Import Courses Button triggers file input */}
              <input
                id="import-csv-input"
                type="file"
                accept="text/csv,.csv"
                className="hidden"
                onChange={async (e) => {
                  const file = e.target.files?.[0];
                  if (!file) return;
                  if (!file.name.endsWith('.csv')) {
                    alert('Only CSV files are allowed.');
                    return;
                  }
                  const text = await file.text();
                  let importedCourses: Array<Course> = [];
                  try {
                    // Simple CSV to JSON (assumes header row)
                    const [header, ...rows] = text.split(/\r?\n/).filter(Boolean);
                    const keys = header.split(',');
                    importedCourses = rows.map(row => {
                      const values = row.split(',');
                      // Map CSV row to Course type, fill missing fields with defaults
                      return {
                        id: values[keys.indexOf('id')] || uuidv4(),
                        name: values[keys.indexOf('name')] || '',
                        description: values[keys.indexOf('description')] || '',
                        level: values[keys.indexOf('level')] || '',
                        type: values[keys.indexOf('type')] || '',
                        instructor: values[keys.indexOf('instructor')] || '',
                        instructorId: '',
                        duration: values[keys.indexOf('duration')] || '',
                        schedule: values[keys.indexOf('schedule')] || '',
                        enrolledStudents: 0,
                        maxStudents: parseInt(values[keys.indexOf('maxStudents')] || '0', 10),
                        location: values[keys.indexOf('location')] || '',
                        price: parseInt(values[keys.indexOf('priceINR')] || '0', 10),
                        priceINR: parseInt(values[keys.indexOf('priceINR')] || '0', 10),
                        currency: 'INR',
                        rating: 0,
                        status: 'Active',
                        tags: [],
                        modules: [],
                        completionRate: 0,
                        chapters: [],
                        schedulePeriod: { startDate: '', endDate: '', totalWeeks: '18' },
                        sessionDetails: { sessionDuration: '', maxClasses: '18' },
                        frequencies: [],
                        referralCode: '',
                        commissionRate: '',
                        referralStart: '',
                        referralEnd: '',
                        referralStatus: 'Inactive',
                        courseCategory: 'Regular',
                        frequencyDetails: { selectedDays: [], dayTimes: {} },
                        faqs: [],
                        reminderSettings: {
                          pushEnabled: true,
                          emailEnabled: true,
                          smsEnabled: true,
                          customSchedule: [],
                          frequency: '',
                          customDays: '',
                          customInterval: ''
                        },
                        freeGifts: [],
                        cohortAnalysis: [],
                        learningBehavior: {} as any,
                        roiCalculator: {} as any,
                        dropoffPrediction: {} as any,
                        sharedResources: [],
                        versionControl: [],
                        materialAnalytics: {} as any,
                        credentialVerification: false,
                        marketplaceEnabled: false,
                        ltiIntegration: false,
                        contentSecurity: {} as any,
                        offlineAccess: {} as any,
                        industryPartners: [],
                        events: [],
                        alumniNetwork: [],
                        promotionTemplates: [],
                        seasonalPromos: [],
                        growthAnalytics: {} as any,
                      } as Course;
                    }) as Course[];
                    setCourses(prev => [...prev, ...importedCourses]);
                    alert(`Imported ${importedCourses.length} courses!`);
                  } catch (err) {
                    alert('Failed to import courses: ' + err);
                  }
                }}
              />
              <Button
                variant="outline"
                size="sm"
                onClick={() => {
                  document.getElementById('import-csv-input')?.click();
                }}
              >
                <Upload className="mr-2 h-4 w-4" />
                
              </Button>
              <Button variant="outline" size="sm" onClick={() => {
                // Export courses as CSV
                if (!courses.length) return;
                const keys = Object.keys(courses[0]);
                const csvRows = [keys.join(',')].concat(
                  courses.map(course => keys.map(k => JSON.stringify((course as any)[k] ?? '')).join(','))
                );
                const csvStr = csvRows.join('\n');
                const dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csvStr);
                const dlAnchor = document.createElement('a');
                dlAnchor.setAttribute("href", dataStr);
                dlAnchor.setAttribute("download", "courses_export.csv");
                document.body.appendChild(dlAnchor);
                dlAnchor.click();
                document.body.removeChild(dlAnchor);
              }}>
                <Download className="mr-2 h-4 w-4" />
                
              </Button>
            </div>

            </div>
            <div className="overflow-x-auto">
              {viewMode === 'list' ? (
                 filteredAndSortedCourses.length > 3 ? (
<div style={{ maxHeight: '240px', overflowY: 'auto', overflowX: 'hidden', scrollbarWidth: 'thin' }}>
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>Course Name</TableHead>
                          <TableHead>Instructor</TableHead>
                          <TableHead>Type</TableHead>
                          <TableHead>Level</TableHead>
                          <TableHead>Duration</TableHead>
                          <TableHead>Price (INR)</TableHead>
                          <TableHead>Status</TableHead>
                          <TableHead>Actions</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                       {filteredAndSortedCourses.length === 0 ? (
                          <TableRow>  <Trash2 className="h-4 w-4" />
                            <TableCell colSpan={8} className="text-center text-gray-500">No courses found.</TableCell>
                          </TableRow>
                        ) : (
                          filteredAndSortedCourses.map((course) => (
                            
                            <TableRow key={course.id} style={{ cursor: 'pointer' }} onClick={() => { setSelectedCourse(course); setIsViewCourseDialogOpen(true); }}>
                              <TableCell>{course.name}</TableCell>
                              <TableCell>{course.instructor}</TableCell>
                              <TableCell>{course.type}</TableCell>
                              <TableCell>{course.level}</TableCell>
                              <TableCell>{course.duration}</TableCell>
                              <TableCell>{course.priceINR?.toLocaleString?.() ?? ''}</TableCell>
                              <TableCell>
                                <Badge variant={course.status === 'Active' ? 'default' : 'secondary'}>{course.status}</Badge>
                              </TableCell>
                              <TableCell>
                                <Button
                                  size="sm"
                                  variant="ghost"
                                  onClick={e => {
                                    e.stopPropagation()
                                    setIsAddCourseDialogOpen(true)
                                    setIsEditMode(true)
                                    setEditCourseId(course.id)
                                    setNewCourseForm({
                                      id: course.id,
                                      name: course.name,
                                      instructor: course.instructor,
                                      description: course.description,
                                      level: course.level,
                                      type: course.type,
                                      duration: course.duration,
                                      priceINR: course.priceINR?.toString() || '',
                                      schedule: course.schedule || '',
                                      maxStudents: course.maxStudents?.toString() || '',
                                      location: course.location || '',
                                      tags: course.tags || [],
                                      schedulePeriod: course.schedulePeriod || { startDate: '', endDate: '', totalWeeks: '' },
                                      sessionDetails: course.sessionDetails || { sessionDuration: '', maxClasses: '' },
                                      frequencyDetails: course.frequencyDetails || { selectedDays: [], dayTimes: {} },
                                      frequencies: course.frequencies || [],
                                      chapters: course.chapters || [{ name: '', description: '', referencePdf: undefined, assignmentPdf: undefined }],
                                      faqs: course.faqs || [{ question: '', answer: '', isEditing: false }],
                                      referralCode: course.referralCode || '',
                                      commissionRate: course.commissionRate || '',
                                      referralStart: course.referralStart || '',
                                      referralEnd: course.referralEnd || '',
                                      referralStatus: course.referralStatus || 'Inactive',
                                      reminderSettings: course.reminderSettings || {
                                        pushEnabled: false,
                                        emailEnabled: false,
                                        smsEnabled: false,
                                        customSchedule: [],
                                        frequency: '',
                                        customDays: '',
                                        customInterval: ''
                                      },
                                      freeGifts: course.freeGifts || [],
                                      status: course.status || 'Active',
                                      courseCategory: (course.courseCategory === 'Regular' || course.courseCategory === 'Special') ? course.courseCategory : 'Regular',
                                    })
                                  }}>
                                  <Pencil className="h-4 w-4" />
                                </Button>
                                 <Button
                                  size="sm"
                                  variant="ghost"
                                  onClick={e => {
                                    e.stopPropagation();
                                    showDeleteConfirmation(
                                      "Delete Course",
                                      "Are you sure you want to delete this course? This will permanently remove all course data, student enrollments, and cannot be undone.",
                                      async () => {
                                        await fetch('/api/courses', {
                                          method: 'DELETE',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify({ id: course.id }),
                                        })
                                        setCourses(prev => prev.filter(c => c.id !== course.id))
                                      },
                                      course.name
                                    );
                                  }}
                                >
                                
                                </Button>
                              </TableCell>
                            </TableRow>
                          ))
                        )}
                      </TableBody>
                    </Table>
                   
                    
                  </div>
                ) : (
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>Course Name</TableHead>
                        <TableHead>Instructor</TableHead>
                        <TableHead>Type</TableHead>
                        <TableHead>Level</TableHead>
                        <TableHead>Duration</TableHead>
                        <TableHead>Price (INR)</TableHead>
                        <TableHead>Status</TableHead>
                        <TableHead>Actions</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {filteredAndSortedCourses.length === 0 ? (
                        <TableRow>
                          <TableCell colSpan={8} className="text-center text-gray-500">No courses found.</TableCell>
                        </TableRow>
                      ) : (
                      filteredAndSortedCourses.map((course) => (
                          <TableRow key={course.id} style={{ cursor: 'pointer' }} onClick={() => { setSelectedCourse(course); setIsViewCourseDialogOpen(true); }}>
                            <TableCell>{course.name}</TableCell>
                            <TableCell>{course.instructor}</TableCell>
                            <TableCell>{course.type}</TableCell>
                            <TableCell>{course.level}</TableCell>
                            <TableCell>{course.duration}</TableCell>
                            <TableCell>{course.priceINR?.toLocaleString?.() ?? ''}</TableCell>
                            <TableCell>
                              <Badge variant={course.status === 'Active' ? 'default' : 'secondary'}>{course.status}</Badge>
                            </TableCell>
                            <TableCell>
                              <Button 
                                size="sm" 
                                variant="ghost" 
                                onClick={e => { 
                                  e.stopPropagation(); 
                                  setIsAddCourseDialogOpen(true);
                                  setIsEditMode(true);
                                  setEditCourseId(course.id);
                                  setNewCourseForm({
                                    id: course.id,
                                    name: course.name,
                                    instructor: course.instructor,
                                    description: course.description,
                                    level: course.level,
                                    type: course.type,
                                    duration: course.duration,
                                    priceINR: course.priceINR?.toString() || '',
                                    schedule: course.schedule || '',
                                    maxStudents: course.maxStudents?.toString() || '',
                                    location: course.location || '',
                                    tags: course.tags || [],
                                    schedulePeriod: course.schedulePeriod || { startDate: '', endDate: '', totalWeeks: '' },
                                    sessionDetails: course.sessionDetails || { sessionDuration: '', maxClasses: '' },
                                    frequencyDetails: course.frequencyDetails || { selectedDays: [], dayTimes: {} },
                                    frequencies: course.frequencies || [],
                                    chapters: course.chapters || [{ name: '', description: '', referencePdf: undefined, assignmentPdf: undefined }],
                                    faqs: course.faqs || [{ question: '', answer: '', isEditing: false }],
                                    referralCode: course.referralCode || '',
                                    commissionRate: course.commissionRate || '',
                                    referralStart: course.referralStart || '',
                                    referralEnd: course.referralEnd || '',
                                    referralStatus: course.referralStatus || 'Inactive',
                                    reminderSettings: course.reminderSettings || {
                                      pushEnabled: false,
                                      emailEnabled: false,
                                      smsEnabled: false,
                                      customSchedule: [],
                                      frequency: '',
                                      customDays: '',
                                      customInterval: ''
                                    },
                                    freeGifts: course.freeGifts || [],
                                    status: course.status || 'Active',
                                    courseCategory: (course.courseCategory === 'Regular' || course.courseCategory === 'Special') ? course.courseCategory : 'Regular',
                                  });
                                }}>
                                <Pencil className="h-4 w-4" />
                              </Button>
                            </TableCell>
                          </TableRow>
                        ))
                      )}
                    </TableBody>
                  </Table>
                )
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {filteredAndSortedCourses.length === 0 ? (
                    <div className="col-span-full text-center text-gray-500">No courses found.</div>
                  ) : (
                    filteredAndSortedCourses.map((course) => (
                      <Card key={course.id} className="hover:shadow-md transition-shadow" style={{ cursor: 'pointer', position: 'relative' }} onClick={() => { setSelectedCourse(course); setIsViewCourseDialogOpen(true); }}>
                        <CardContent className="p-4">
                          <div className="flex items-center justify-between mb-2">
                            <h3 className="font-bold text-lg">{course.name}</h3>
                            <Badge variant={course.status === 'Active' ? 'default' : 'secondary'}>{course.status}</Badge>
                          </div>
                          <div className="text-sm text-gray-600 mb-2">Instructor: {course.instructor}</div>
                          <div className="flex flex-wrap gap-2 mb-2">
                            <Badge variant="outline">{course.type}</Badge>
                            <Badge>{course.level}</Badge>
                            <span className="text-xs text-gray-500">{course.duration}</span>
                          </div>
                          <div className="text-lg font-bold text-purple-600 mb-2">{course.priceINR?.toLocaleString?.() ?? ''} INR</div>
                          {/* Pencil icon in top right corner */}
                          <button
                            type="button"
                            style={{ position: 'absolute', top: 5, right: 5, background: 'white', border: 'none', padding: 0, cursor: 'pointer' }}
                            onClick={e => {
                              e.stopPropagation();
                              setIsAddCourseDialogOpen(true);
                              setIsEditMode(true);
                              setEditCourseId(course.id);
                              setNewCourseForm({
                                id: course.id,
                                name: course.name,
                                instructor: course.instructor,
                                description: course.description,
                                level: course.level,
                                type: course.type,
                                duration: course.duration,
                                priceINR: course.priceINR?.toString() || '',
                                schedule: course.schedule || '',
                                maxStudents: course.maxStudents?.toString() || '',
                                location: course.location || '',
                                tags: course.tags || [],
                                schedulePeriod: course.schedulePeriod || { startDate: '', endDate: '', totalWeeks: '' },
                                sessionDetails: course.sessionDetails || { sessionDuration: '', maxClasses: '' },
                                frequencyDetails: course.frequencyDetails || { selectedDays: [], dayTimes: {} },
                                frequencies: course.frequencies || [],
                                chapters: course.chapters || [{ name: '', description: '', referencePdf: undefined, assignmentPdf: undefined }],
                                faqs: course.faqs || [{ question: '', answer: '', isEditing: false }],
                                referralCode: course.referralCode || '',
                                commissionRate: course.commissionRate || '',
                                referralStart: course.referralStart || '',
                                referralEnd: course.referralEnd || '',
                                referralStatus: course.referralStatus || 'Inactive',
                                reminderSettings: course.reminderSettings || {
                                  pushEnabled: false,
                                  emailEnabled: false,
                                  smsEnabled: false,
                                  customSchedule: [],
                                  frequency: '',
                                  customDays: '',
                                  customInterval: ''
                                },
                                freeGifts: course.freeGifts || [],
                                status: course.status || 'Active',
                                courseCategory: (course.courseCategory === 'Regular' || course.courseCategory === 'Special') ? course.courseCategory : 'Regular',
                              });
                            }}
                            aria-label="Edit Course"
                          >
                            <Pencil className="h-4 w-4 text-purple-700" />
                          </button>
                        </CardContent>
                      </Card>
                    ))
                  )}
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        

        

        {/* --- Cohort Management Section (moved to last) --- */}
        <div className="mb-8">
          <div className="flex justify-between items-center mb-4">
            <div className="flex items-center gap-2">
              <h2 className="text-xl font-bold">Cohort Management</h2>
              {/* Info icon with tooltip */}
              <div style={{ position: 'relative', display: 'inline-block' }}>
                <button
                  type="button"
                  aria-label="What is a cohort?"
                  className="text-gray-400 hover:text-gray-700 focus:outline-none"
                  onMouseEnter={() => setShowCohortInfo(true)}
                  onMouseLeave={() => setShowCohortInfo(false)}
                  style={{ lineHeight: 1 }}
                >
                  <svg width="18" height="18" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2" fill="#fff"/><text x="12" y="16" textAnchor="middle" fontSize="13" fill="currentColor" fontFamily="Arial" fontWeight="bold">i</text></svg>
                </button>
                {showCohortInfo && (
                  <div style={{
                    position: 'absolute',
                    top: '120%',
                    left: '50%',
                    transform: 'translateX(-50%)',
                    background: '#fff',
                    color: '#222',
                    border: '1px solid #e5e7eb',
                    borderRadius: '0.5rem',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
                    padding: '0.75rem 1rem',
                    zIndex: 50,
                    minWidth: '260px',
                    fontSize: '0.95rem',
                    pointerEvents: 'none',
                  }}>
                    <span dangerouslySetInnerHTML={{ __html: 'A <b>cohort</b> is a group of students who learn together in the same course or class. Managing cohorts helps organize students, track their progress, and provide a better learning experience.' }} />
                  </div>
                )}
              </div>
            </div>
            <Button onClick={() => {
              setNewCohort({ name: '', id: `COHORT${Math.floor(Math.random()*10000)}`, courseId: '', notes: '' });
              setIsAddCohortOpen(true);
            }}><Plus className="mr-2 h-4 w-4" />Add Cohort</Button>
          </div>
        {/* Cohort Info Dialog */}
        {/* Dialog removed, tooltip now shown on hover above */}
          {/* Cohort List Hierarchy */}
          <div className="space-y-4">
            {(Array.isArray(courses) ? courses : []).map((course: Course) => (
              <div key={course.id} className="border rounded-lg p-4">
                <div className="font-semibold mb-2">{course.name} ({course.id})</div>
                {cohorts.filter((c: any) => c.courseId === course.id).length === 0 ? (
                  <div className="text-gray-500 text-sm mb-2">No cohorts for this course.</div>
                ) : (
                  cohorts.filter((c: any) => c.courseId === course.id).map((cohort: any) => (
                    <div key={cohort.id} className="border rounded p-2 mb-2 bg-gray-50">
                      <div className="flex justify-between items-center">
                        <div>
                          <span className="font-medium">{cohort.name}</span> <span className="text-xs text-gray-500">({cohort.id})</span>
                          <span className="ml-2 text-xs text-blue-600">Members: {cohort.members.length}</span>
                        </div>
                        <div className="flex gap-2">
                          {/* Add Members Icon Button */}
                          <button
                            type="button"
                            className="p-2 rounded hover:bg-gray-200"
                            onClick={() => { setAddMembersCohortId(cohort.id ?? ''); setSelectedMembers([]); }}
                            title="Add Members"
                          >
                            +<span role="img" aria-label="Add Members">üë§</span>
                          </button>
                          {/* Edit Icon Button */}
                          <button
                            type="button"
                            className="p-2 rounded hover:bg-gray-200"
                            title="Edit Cohort"
                            onClick={() => {
                              setNewCohort({
                                name: cohort.name || '',
                                id: cohort.id || '',
                                courseId: cohort.courseId || '',
                                notes: cohort.notes || '',
                                startTime: cohort.startTime || '',
                                endTime: cohort.endTime || '',
                                capacity: cohort.capacity ? String(cohort.capacity) : ''
                              });
                              setNewCohortEditId(cohort.id);
                              setIsAddCohortOpen(true);
                            }}
                          >
                            <span role="img" aria-label="Edit">‚úèÔ∏è</span>
                          </button>
                          {/* Delete Icon Button */}
                          <button
                            type="button"
                            className="p-2 rounded hover:bg-red-100 text-red-500"
                            onClick={() => {
                              showDeleteConfirmation(
                                "Delete Cohort",
                                "Are you sure you want to delete this cohort? This will remove all members from the cohort and cannot be undone.",
                                async () => {
                                  await fetch('/api/cohorts', {
                                    method: 'DELETE',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ id: cohort.id }),
                                  })
                                  setCohorts((cs: any) => cs.filter((c: any) => c.id !== cohort.id))
                                },
                                cohort.name
                              );
                            }}
                          ><span title="Delete">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="purple" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="3 6 5 6 21 6"></polyline>
  <path d="M19 6l-1 14H6L5 6"></path>
  <path d="M10 11v6"></path>
  <path d="M14 11v6"></path>
  <path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"></path>
</svg>
</span>

                            
                          </button>
                        </div>
                      </div>
                      <div className="text-xs text-gray-600">{cohort.notes}</div>
                      {/* Members List */}
                      {cohort.members.length > 0 && (
                        <div className="mt-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
                          {cohort.members.map((m: any, i: number) => {
                            // Find student name if available
                            const student = allStudents.find((s) => s.id === m);
                            return (
                              <div key={i} className="flex items-center justify-between bg-gray-50 border border-gray-200 rounded px-3 py-1 text-sm">
                                <div className="flex flex-col">
                                  <span className="font-medium text-gray-800">{student ? student.name : m}</span>
                                  <span className="text-xs text-gray-500">{m}</span>
                                </div>
                                <button
                                  type="button"
                                  className="text-red-500 p-1 rounded hover:bg-red-100 ml-2"
                                  title="Remove Member"
                                  onClick={() => {
                                    showDeleteConfirmation(
                                      "Remove Member",
                                      "Are you sure you want to remove this member from the cohort?",
                                      async () => {
                                        const updatedMembers = cohort.members.filter((mem: any) => mem !== m);
                                        await fetch('/api/cohorts', {
                                          method: 'POST',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify({ ...cohort, members: updatedMembers }),
                                        });
                                        setCohorts((cs: any) => cs.map((c: any) => c.id === cohort.id ? { ...c, members: updatedMembers } : c));
                                      },
                                      student ? student.name : m
                                    );
                                  }}
                                >
                                  <span role="img" aria-label="Remove">‚ùå</span>
                                </button>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  ))
                )}
              </div>
            ))}
          </div>

          {/* Add Cohort Modal */}
          <Dialog open={isAddCohortOpen} onOpenChange={v => {
            setIsAddCohortOpen(v);
            if (!v) setNewCohortEditId(null);
          }}>
            <DialogContent className="max-w-md">
              <DialogTitle className="font-bold mb-2">{newCohortEditId ? 'Edit Cohort' : 'Add New Cohort'}</DialogTitle>
              <div className="space-y-2">
                <Label>Cohort Name <span className="text-red-500">*</span></Label>
                <Input value={newCohort.name} onChange={e => setNewCohort(c => ({ ...c, name: e.target.value }))} />
                <Label>Cohort ID <span className="text-red-500">*</span></Label>
                <Input value={newCohort.id} onChange={e => setNewCohort(c => ({ ...c, id: e.target.value }))} />
                <Label>Associated Course <span className="text-red-500">*</span></Label>
                <select className="input input-bordered w-full" value={newCohort.courseId} onChange={e => setNewCohort(c => ({ ...c, courseId: e.target.value }))}>
                  <option value="">Select course</option>
                  {(Array.isArray(courses) ? courses : []).map((c: Course) => <option key={c.id} value={c.id}>{c.name} ({c.id})</option>)}
                </select>
                <div className="grid grid-cols-3 gap-2">
                  <div>
                    <Label>Start Time</Label>
                    <Input type="time" value={newCohort.startTime || ''} onChange={e => setNewCohort(c => ({ ...c, startTime: e.target.value }))} />
                  </div>
                  <div>
                    <Label>End Time</Label>
                    <Input type="time" value={newCohort.endTime || ''} onChange={e => setNewCohort(c => ({ ...c, endTime: e.target.value }))} />
                  </div>
                  <div>
                    <Label>Capacity <span className="text-red-500">*</span></Label>
                    <Input 
                      type="number" 
                      min="1" 
                      value={newCohort.capacity || ''} 
                      onChange={e => {
                        const value = parseInt(e.target.value);
                        if (value >= 1 || e.target.value === '') {
                          setNewCohort(c => ({ ...c, capacity: e.target.value.replace(/[^\d]/g, '') }));
                        }
                      }}
                      onKeyDown={e => {
                        // Prevent minus sign, plus sign, and decimal point
                        if (e.key === '-' || e.key === '+' || e.key === '.' || e.key === 'e' || e.key === 'E') {
                          e.preventDefault();
                        }
                      }}
                      className={`border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent ${
                        newCohort.capacity && parseInt(newCohort.capacity) < 1 
                          ? 'border-red-500 bg-red-50' 
                          : 'border-gray-300'
                      }`}
                    />
                    {newCohort.capacity && parseInt(newCohort.capacity) < 1 && (
                      <p className="text-red-500 text-xs mt-1">Capacity must be at least 1</p>
                    )}
                  </div>
                </div>
                <Label>Notes/Description</Label>
                <Textarea value={newCohort.notes} onChange={e => setNewCohort(c => ({ ...c, notes: e.target.value }))} />
              </div>
              <div className="flex justify-end mt-4 gap-2">
                <Button variant="ghost" onClick={() => { setIsAddCohortOpen(false); setNewCohortEditId(null); }}>Cancel</Button>
                {newCohortEditId ? (
                  <Button onClick={async () => {
                    if (!newCohort.name || !newCohort.id || !newCohort.courseId || !newCohort.capacity) return
                    const capacityNum = parseInt(newCohort.capacity ?? '', 10)
                    if (capacityNum < 1) {
                      alert('Capacity must be at least 1')
                      return
                    }
                    const updated = { ...newCohort, id: newCohortEditId, capacity: capacityNum }
                    await fetch('/api/cohorts', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(updated),
                    })
                    setCohorts((cs: any) => cs.map((c: any) =>
                      c.id === newCohortEditId
                                   ? { ...c, ...updated }
                        : c
                    ))
                    setIsAddCohortOpen(false)
                    setNewCohortEditId(null)
                  }}>Save Changes</Button>
                ) : (
                  <Button onClick={async () => {
                    if (!newCohort.name || !newCohort.id || !newCohort.courseId || !newCohort.capacity) return
                    const capacityNum = parseInt(newCohort.capacity ?? '', 10)
                    if (capacityNum < 1) {
                      alert('Capacity must be at least 1')
                      return
                    }
                    const cohortData = { ...newCohort, members: [], capacity: capacityNum }
                    await fetch('/api/cohorts', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(cohortData),
                    })
                    setCohorts((cs: any) => [...cs, cohortData])
                    setIsAddCohortOpen(false)
                  }}><Plus className="mr-2 h-4 w-4" /> Create</Button>
                )}
              </div>
            </DialogContent>
          </Dialog>

          {/* Add Members Modal */}
          <Dialog open={!!addMembersCohortId} onOpenChange={v => { if (!v) setAddMembersCohortId(null); }}>
            <DialogContent className="max-w-md">
              <DialogTitle className="font-bold mb-2">Add Members to Cohort</DialogTitle>
              {addMembersCohortId && (() => {
                const cohort = cohorts.find((c: any) => c.id === addMembersCohortId);
                const currentMembers = cohort?.members || [];
                const capacity = cohort?.capacity || 0;
                const availableSlots = capacity - currentMembers.length;
                // Filter out already added students
                const filteredStudents = allStudents.filter(s => !currentMembers.includes(s.id) && (studentSearch === '' || s.name.toLowerCase().includes(studentSearch.toLowerCase()) || s.id.toLowerCase().includes(studentSearch.toLowerCase())));
                return (
                  <>
                    <div className="mb-2 text-xs text-gray-600">Cohort ID: {addMembersCohortId}</div>
                    <div className="mb-2 text-xs text-gray-600">Course ID: {cohort?.courseId}</div>
                    <div className="mb-2 text-xs text-gray-600">Capacity: {capacity} | Current: {currentMembers.length} | Available: {availableSlots}</div>
                    <Label>Select Students (max {availableSlots})</Label>
                    <Input value={studentSearch} onChange={e => setStudentSearch(e.target.value)} placeholder="Search students..." className="mb-2" />
                    <div className="max-h-40 overflow-y-auto border rounded p-2 bg-white mb-2">
                      {filteredStudents.length === 0 && <div className="text-xs text-gray-400">No students found.</div>}
                      {filteredStudents.map(s => (
                        <div key={s.id} className="flex items-center gap-2 py-1">
                          <input
                            type="checkbox"
                            checked={selectedMembers.includes(s.id)}
                            disabled={selectedMembers.length >= availableSlots && !selectedMembers.includes(s.id)}
                            onChange={e => {
                              if (e.target.checked) {
                                if (selectedMembers.length < availableSlots) setSelectedMembers(m => [...m, s.id]);
                              } else {
                                setSelectedMembers(m => m.filter(id => id !== s.id));
                              }
                            }}
                          />
                          <span className="text-sm">{s.name} ({s.id})</span>
                        </div>
                      ))}
                    </div>
                    <div className="flex gap-2 mt-2">
                      <Button className= "absolute right"size="sm" onClick={async () => {
                        if (selectedMembers.length === 0) return
                        const cohort = cohorts.find((c: any) => c.id === addMembersCohortId)
                        const updatedMembers = cohort ? [...cohort.members, ...selectedMembers.slice(0, availableSlots)] : []
                        await fetch('/api/cohorts', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ ...cohort, members: updatedMembers }),
                        })
                        setCohorts((cs: any) => cs.map((c: any) =>
                          c.id === addMembersCohortId
                                                       ? { ...c, members: updatedMembers }
                            : c
                        ))
                        setSelectedMembers([])
                        setStudentSearch('')
                      }}>Add Members</Button>
                      <Button size="sm" variant="ghost" onClick={() => { setAddMembersCohortId(null); setSelectedMembers([]); setStudentSearch(''); }}>Close</Button>
                    </div>
                    
                  </>
                );
              })()}
            </DialogContent>
          </Dialog>
        </div>

        {/* Add Course Dialog */}
        <Dialog 
          open={isAddCourseDialogOpen} 
          onOpenChange={(open) => {
            if (!open) {
              setIsAddCourseDialogOpen(false);
              setIsEditMode(false);
              setEditCourseId(null);
              // Reset form
              setNewCourseForm({
                id: '',
                name: '',
                instructor: '',
                description: '',
                level: 'Beginner',
                type: '',
                duration: '',
                priceINR: '',
                schedule: '',
                maxStudents: '',
                location: '',
                tags: [],
                schedulePeriod: { startDate: '', endDate: '', totalWeeks: '18' },
                sessionDetails: { sessionDuration: '', maxClasses: '18' },
                frequencyDetails: { selectedDays: [], dayTimes: {} },
                frequencies: [],
                chapters: [{ name: '', description: '', referencePdf: undefined, assignmentPdf: undefined }],
                referralCode: '',
                commissionRate: '',
                referralStart: '',
                referralEnd: '',
                referralStatus: 'Inactive',
                faqs: [],
                
                reminderSettings: {
                  pushEnabled: false,
                  emailEnabled: false,
                  smsEnabled: false,
                  customSchedule: [],
                  frequency: '',
                  customDays: '',
                  customInterval: ''
                },
                freeGifts: [],
                status: 'Active',
                courseCategory: 'Regular'
              });
            } else {
              setIsAddCourseDialogOpen(true);
            }
          }}>
          <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              {/* Flex container for title and Save Draft button */}
              <div className="flex items-center justify-between w-full">
                <DialogTitle className="flex items-center gap-2">
                  {isEditMode ? <Pencil className="h-5 w-5" /> : <Plus className="h-5 w-5" />}
                  {isEditMode ? 'Edit Course' : 'Create New Course'}
                </DialogTitle>
                {!isEditMode && (
                  <Button
                    variant="outline"
                    className="border-white text-purple-700 hover:bg-gray-100 bg-white"
                    onClick={() => {
                      // Save as draft
                      const draftCourse = {
                        ...newCourseForm,
                        status: "Draft",
                        id: newCourseForm.id || uuidv4(),
                        instructorId: "DRAFT-INST",
                        enrolledStudents: 0,
                        price: 0,
                        currency: "INR",
                        schedule: newCourseForm.schedule || "",
                        maxStudents: Number(newCourseForm.maxStudents) || 0,
                        location: newCourseForm.location || "",
                        tags: newCourseForm.tags || [],
                        modules: [],
                        completionRate: 0,
                        priceINR: Number(newCourseForm.priceINR) || 0,
                        schedulePeriod: newCourseForm.schedulePeriod || { startDate: '', endDate: '', totalWeeks: '0' },
                        sessionDetails: newCourseForm.sessionDetails || { sessionDuration: '', maxClasses: '0' },
                        frequencyDetails: newCourseForm.frequencyDetails || { selectedDays: [], dayTimes: {} },
                        frequencies: newCourseForm.frequencies || [],
                        chapters: newCourseForm.chapters || [],
                        referralCode: newCourseForm.referralCode || "",
                        commissionRate: newCourseForm.commissionRate || "",
                        referralStart: newCourseForm.referralStart || "",
                        referralEnd: newCourseForm.referralEnd || "",
                        referralStatus: newCourseForm.referralStatus || "Inactive",
                        affiliateTracking: {
                          enabled: false,
                          referralCode: "",
                          commissionRate: 0,
                          totalReferrals: 0,
                          totalCommission: 0,
                        },
                        emiPlans: [],
                        scholarships: [],
                        taxInfo: {
                          gstEnabled: false,
                          gstRate: 0,
                          educationTaxRate: 0,
                          pan: "",
                          autoGeneration: false,
                          invoicePrefix: "",
                          lastInvoiceNumber: 0,
                          taxDocuments: [],
                        },
                        faqs: newCourseForm.faqs || [],
                        reminderSettings: newCourseForm.reminderSettings || {
                          pushEnabled: false,
                          emailEnabled: false,
                          smsEnabled: false,
                          customSchedule: [],
                          frequency: '',
                          customDays: '',
                          customInterval: '',
                        },
                        freeGifts: newCourseForm.freeGifts || [],
                        courseCategory: newCourseForm.courseCategory || "Regular",
                        rating: 0,
                        cohortAnalysis: [],
                        learningBehavior: {
                          bestLearningTimes: [],
                          engagementWindows: [],
                          preferredContentTypes: [],
                          averageSessionDuration: 0,
                          peakActivityDays: [],
                        },
                        roiCalculator: {
                          courseCost: 0,
                          expectedSalaryIncrease: 0,
                          timeToROI: 0,
                          industryAverageSalary: 0,
                          skillDemandScore: 0,
                        },
                        dropoffPrediction: {
                          riskScore: 0,
                          riskFactors: [],
                          interventionSuggestions: [],
                        },
                        sharedResources: [],
                        versionControl: [],
                        materialAnalytics: {
                          resourceId: "",
                          views: 0,
                          downloads: 0,
                          averageRating: 0,
                          successRate: 0,
                          engagementTime: 0,
                        },
                        credentialVerification: false,
                        marketplaceEnabled: false,
                        ltiIntegration: false,
                        contentSecurity: {
                          watermarkEnabled: false,
                          downloadProtection: false,
                          screenRecordingProtection: false,
                          accessLogging: false,
                          licenseTracking: false,
                        },
                        offlineAccess: {
                          enabled: false,
                          downloadLimit: 0,
                          currentDownloads: 0,
                          expiryDays: 0,
                          accessLogs: [],
                        },
                        industryPartners: [],
                        events: [],
                        alumniNetwork: [],
                        promotionTemplates: [],
                        seasonalPromos: [],
                        growthAnalytics: {
                          enrollmentTrend: [],
                          revenueTrend: [],
                          completionTrend: [],
                          satisfactionTrend: [],
                        },
                      };

    
    setCourses(prev => [
      ...prev,
      {
        ...draftCourse,
        instructorId: draftCourse.instructorId || '',
        enrolledStudents: draftCourse.enrolledStudents || 0,
        price: draftCourse.priceINR || 0,
        currency: 'INR',
        rating: draftCourse.rating || 0,
        tags: draftCourse.tags || [],
        modules: draftCourse.modules || [],
        completionRate: draftCourse.completionRate || 0,
        chapters: draftCourse.chapters || [],
        schedulePeriod: draftCourse.schedulePeriod || { startDate: '', endDate: '', totalWeeks: '18' },
        sessionDetails: draftCourse.sessionDetails || { sessionDuration: '', maxClasses: '18' },
        frequencies: draftCourse.frequencies || [],
        referralCode: draftCourse.referralCode || '',
        commissionRate: draftCourse.commissionRate || '',
        referralStart: draftCourse.referralStart || '',
        referralEnd: draftCourse.referralEnd || '',
        referralStatus: draftCourse.referralStatus || 'Inactive',
        courseCategory: draftCourse.courseCategory || 'Regular',
        frequencyDetails: draftCourse.frequencyDetails || { selectedDays: [], dayTimes: {} },
        faqs: draftCourse.faqs || [],
        reminderSettings: draftCourse.reminderSettings || {
          pushEnabled: true,
          emailEnabled: true,
          smsEnabled: true,
          customSchedule: [],
          frequency: '',
          customDays: '',
          customInterval: ''
        },
        freeGifts: draftCourse.freeGifts || [],
        cohortAnalysis: draftCourse.cohortAnalysis || [],
        learningBehavior: draftCourse.learningBehavior || {} as any,
        roiCalculator: draftCourse.roiCalculator || {} as any,
        dropoffPrediction: draftCourse.dropoffPrediction || {} as any,
        sharedResources: draftCourse.sharedResources || [],
        versionControl: draftCourse.versionControl || [],
        materialAnalytics: draftCourse.materialAnalytics || {} as any,
        credentialVerification: draftCourse.credentialVerification || false,
        marketplaceEnabled: draftCourse.marketplaceEnabled || false,
        ltiIntegration: draftCourse.ltiIntegration || false,
        contentSecurity: draftCourse.contentSecurity || {} as any,
        offlineAccess: draftCourse.offlineAccess || {} as any,
        industryPartners: draftCourse.industryPartners || [],
        events: draftCourse.events || [],
        alumniNetwork: draftCourse.alumniNetwork || [],
        promotionTemplates: draftCourse.promotionTemplates || [],
        seasonalPromos: draftCourse.seasonalPromos || [],
        growthAnalytics: draftCourse.growthAnalytics || {} as any,
      } as Course
    ]);
    
                      setIsAddCourseDialogOpen(false);
                      setNewCourseForm({
                        id: '',
                        name: '',
                        instructor: '',
                        description: '',
                        level: '',
                        type: '',
                        duration: '',
                        priceINR: '',
                        schedule: '',
                        maxStudents: '',
                        location: '',
                        tags: [],
                        schedulePeriod: { startDate: '', endDate: '', totalWeeks: '18' },
                        sessionDetails: { sessionDuration: '', maxClasses: '18' },
                        frequencyDetails: { selectedDays: [], dayTimes: {} },
                        frequencies: [],
                        chapters: [{ name: '', description: '', referencePdf: undefined, assignmentPdf: undefined }],
                        referralCode: '',
                        commissionRate: '',
                        referralStart: '',
                        referralEnd: '',
                        referralStatus: 'Inactive',
                        faqs: [{ question: '', answer: '', isEditing: false }],
                        reminderSettings: {
                          pushEnabled: true,
                          emailEnabled: true,
                          smsEnabled: true,
                          customSchedule: [],
                          frequency: '',
                          customDays: '',
                          customInterval: '',
                        },
                        freeGifts: [],
                        status: "Active",
                        courseCategory: "Regular",
                      });
                    }}
                  >
                    <FileText className="mr-2 h-4 w-4" />
                    Save Draft
                  </Button>
                )}
              </div>
              <DialogDescription>
                {isEditMode 
                  ? 'Modify the existing course details'
                  : 'Create a comprehensive course with all advanced features' 
                }
              </DialogDescription>
            </DialogHeader>

            <Tabs defaultValue="basic" className="w-full">
              <TabsList className="grid w-full grid-cols-7 gap-2">
                <TabsTrigger value="basic" className="border border-gray-300 rounded-lg data-[state=active]:bg-orange-500 data-[state=active]:text-white data-[state=active]:font-bold">Basic Info</TabsTrigger>
                <TabsTrigger value="chapters" className="border border-gray-300 rounded-lg data-[state=active]:bg-orange-500 data-[state=active]:text-white data-[state=active]:font-bold">Chapters</TabsTrigger>
                <TabsTrigger value="schedule" className="border border-gray-300 rounded-lg data-[state=active]:bg-orange-500 data-[state=active]:text-white data-[state=active]:font-bold">Schedule</TabsTrigger>
                <TabsTrigger value="pricing" className="border border-gray-300 rounded-lg data-[state=active]:bg-orange-500 data-[state=active]:text-white data-[state=active]:font-bold">Pricing</TabsTrigger>
                <TabsTrigger value="content" className="border border-gray-300 rounded-lg data-[state=active]:bg-orange-500 data-[state=active]:text-white data-[state=active]:font-bold">Content <span title="Coming Soon"> üîú</span></TabsTrigger>
                <TabsTrigger value="settings" className="border border-gray-300 rounded-lg data-[state=active]:bg-orange-500 data-[state=active]:text-white data-[state=active]:font-bold">Settings <span title="Coming Soon"> üîú</span></TabsTrigger>
                <TabsTrigger value="marketing" className="border border-gray-300 rounded-lg data-[state=active]:bg-orange-500 data-[state=active]:text-white data-[state=active]:font-bold">Marketing <span title="Coming Soon"> üîú</span></TabsTrigger>
              </TabsList>
  
            
              <TabsContent value="basic" className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  
                  
                  {/* Course ID (read-only, only if editing or available) */}
                  {newCourseForm.id && newCourseForm.id !== '' && (
                    <div>
                      <Label htmlFor="courseId">Course ID</Label>
                      <Input id="courseId" value={newCourseForm.id} readOnly className="bg-gray-100 cursor-not-allowed border border-gray-300 rounded-md px-3 py-2" />
                    </div>
                  )}
                  <div>
                    <Label htmlFor="courseName">Course Name <span className="text-red-500">*</span></Label>
                    <Input
                      id="courseName"
                      placeholder="Enter course name"
                      value={newCourseForm.name}
                      onChange={e => setNewCourseForm(f => ({ ...f, name: e.target.value }))}
                      className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    />
                  </div>
<div>
                    <Label htmlFor="status">Course Status <span className="text-red-500">*</span></Label>
                    <select
                      id="status"
                      className="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      value={newCourseForm.status}
                      onChange={e => setNewCourseForm(f => ({ ...f, status: e.target.value as "Active" | "Upcoming" | "Completed" | "Draft" }))}
                    >
                      <option value="Active">Active</option>
                      <option value="Upcoming">Upcoming</option>
                      <option value="Completed">Completed</option>
                      <option value="Draft">Draft</option>
                    </select>
                  </div>
                  <div>
                    <Label htmlFor="instructor">Instructor <span className="text-red-500">*</span></Label>
                    <select
                      id="instructor"
                      className="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      value={newCourseForm.instructor}
                      onChange={e => setNewCourseForm(f => ({ ...f, instructor: e.target.value }))}
                    >
                      <option value="">Select instructor</option>
                      {instructorOptions.map(opt => (
                        <option key={opt.id} value={opt.name}>{opt.name}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <Label htmlFor="location">Location</Label>
                    <select
                      id="location"
                      className="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      value={newCourseForm.location || ''}
                      onChange={e => setNewCourseForm(f => ({ ...f, location: e.target.value }))}
                    >
                      <option value="">Select location</option>
                      <option value="Studio A">Studio A</option>
                      <option value="Pool Area">Pool Area</option>
                      <option value="Music Room">Music Room</option>
                      <option value="Classroom 101">Classroom 101</option>
                      <option value="Basketball Court">Basketball Court</option>
                      <option value="Dance Studio">Dance Studio</option>
                      <option value="Virtual - Zoom">Virtual - Zoom</option>
                      <option value="Virtual - Microsoft Teams">Virtual - Microsoft Teams</option>
                      <option value="Virtual - Google Meet">Virtual - Google Meet</option>
                      <option value="Virtual - WebEx">Virtual - WebEx</option>
                      <option value="Virtual - Other">Virtual - Other</option>
                    </select>
                  </div>
                  <div>
                    <Label htmlFor="maxStudents">Max No. of Students <span className="text-red-500">*</span></Label>
                    <Input
                      id="maxStudents"
                      type="number"
                      min="1"
                      value={newCourseForm.maxStudents}
                      onChange={e => setNewCourseForm(f => ({ ...f, maxStudents: e.target.value.replace(/[^\d]/g, '') }))}
                      className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    />
                  </div>
                </div>

                <div>
                  <Label htmlFor="description">Description <span className="text-red-500">*</span></Label>
                  <Textarea
                    id="description"
                    placeholder="Describe your course in detail..."
                    rows={4}
                    value={newCourseForm.description}
                    onChange={e => setNewCourseForm(f => ({ ...f, description: e.target.value }))}
                    className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <Label htmlFor="level">Course Level <span className="text-red-500">*</span></Label>
                    <select
                      id="level"
                      className="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      value={newCourseForm.level}
                      onChange={e => setNewCourseForm(f => ({ ...f, level: e.target.value }))}
                    >
                      <option value="">Select level</option>
                      <option value="Beginner">Beginner</option>
                      <option value="Intermediate">Intermediate</option>
                      <option value="Advanced">Advanced</option>
                      <option value="Expert">Expert</option>
                      <option value="Pro">Pro</option>
                    </select>
                  </div>
                  <div>
                    <Label htmlFor="type">Course Type <span className="text-red-500">*</span></Label>
                    <select
                      id="type"
                      className="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      value={newCourseForm.type}
                      onChange={e => setNewCourseForm(f => ({ ...f, type: e.target.value }))}
                    >
                      <option value="">Select type</option>
                      {courseTypeOptions.map(opt => (
                        <option key={opt} value={opt}>{opt}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <Label htmlFor="courseCategory">Course Category <span className="text-red-500">*</span></Label>
                    <select
                      id="courseCategory"
                      className="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      value={newCourseForm.courseCategory}
                      onChange={e => setNewCourseForm(f => ({ ...f, courseCategory: e.target.value === "Regular" ? "Regular" : "Special" }))}
                    >
                      <option value="Regular">Regular</option>
                      <option value="Special">Special</option>
                    </select>
                  </div>
                </div>

<div>
  <div>
    <Label htmlFor="tags">Tags <span className="text-red-500">*</span></Label>
  </div>
  <DropdownMenu>
    <DropdownMenuTrigger asChild>
      <div className="mt-2">
        <Button
          variant="outline"
          className="text-left"
          style={{
            minWidth: '120px',
            width: newCourseForm.tags.length === 0
              ? '120px'
              : `${Math.min(480, 120 + newCourseForm.tags.join(', ').length * 8)}px`,
            maxWidth: '100%',
            whiteSpace: 'nowrap',
            overflow: 'hidden',
            textOverflow: 'ellipsis',
            transition: 'width 0.2s',
            display: 'inline-flex',
            alignItems: 'center',
          }}
        >
          {newCourseForm.tags.length > 0
            ? <span style={{wordBreak: 'break-word'}}>{newCourseForm.tags.join(', ')}</span>
            : 'Select tags'}
        </Button>
      </div>
    </DropdownMenuTrigger>
    <DropdownMenuContent className="w-64 p-2">
                      <div className="flex items-center mb-2 gap-2">
                        <Input
                          placeholder="Search tags..."
                          className="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          value={searchTerm}
                          onChange={e => setSearchTerm(e.target.value)}
                        />
                        <Button
                          variant="ghost"
                          size="sm"
                          className="text-xs px-2 py-1 border border-gray-300"
                          onClick={() => setNewCourseForm((f: typeof newCourseForm) => ({ ...f, tags: [] }))}
                          disabled={newCourseForm.tags.length === 0}
                        >
                          Clear All
                        </Button>
                      </div>
                      <div
                        style={{
                          minHeight: '32px',
                          maxHeight:
                            (newCourseForm.tags.length + tagOptions.length) <= 2
                              ? '48px'
                              : `${Math.min(160, (newCourseForm.tags.length + tagOptions.length) * 32)}px`,
                          overflowY: (newCourseForm.tags.length + tagOptions.length) > 4 ? 'auto' : 'visible',
                          transition: 'max-height 0.2s',
                        }}
                        className="overflow-y-auto"
                      >
                        {tagOptions
                          .filter((tag: string) => tag.toLowerCase().includes(searchTerm.toLowerCase()))
                          .map((tag: string) => (
                            <div key={tag} className="flex items-center gap-2 py-1">
                              <Checkbox
                                checked={newCourseForm.tags.includes(tag)}
                                onCheckedChange={(checked: boolean) => {
                                  setNewCourseForm((f: typeof newCourseForm) => ({
                                    ...f,
                                    tags: checked
                                      ? [...f.tags, tag]
                                      : f.tags.filter((t: string) => t !== tag)
                                  }))
                                }}
                                id={`tag-${tag}`}
                              />
                              <Label htmlFor={`tag-${tag}`}>{tag}</Label>
                            </div>
                          ))}
                        {/* Show user-added tags (not in tagOptions) with delete option */}
                        {newCourseForm.tags
                          .filter((tag: string) => !tagOptions.includes(tag) && tag.toLowerCase().includes(searchTerm.toLowerCase()))
                          .map((tag: string) => (
                            <div key={tag} className="flex items-center gap-2 py-1">
                              <Checkbox
                                checked={newCourseForm.tags.includes(tag)}
                                onCheckedChange={(checked: boolean) => {
                                  setNewCourseForm((f: typeof newCourseForm) => ({
                                    ...f,
                                    tags: checked
                                      ? [...f.tags, tag]
                                      : f.tags.filter((t: string) => t !== tag)
                                  }))
                                }}
                                id={`tag-user-${tag}`}
                              />
                              <Label htmlFor={`tag-user-${tag}`}>{tag}</Label>
                            </div>
                          ))}
                        {tagOptions.filter((tag: string) => tag.toLowerCase().includes(searchTerm.toLowerCase())).length === 0 && searchTerm.trim() !== '' && (
                          <div className="flex items-center gap-2 py-1">
                            <Button
                              variant="ghost"
                              size="sm"
                              className="px-2 py-1"
                              onClick={() => {
                                setNewCourseForm((f: typeof newCourseForm) => ({
                                  ...f,
                                  tags: [...f.tags, searchTerm.trim()]
                                }));
                              }}
                            >
                              Add "{searchTerm.trim()}" as new tag
                            </Button>
                          </div>
                        )}
                      </div>
                    </DropdownMenuContent>
                  </DropdownMenu>
                  <div className="text-xs text-gray-500 mt-1">Select one or more tags.</div>
                </div>



                <Separator />
                
                {/* Duration and Schedule Fields */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="duration">Course Duration <span className="text-red-500">*</span></Label>
                    <Input
                      id="duration"
                      placeholder="e.g., 12 weeks, 3 months"
                      value={newCourseForm.duration}
                      onChange={e => setNewCourseForm(f => ({ ...f, duration: e.target.value }))}
                      className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    />
                  </div>
                  <div>
                    <Label htmlFor="schedule">Course Schedule <span className="text-red-500">*</span></Label>
                    <Input
                      id="schedule"
                      placeholder="e.g., Mon-Fri 9AM-11AM, Weekends"
                      value={newCourseForm.schedule}
                      onChange={e => setNewCourseForm(f => ({ ...f, schedule: e.target.value }))}
                      className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    />
                  </div>
                </div>

                <Separator />

                

                <div className="space-y-4">
                  <h4 className="font-medium">Course Guidelines & Instructions</h4>

                    
                  <div>
                    
                    <Textarea id="studentGuidelines" placeholder="Student Guidelines or Any special instructions for the course ..." rows={2} className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
                  </div>
                  <div>
                    <Label htmlFor="freeGifts">Free Gifts</Label>
                  </div>
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <div className="mt-2">
                        <Button
                          variant="outline"
                          className="text-left"
                          style={{
                            minWidth: '120px',
                            width: newCourseForm.freeGifts?.length === 0
                              ? '120px'
                              : `${Math.min(480, 120 + (newCourseForm.freeGifts || []).join(', ').length * 8)}px`,
                            maxWidth: '100%',
                            whiteSpace: 'nowrap',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            transition: 'width 0.2s',
                            display: 'inline-flex',
                            alignItems: 'center',
                          }}
                        >
                          {(newCourseForm.freeGifts && newCourseForm.freeGifts.length > 0)
                            ? <span style={{wordBreak: 'break-word'}}>{newCourseForm.freeGifts.join(', ')}</span>
                            : 'Select free gifts'}
                        </Button>
                      </div>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent className="w-64 p-2">
                      <div className="flex items-center mb-2 gap-2">
                        <Input
                          placeholder="Search gifts..."
                          className="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          value={freeGiftSearchTerm}
                          onChange={e => setFreeGiftSearchTerm(e.target.value)}
                        />
                        <Button
                          variant="ghost"
                          size="sm"
                          className="text-xs px-2 py-1 border border-gray-300"
                          onClick={() => setNewCourseForm(f => ({ ...f, freeGifts: [] }))}
                          disabled={!(newCourseForm.freeGifts && newCourseForm.freeGifts.length)}
                        >
                          Clear All
                        </Button>
                      </div>
                      <div
                        style={{
                          minHeight: '32px',
                          maxHeight:
                            ((newCourseForm.freeGifts?.length || 0) + freeGiftOptions.length) <= 2
                              ? '48px'
                              : `${Math.min(160, ((newCourseForm.freeGifts?.length || 0) + freeGiftOptions.length) * 32)}px`,
                          overflowY: ((newCourseForm.freeGifts?.length || 0) + freeGiftOptions.length) > 4 ? 'auto' : 'visible',
                          transition: 'max-height 0.2s',
                        }}
                        className="overflow-y-auto"
                      >
                        {freeGiftOptions
                          .filter(gift => gift.toLowerCase().includes(freeGiftSearchTerm.toLowerCase()))
                          .map(gift => (
                            <div key={gift} className="flex items-center gap-2 py-1">
                              <Checkbox
                                checked={newCourseForm.freeGifts?.includes(gift)}
                                onCheckedChange={checked => {
                                  setNewCourseForm(f => ({
                                    ...f,
                                    freeGifts: checked
                                      ? [...(f.freeGifts || []), gift]
                                      : (f.freeGifts || []).filter(t => t !== gift)
                                  }))
                                }}
                                id={`gift-${gift}`}
                              />
                              <Label htmlFor={`gift-${gift}`}>{gift}</Label>
                            </div>
                          ))}
                        {/* Show user-added gifts (not in freeGiftOptions) with delete option */}
                        {(newCourseForm.freeGifts || [])
                          .filter(gift => !freeGiftOptions.includes(gift) && gift.toLowerCase().includes(freeGiftSearchTerm.toLowerCase()))
                          .map(gift => (
                            <div key={gift} className="flex items-center gap-2 py-1">
                              <Checkbox
                                checked={newCourseForm.freeGifts?.includes(gift)}
                                onCheckedChange={checked => {
                                  setNewCourseForm(f => ({
                                    ...f,
                                    freeGifts: checked
                                      ? [...(f.freeGifts || []), gift]
                                      : (f.freeGifts || []).filter(t => t !== gift)
                                  }))
                                }}
                                id={`gift-user-${gift}`}
                              />
                              <Label htmlFor={`gift-user-${gift}`}>{gift}</Label>
                            </div>
                          ))}
                        {freeGiftOptions.filter(gift => gift.toLowerCase().includes(freeGiftSearchTerm.toLowerCase())).length === 0 && freeGiftSearchTerm.trim() !== '' && (
                          <div className="flex items-center gap-2 py-1">
                            <Button
                              variant="ghost"
                              size="sm"
                              className="px-2 py-1"
                              onClick={() => {
                                setNewCourseForm(f => ({
                                  ...f,
                                  freeGifts: [...(f.freeGifts || []), freeGiftSearchTerm.trim()]
                                }));
                              }}
                            >
                              Add "{freeGiftSearchTerm.trim()}" as new gift
                            </Button>
                          </div>
                        )}
                      </div>
                    </DropdownMenuContent>
                  </DropdownMenu>
                  <div className="text-xs text-gray-500 mt-1">Select one or more free gifts.</div>

                  

                

                
                  
                  {/* FAQ Section */}
                <div className="space-y-4">
                  <h4 className="font-medium">Frequently Asked Questions 
                  <Button className="absolute right-6"
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => setNewCourseForm(f => ({ ...f, faqs: [...f.faqs, { question: '', answer: '', isEditing: true }] }))}
                  >+ Add FAQ</Button>
                  </h4>
                  {newCourseForm.faqs.map((faq, idx) => (
                    <div key={idx} className="border rounded-md p-3 mb-2 relative">
                      {faq.isEditing ? (
                        <>
                          {/* Save/Delete icons in top right */}
                          <div className="absolute top-0 right-2 flex gap-2 z-10">
                            <Button
                              type="button"
                              variant="ghost"
                              size="sm"
                              onClick={() => {
                                const updated = [...newCourseForm.faqs];
                                updated[idx].isEditing = false;
                                setNewCourseForm(f => ({ ...f, faqs: updated }));
                              }}
                            >
                              <Save className="h-4 w-4" />
                            </Button>
                            <Button
                              type="button"
                              variant="ghost"
                              size="sm"
                              className="text-red-500"
                              onClick={() => {
                                showDeleteConfirmation(
                                  "Remove FAQ",
                                  "Are you sure you want to remove this FAQ?",
                                  () => {
                                    setNewCourseForm(f => ({ ...f, faqs: f.faqs.filter((_, i) => i !== idx) }));
                                  },
                                  faq.question || "Untitled FAQ"
                                );
                              }}
                            >
                              <span role="img" aria-label="Remove">‚ùå</span>
                            </Button>
                          </div>
                          <Label>Question</Label>
                          <Input
                            value={faq.question}
                            onChange={e => {
                              const updated = [...newCourseForm.faqs];
                              updated[idx].question = e.target.value;
                              setNewCourseForm(f => ({ ...f, faqs: updated }));
                            }}
                            placeholder="Enter FAQ question"
                            className="mb-2 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          />
                          <Label>Answer</Label>
                          <Textarea
                            value={faq.answer}
                            onChange={e => {
                              const updated = [...newCourseForm.faqs];
                              updated[idx].answer = e.target.value;
                              setNewCourseForm(f => ({ ...f, faqs: updated }));
                            }}
                            placeholder="Enter FAQ answer"
                            rows={2}
                            className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          />
                        </>
                      ) : (
                        <>
                          {/* Edit/Delete icons in top right */}
                          <div className="absolute top-0 right-2 flex gap-2 z-10">
                            <Button
                              type="button"
                              variant="ghost"
                              size="sm"
                              onClick={() => {
                                const updated = [...newCourseForm.faqs];
                                updated[idx].isEditing = true;
                                setNewCourseForm(f => ({ ...f, faqs: updated }));
                              }}
                            >
                              <span role="img" aria-label="Edit">‚úèÔ∏è</span>
                            </Button>
                            <Button
                              type="button"
                              variant="ghost"
                              size="sm"
                              className="text-red-500"
                              onClick={() => {
                                showDeleteConfirmation(
                                  "Remove FAQ",
                                  "Are you sure you want to remove this FAQ?",
                                  () => {
                                    setNewCourseForm(f => ({ ...f, faqs: f.faqs.filter((_, i) => i !== idx) }));
                                  },
                                  faq.question || "Untitled FAQ"
                                );
                              }}
                            >
                              <span role="img" aria-label="Remove">‚ùå</span>
                            </Button>
                          </div>
                          <div className="mb-2"><strong>Q:</strong> {faq.question}</div>
                          <div className="mb-2"><strong>A:</strong> {faq.answer}</div>
                        </>
                      )}
                    </div>
                  ))}
                  
                </div>
                </div>
              </TabsContent>

              <TabsContent value="content" className="space-y-4">
                <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p className="text-sm text-blue-700 text-center italic">
                    Coming Soon
                  </p>
                </div>
                <div className="space-y-4">
                  <h4 className="font-medium">Content Formats</h4>

                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div className="flex items-center space-x-2">
                      <Checkbox id="video" />
                      <Label htmlFor="video" className="flex items-center gap-2">
                        <Video className="h-4 w-4" />
                        Video Content
                      </Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Checkbox id="podcast" />
                      <Label htmlFor="podcast" className="flex items-center gap-2">
                        <Headphones className="h-4 w-4" />
                        Podcasts
                      </Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Checkbox id="interactive-pdf" />
                      <Label htmlFor="interactive-pdf" className="flex items-center gap-2">
                        <FileText className="h-4 w-4" />
                        Interactive PDFs
                      </Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Checkbox id="ar-vr" />
                      <Label htmlFor="ar-vr" className="flex items-center gap-2">
                        <Eye className="h-4 w-4" />
                        AR/VR Content
                      </Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Checkbox id="simulation" />
                      <Label htmlFor="simulation" className="flex items-center gap-2">
                        <Zap className="h-4 w-4" />
                        Simulations
                      </Label>
                    </div>
                  </div>
                </div>

                <Separator />

                <div className="space-y-4">
                  <h4 className="font-medium">Video Player Settings</h4>

                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="flex items-center space-x-2">
                      <Switch id="speedControl" />
                      <Label htmlFor="speedControl">Speed Control</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="downloadEnabled" />
                      <Label htmlFor="downloadEnabled">Download</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="subtitles" />
                      <Label htmlFor="subtitles">Subtitles</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="chapters" />
                      <Label htmlFor="chapters">Chapters</Label>
                    </div>
                  </div>
                </div>

                <Separator />

                <div className="space-y-4">
                  <h4 className="font-medium">Microlearning Modules</h4>
                  <p className="text-sm text-gray-600">Break course into 5-10 minute modules</p>

                  <div className="flex items-center space-x-2">
                    <Switch id="enableMicrolearning" />
                    <Label htmlFor="enableMicrolearning">Enable Microlearning</Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Switch id="adaptiveContent" />
                    <Label htmlFor="adaptiveContent">Adaptive Content Delivery</Label>
                  </div>
                </div>
              </TabsContent>

              <TabsContent value="pricing" className="space-y-4">
                <div className="max-w-md">
                  <div>
                    <Label htmlFor="priceINR">Price (INR) <span className="text-red-500">*</span></Label>
                    <div className="relative">
                      
                      <Input
                        id="priceINR"
                        type="number"
                        min="0"
                        placeholder="25000"
                        className="pl-10 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        value={newCourseForm.priceINR}
                        onChange={e => setNewCourseForm(f => ({ ...f, priceINR: e.target.value.replace(/[^\d]/g, '') }))}
                      />
                    </div>
                  </div>
                </div>

                

                <Separator />

                

                <div className="space-y-4">
                  <h4 className="font-medium">Affiliate Tracking</h4>

                  <div className="flex items-center space-x-2">
                    <Switch id="enableAffiliate" />
                    <Label htmlFor="enableAffiliate">Enable Affiliate Tracking</Label>
                  </div>

                  {/* Referral Code Dropdown - Only active codes */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="referralCode">Referral Code</Label>
                      <select
                        id="referralCode"
                        className="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        value={newCourseForm.referralCode || ''}
                        onChange={e => {
                          const selectedCode = e.target.value;
                          // Find mock data for selected code
                          const mock = mockReferralCodes.find(r => r.code === selectedCode);
                          // Example mock data for demonstration
                          // In real use, these would come from your backend or a more complete mockReferralCodes array
                          let commissionRate = '';
                          let referralStart = '';
                          let referralEnd = '';
                          if (mock) {
                            // Example: hardcoded values for demo, replace with real data as needed
                            if (mock.code === 'ART2024') {
                              commissionRate = '10';
                              referralStart = '2025-08-01T09:00';
                              referralEnd = '2025-08-31T23:59';
                            } else if (mock.code === 'PAINT50') {
                              commissionRate = '15';
                              referralStart = '2025-09-01T09:00';
                              referralEnd = '2025-09-30T23:59';
                            } else if (mock.code === 'NEWUSER10') {
                              commissionRate = '5';
                              referralStart = '2025-07-01T09:00';
                              referralEnd = '2025-07-31T23:59';
                            } else if (mock.code === 'SUMMER25') {
                              commissionRate = '8';
                              referralStart = '2025-06-01T09:00';
                              referralEnd = '2025-06-30T23:59';
                            } else if (mock.code === 'DIWALI2025') {
                              commissionRate = '20';
                              referralStart = '2025-10-15T09:00';
                              referralEnd = '2025-11-15T23:59';
                            }
                          }
                          setNewCourseForm(f => ({
                            ...f,
                            referralCode: selectedCode,
                            commissionRate,
                            referralStart,
                            referralEnd
                          }));
                        }}
                      >
                        <option value="">Select Referral Code</option>
                        {/* Only show active referral codes (mock + from courses) */}
                        {[
                          ...mockReferralCodes.filter(r => r.status === 'Active').map(r => r.code),
                          ...((Array.isArray(courses) ? courses : [])
                            .flatMap(c => c.affiliateTracking && c.affiliateTracking.enabled && (c.affiliateTracking as any).status === 'Active' ? [c.affiliateTracking.referralCode] : [])
                            .filter((v, i, arr) => v && arr.indexOf(v) === i))
                        ]
                          .filter((v, i, arr) => v && arr.indexOf(v) === i)
                          .map(code => (
                            <option key={code} value={code}>{code}</option>
                          ))}
                      </select>
                    </div> 
                    <div>
                      <Label htmlFor="commissionRate">Commission Rate (%)</Label>
                      <Input
                        id="commissionRate"
                        placeholder="10"
                        type="number"
                        min="0"
                        max="100"
                        value={newCourseForm.commissionRate || ''}
                        onChange={e => setNewCourseForm(f => ({ ...f, commissionRate: e.target.value.replace(/[^\d.]/g, '') }))}
                        className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      />
                    </div>
                  </div>

                  {/* Set Referral Code Start/End Date & Time */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                      <Label htmlFor="referralStart">Referral Start Date & Time</Label>
                      <Input
                        id="referralStart"
                        type="datetime-local"
                        value={newCourseForm.referralStart || ''}
                        onChange={e => setNewCourseForm(f => ({ ...f, referralStart: e.target.value }))}
                        className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      />
                    </div>
                    <div>
                      <Label htmlFor="referralEnd">Referral End Date & Time</Label>
                      <Input
                        id="referralEnd"
                        type="datetime-local"
                        value={newCourseForm.referralEnd || ''}
                        onChange={e => setNewCourseForm(f => ({ ...f, referralEnd: e.target.value }))}
                        className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      />
                    </div>
                  </div>
                </div>
                <Separator />

                <div className="space-y-4">
                  <h4 className="font-medium">Dynamic Pricing <span title="Coming Soon"> üîú</span></h4>

                  <div className="flex items-center space-x-2">
                    <Switch id="enableDynamicPricing" disabled/>
                    <Label htmlFor="enableDynamicPricing">Enable Dynamic Pricing</Label>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <Label htmlFor="demandMultiplier">Demand Multiplier</Label>
                      <Input disabled id="demandMultiplier" placeholder="1.2" type="number" step="0.1" />
                    </div>
                    <div>
                      <Label htmlFor="performanceBonus">Performance Bonus</Label>
                      <Input disabled id="performanceBonus" placeholder="0.1" type="number" step="0.1" />
                    </div>
                    <div>
                      <Label htmlFor="enrollmentThreshold">Enrollment Threshold</Label>
                      <Input disabled id="enrollmentThreshold" placeholder="18" type="number" />
                    </div>
                  </div>
                </div>

                <Separator />

                <div className="space-y-4">
                  <h4 className="font-medium">EMI Plans <span title="Coming Soon"> üîú</span></h4>

                  <div className="space-y-3">
                    <div className="border rounded-lg p-4">
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                          <Label htmlFor="emi3Name">Plan Name</Label>
                          <Input disabled id="emi3Name" placeholder="3-Month Plan" />
                        </div>
                        <div>
                          <Label htmlFor="emi3Installments">Installments</Label>
                          <Input disabled  id="emi3Installments" placeholder="3" type="number" />
                        </div>
                        <div>
                          <Label htmlFor="emi3Interest">Interest Rate (%)</Label>
                          <Input disabled id="emi3Interest" placeholder="0" type="number" step="0.1" />
                        </div>
                        <div>
                          <Label htmlFor="emi3Processing">Processing Fee</Label>
                          <Input disabled id="emi3Processing" placeholder="99" type="number" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <Button variant="outline" size="sm">
                    <Plus className="mr-2 h-4 w-4" />
                    Add EMI Plan <span title="Coming Soon"> üîú</span>
                  </Button>
                </div>
              </TabsContent>

              <TabsContent value="schedule" className="space-y-4">
                {/* Schedule Period */}
                <div className="mb-4">
                  <h4 className="font-medium mb-2">Schedule Period</h4>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <Label>Start Date</Label>
                      <Input
                        type="date"
                        value={newCourseForm.schedulePeriod.startDate}
                        onChange={e => {
                          setNewCourseForm(f => ({
                            ...f,
                            schedulePeriod: { ...f.schedulePeriod, startDate: e.target.value }
                          }))
                          setSchedulePeriod(p => ({ ...p, startDate: e.target.value }))
                        }}
                        className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      />
                    </div>
                    <div>
                      <Label>End Date</Label>
                      <Input
                        type="date"
                        value={newCourseForm.schedulePeriod.endDate}
                        onChange={e => {
                          setNewCourseForm(f => ({
                            ...f,
                            schedulePeriod: { ...f.schedulePeriod, endDate: e.target.value }
                          }))
                          setSchedulePeriod(p => ({ ...p, endDate: e.target.value }))
                        }}
                        className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                      />
                    </div>
                    <div>
                      <Label>Course Duration (weeks)</Label>
                      <Input
                        type="number"
                        min="1"
                        value={newCourseForm.schedulePeriod.totalWeeks}
                        readOnly
                        className="bg-gray-100 cursor-not-allowed border border-gray-300 rounded-md px-3 py-2"
                      />
                    </div>
                  </div>
                </div>

                {/* Session Details */}
                <div className="mb-4">
                  <h4 className="font-medium mb-2">Session Details</h4>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <Label>Session Duration (hours)</Label>
                      <Input type="number" min="0.5" step="0.5" value={newCourseForm.sessionDetails.sessionDuration} onChange={e => {
                        const value = parseFloat(e.target.value);
                        if (value >= 0.5 || e.target.value === '') {
                          setNewCourseForm(f => ({ ...f, sessionDetails: { ...f.sessionDetails, sessionDuration: e.target.value } }));
                        }
                      }} className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
                    </div>
                    <div>
                      <Label>Max Sessions in a week</Label>
                      <Input type="number" min="1" value={newCourseForm.sessionDetails.maxClasses} onChange={e => setNewCourseForm(f => ({ ...f, sessionDetails: { ...f.sessionDetails, maxClasses: e.target.value.replace(/[^\d]/g, '') } }))} className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
                    </div>
                    
                  </div>
                </div>

                {/* Schedule Frequency - New UI: Select multiple days with checkboxes and per-day settings */}
                <div className="mb-4">
                  <h4 className="font-medium mb-2">Schedule Frequencies</h4>
                  {(newCourseForm.frequencies && newCourseForm.frequencies.length > 0)
                    ? newCourseForm.frequencies.map((freq, idx) => (
                        <div key={idx} className="border rounded-lg p-4 bg-gray-50 mb-4 relative">
                          <TooltipProvider>
                            <Tooltip>
                              <TooltipTrigger asChild>
                                <button
                                  type="button"
                                  className="absolute top-2 right-2 text-red-500 hover:text-red-700"
                                  onClick={() => {
                                    showDeleteConfirmation(
                                      "Remove Frequency",
                                      "Are you sure you want to remove this frequency schedule?",
                                      () => {
                                        setNewCourseForm(f => ({
                                          ...f,
                                          frequencies: f.frequencies.filter((_, i) => i !== idx)
                                        }))
                                      },
                                      `Schedule ${idx + 1}`
                                    );
                                  }}
                                  aria-label="Remove Frequency"
                                >
                                  <X className="h-4 w-4" />
                                </button>
                              </TooltipTrigger>
                              <TooltipContent>Remove Frequency</TooltipContent>
                            </Tooltip>
                          </TooltipProvider>
                          <div className="flex flex-wrap gap-4 mb-4">
                            {['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map(day => (
                              <label key={day} className="flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  checked={freq.days.includes(day)}
                                  onChange={e => {
                                    const checked = e.target.checked;
                                    setNewCourseForm(f => {
                                      const updated = f.frequencies.map((fr, i) =>
                                        i === idx
                                          ? {
                                              ...fr,
                                              days: checked
                                                ? [...fr.days, day]
                                                : fr.days.filter(d => d !== day)
                                            }
                                          : fr
                                      );
                                      return { ...f, frequencies: updated };
                                    });
                                  }}
                                />
                                {day}
                              </label>
                            ))}
                          </div>
                          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                              <Label>Start Time</Label>
                              <Input
                                type="time"
                                value={freq.start || ''}
                                onChange={e => setNewCourseForm(f => {
                                  const updated = f.frequencies.map((fr, i) =>
                                    i === idx ? { ...fr, start: e.target.value } : fr
                                  );
                                  return { ...f, frequencies: updated };
                                })}
                                className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                              />
                            </div>
                            <div>
                              <Label>End Time</Label>
                              <Input
                                type="time"
                                value={freq.end || ''}
                                onChange={e => setNewCourseForm(f => {
                                  const updated = f.frequencies.map((fr, i) =>
                                    i === idx ? { ...fr, end: e.target.value } : fr
                                  );
                                  return { ...f, frequencies: updated };
                                })}
                                className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                              />
                            </div>
                            <div>
                              <Label>Sessions (per day)</Label>
                              <Input
                                type="number"
                                min="1"
                                value={freq.sessions || ''}
                                onChange={e => setNewCourseForm(f => {
                                  const updated = f.frequencies.map((fr, i) =>
                                    i === idx ? { ...fr, sessions: e.target.value } : fr
                                  );
                                  return { ...f, frequencies: updated };
                                })}
                                className="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                              />
                            </div>
                          </div>
                        </div>
                      ))
                    : (
                        <div className="border rounded-lg p-4 bg-gray-50 mb-4 relative">
                          <div className="mb-2 font-medium">No frequencies added yet.</div>
                        </div>
                    )}
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => setNewCourseForm(f => ({
                      ...f,
                      frequencies: [
                        ...(f.frequencies || []),
                        { days: [], start: '', end: '', sessions: '' }
                      ]
                    }))}
                  >
                    + Add Frequency
                  </Button>
                </div>

                <Separator />

                {/* Notification Settings (existing) */}
                <div className="space-y-4">
                  
                                  {/* Reminder Schedule Section */}
                <div className="space-y-4">
                  <h4 className="font-medium">Reminder Schedule</h4>
                  {(!newCourseForm.frequencies || newCourseForm.frequencies.length === 0) ? (
                    <div className="text-red-600 mb-2">Please add at least one schedule frequency before adding reminder schedules.</div>
                  ) : (
                    <>
                      {newCourseForm.reminderSettings.customSchedule.map((reminder, idx) => (
                        <div key={idx} className="border rounded-md p-3 mb-2 flex flex-row gap-4 items-center relative">
                          <select
                            value={reminder.type}
                            onChange={e => {
                              const updated = [...newCourseForm.reminderSettings.customSchedule];
                              updated[idx].type = e.target.value;
                              // If switching away from 'other', clear customType
                              if (e.target.value !== 'other') updated[idx].customType = '';
                              setNewCourseForm(f => ({ ...f, reminderSettings: { ...f.reminderSettings, customSchedule: updated } }));
                            }}
                            className="w-full border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          >
                            <option value="class">Class</option>
                            <option value="other">Other</option>
                          </select>
                          {reminder.type === 'other' && (
                            <Input
                              type="text"
                              value={('customType' in reminder ? (reminder as any).customType : '')}
                              onChange={e => {
                                const updated = [...newCourseForm.reminderSettings.customSchedule];
                                (updated[idx] as any).customType = e.target.value;
                                setNewCourseForm(f => ({ ...f, reminderSettings: { ...f.reminderSettings, customSchedule: updated } }));
                              }}
                              placeholder="Reminder type"
                              className="w-40 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                          )}
                          <Input
                            type="number"
                            min="0"
                            value={reminder.daysBefore}
                            onChange={e => {
                              const updated = [...newCourseForm.reminderSettings.customSchedule];
                              updated[idx].daysBefore = e.target.value;
                              setNewCourseForm(f => ({ ...f, reminderSettings: { ...f.reminderSettings, customSchedule: updated } }));
                            }}
                            placeholder="Days before"
                            className="w-32 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          />
                          <Input
                            type="number"
                            min="0"
                            value={reminder.hoursBefore}
                            onChange={e => {
                              const updated = [...newCourseForm.reminderSettings.customSchedule];
                              updated[idx].hoursBefore = e.target.value;
                              setNewCourseForm(f => ({ ...f, reminderSettings: { ...f.reminderSettings, customSchedule: updated } }));
                            }}
                            placeholder="Hours before"
                            className="w-32 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          />
                          <Switch
                            checked={reminder.enabled}
                            onCheckedChange={checked => {
                              const updated = [...newCourseForm.reminderSettings.customSchedule];
                              updated[idx].enabled = checked;
                              setNewCourseForm(f => ({ ...f, reminderSettings: { ...f.reminderSettings, customSchedule: updated } }));
                            }}
                          />
                          <TooltipProvider>
                            <Tooltip>
                              <TooltipTrigger asChild>
                                <button
                                  type="button"
                                  className="absolute top-2 right-2 text-red-500 hover:text-red-700"
                                  style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}
                                  onClick={() => {
                                    showDeleteConfirmation(
                                      "Remove Reminder",
                                      "Are you sure you want to remove this reminder schedule?",
                                      () => {
                                        setNewCourseForm(f => ({
                                          ...f,
                                          reminderSettings: {
                                            ...f.reminderSettings,
                                            customSchedule: f.reminderSettings.customSchedule.filter((_, i) => i !== idx)
                                          }
                                        }))
                                      },
                                      `Reminder ${idx + 1}`
                                    );
                                  }}
                                  aria-label="Remove Reminder"
                                >
                                  <X className="h-4 w-4" />
                                </button>
                              </TooltipTrigger>
                              <TooltipContent>Remove Reminder</TooltipContent>
                            </Tooltip>
                          </TooltipProvider>
                        </div>
                      ))}
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => setNewCourseForm(f => ({
                          ...f,
                          reminderSettings: {
                            ...f.reminderSettings,
                            customSchedule: [
                              ...f.reminderSettings.customSchedule,
                              { type: 'class', daysBefore: '', hoursBefore: '', timeOfDay: '', enabled: true }
                            ]
                          }
                        }))}
                      >+ Add Reminder</Button>
                    </>
                  )}
                </div>
                 
                  <Separator />
<h4 className="font-medium">Notification Settings</h4>
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="flex items-center space-x-2">
                      <Switch id="pushNotifications" />
                      <Label htmlFor="pushNotifications" className="flex items-center gap-2">
                        <Smartphone className="h-4 w-4" />
                        In App 
                      </Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="smsNotifications" />
                      <Label htmlFor="smsNotifications" className="flex items-center gap-2">
                        <MessageCircle className="h-4 w-4" />
                        SMS 
                      </Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="whatsappNotifications" />
                      <Label htmlFor="whatsappNotifications" className="flex items-center gap-2">
                        <Smartphone className="h-4 w-4 text-green-500" />
                        WhatsApp 
                      </Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="emailNotifications" />
                      <Label htmlFor="emailNotifications" className="flex items-center gap-2">
                        <Mail className="h-4 w-4" />
                        Email 
                      </Label>
                    </div>
                                       
                  </div>

                </div>
              </TabsContent>

              <TabsContent value="chapters" className="space-y-4">
                <div className="mb-4">
                  <h4 className="font-medium mb-2">Course Chapters</h4>
                  <div className="flex items-center gap-4 mb-4">
                    <Label htmlFor="numChapters">Number of Chapters</Label>
                    <Input
                      id="numChapters"
                      type="number"
                      min="1"
                      value={newCourseForm.chapters?.length || 1}
                      onChange={e => {
                        const num = Math.max(1, parseInt(e.target.value) || 1);
                        setNewCourseForm(f => ({
                          ...f,
                          chapters: Array(num).fill(null).map((_, i) => f.chapters?.[i] || { name: '', description: '', referencePdf: undefined })
                        }));
                      }}
                      className="w-24 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    />
                    <Button
                      type="button"
                      variant="ghost"
                      size="sm"
                      className="ml-2 flex items-center gap-1"
                      onClick={() => document.getElementById('commonRefInput')?.click()}
                      title="Add Reference PDF for all chapters"
                    ><Plus className="h-4 w-4" /> Reference PDF</Button>
                    <input
                      id="commonRefInput"
                      type="file"
                      accept="application/pdf"
                      style={{ display: 'none' }}
                      onChange={e => {
                        const file = e.target.files?.[0];
                        if (file && file.type === 'application/pdf') {
                          toast({ title: 'Reference PDF added for all chapters!', description: file.name });
                          // Optionally store in state if needed
                        } else if (file) {
                          alert('Only PDF files are allowed.');
                        }
                      }}
                    />
                    <Button
                      type="button"
                      variant="ghost"
                      size="sm"
                      className="ml-2 flex items-center gap-1"
                      onClick={() => document.getElementById('commonAssignInput')?.click()}
                      title="Add Assignment PDF for all chapters"
                    ><Plus className="h-4 w-4" /> Assignment PDF</Button>
                    <input
                      id="commonAssignInput"
                      type="file"
                      accept="application/pdf"
                      style={{ display: 'none' }}
                      onChange={e => {
                        const file = e.target.files?.[0];
                        if (file && file.type === 'application/pdf') {
                          toast({ title: 'Assignment PDF added for all chapters!', description: file.name });
                          // Optionally store in state if needed
                        } else if (file) {
                          alert('Only PDF files are allowed.');
                        }
                      }}
                    />
                  </div>
                  <div className="mb-2 flex items-center gap-2">
                    <Label>Sub Chapters</Label>
                    <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded" title="Coming Soon">üîú</span>
                  </div>
                  <div className="space-y-2">
                    {/* Drag-and-drop chapters with full details */}
                    <div>
                      {/* Add drag-and-drop container */}
                      <div className="space-y-2" style={{ minHeight: '40px' }}>
                        {(newCourseForm.chapters || []).map((chapter, idx) => (
                          <div
                            key={idx}
                            className="border rounded-md p-2 mb-2 bg-white flex flex-col gap-1 cursor-move"
                            draggable
                            onDragStart={e => {
                              e.dataTransfer.setData('chapterIdx', idx.toString());
                            }}
                            onDragOver={e => e.preventDefault()}
                            onDrop={e => {
                              const fromIdx = Number(e.dataTransfer.getData('chapterIdx'));
                              if (fromIdx === idx) return;
                              const updated = [...(newCourseForm.chapters || [])];
                              const moved = updated.splice(fromIdx, 1)[0];
                              updated.splice(idx, 0, moved);
                              setNewCourseForm(f => ({ ...f, chapters: updated }));
                            }}
                          >
                            <div className="flex items-center gap-2">
                              <span className="font-bold">{idx + 1}</span>
                              <Label>Name</Label>
                              <Input
                                type="text"
                                value={chapter.name}
                                onChange={e => {
                                  const updated = [...(newCourseForm.chapters || [])];
                                  updated[idx] = { ...chapter, name: e.target.value };
                                  setNewCourseForm(f => ({ ...f, chapters: updated }));
                                }}
                                placeholder={`Name`}
                                className="w-40 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                              />
                              <Label>Description</Label>
                              <Textarea
                                value={chapter.description}
                                onChange={e => {
                                  const updated = [...(newCourseForm.chapters || [])];
                                  updated[idx] = { ...chapter, description: e.target.value };
                                  setNewCourseForm(f => ({ ...f, chapters: updated }));
                                }}
                                placeholder="Description"
                                className="w-40 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                rows={1}
                              />
                              <Button
                                type="button"
                                variant="ghost"
                                size="sm"
                                className="ml-2 flex items-center gap-1"
                                onClick={() => document.getElementById(`chapterRefInput${idx}`)?.click()}
                                title="Add Reference PDF"
                              ><Plus className="h-4 w-4" />Reference PDF</Button>
                              <input
                                id={`chapterRefInput${idx}`}
                                type="file"
                                accept="application/pdf"
                                style={{ display: 'none' }}
                                onChange={e => {
                                  const file = e.target.files?.[0];
                                  if (file && file.type === 'application/pdf') {
                                    const updated = [...(newCourseForm.chapters || [])];
                                    updated[idx] = { ...chapter, referencePdf: file };
                                    setNewCourseForm(f => ({ ...f, chapters: updated }));
                                    toast({ title: 'Reference PDF added!', description: file.name });
                                  } else if (file) {
                                    alert('Only PDF files are allowed.');
                                  }
                                }}
                              />
                              {chapter.referencePdf && (
                                <div className="flex items-center gap-2 bg-green-50 px-2 py-1 rounded-md">
                                  <span className="text-sm font-medium text-green-700">{chapter.referencePdf.name}</span>
                                </div>
                              )}
                              <Button
                                type="button"
                                variant="ghost"
                                size="sm"
                                className="ml-2 flex items-center gap-1"
                                onClick={() => document.getElementById(`chapterAssignInput${idx}`)?.click()}
                                title="Add Assignment PDF"
                              ><Plus className="h-4 w-4" />Assignment PDF</Button>
                              <input
                                id={`chapterAssignInput${idx}`}
                                type="file"
                                accept="application/pdf"
                                style={{ display: 'none' }}
                                onChange={e => {
                                  const file = e.target.files?.[0];
                                  if (file && file.type === 'application/pdf') {
                                    const updated = [...(newCourseForm.chapters || [])];
                                    updated[idx] = { ...chapter, assignmentPdf: file };
                                    setNewCourseForm(f => ({ ...f, chapters: updated }));
                                    toast({ title: 'Assignment PDF added!', description: file.name });
                                  } else if (file) {
                                    alert('Only PDF files are allowed.');
                                  }
                                }}
                              />
                              {chapter.assignmentPdf && (
                                <div className="flex items-center gap-2 bg-blue-50 px-2 py-1 rounded-md">
                                  <span className="text-sm font-medium text-blue-700">{chapter.assignmentPdf.name}</span>
                                </div>
                              )}
                              <TooltipProvider>
                                <Tooltip>
                                  <TooltipTrigger asChild>
                                    <button
                                      type="button"
                                      className="ml-auto text-red-500 hover:text-red-700 px-2 py-1 rounded-full"
                                      onClick={() => {
                                        showDeleteConfirmation(
                                          "Delete Chapter",
                                          "Are you sure you want to delete this chapter? This will remove all associated content and cannot be undone.",
                                          () => {
                                            setNewCourseForm(f => ({
                                              ...f,
                                              chapters: f.chapters.filter((_, i) => i !== idx)
                                            }));
                                          },
                                          chapter.name || `Chapter ${idx + 1}`
                                        );
                                      }}
                                      aria-label="Delete Chapter"
                                    >
                                      
                                      <X className="h-4 w-4" />
                                    </button>
                                  </TooltipTrigger>
                                  <TooltipContent>Delete Chapter</TooltipContent>
                                </Tooltip>
                              </TooltipProvider>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                  <div className="flex gap-2 mt-4 justify-end">
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={() => setNewCourseForm(f => ({ ...f, chapters: [] }))}
                    >Clear All</Button>
                    <Button
                      type="button"
                      variant="default"
                      size="sm"
                      onClick={() => toast({ title: 'All chapters saved!', description: 'All chapters saved successfully.' })}
                    >Save All</Button>
                  </div>
                </div>
              </TabsContent>
              <TabsContent value="settings" className="space-y-4">
                <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p className="text-sm text-blue-700 text-center italic">
                    Coming Soon
                  </p>
                </div>
                <div className="space-y-4">
                  <h4 className="font-medium">Content Security</h4>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="flex items-center space-x-2">
                      <Switch id="watermark" />
                      <Label htmlFor="watermark">Watermark Protection</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="downloadProtection" />
                      <Label htmlFor="downloadProtection">Download Protection</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="screenRecording" />
                      <Label htmlFor="screenRecording">Screen Recording Protection</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="accessLogging" />
                      <Label htmlFor="accessLogging">Access Logging</Label>
                    </div>
                  </div>
                </div>

                <Separator />

                <div className="space-y-4">
                  <h4 className="font-medium">Offline Access</h4>

                  <div className="flex items-center space-x-2">
                    <Switch id="offlineAccess" />
                    <Label htmlFor="offlineAccess">Enable Offline Access</Label>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="downloadLimit">Download Limit (per month)</Label>
                      <Input id="downloadLimit" placeholder="5" type="number" min="0" />
                    </div>
                    <div>
                      <Label htmlFor="expiryDays">Content Expiry (days)</Label>
                      <Input id="expiryDays" placeholder="30" type="number" min="1" />
                    </div>
                  </div>
                </div>

                <Separator />

                <div className="space-y-4">
                  <h4 className="font-medium">Integrations</h4>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="flex items-center space-x-2">
                      <Switch id="credentialVerification" />
                      <Label htmlFor="credentialVerification">Credential Verification API</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="marketplace" />
                      <Label htmlFor="marketplace">Content Marketplace</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="ltiIntegration" />
                      <Label htmlFor="ltiIntegration">LTI Integration</Label>
                    </div>
                  </div>
                </div>

                <Separator />

                <div className="space-y-4">
                  <h4 className="font-medium">Gamification</h4>

                  <div className="flex items-center space-x-2">
                    <Switch id="enableGamification" />
                    <Label htmlFor="enableGamification">Enable Gamification Features</Label>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="flex items-center space-x-2">
                      <Switch id="streakRewards" />
                      <Label htmlFor="streakRewards">Learning Streak Rewards</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Switch id="instructorBadges" />
                      <Label htmlFor="instructorBadges">Instructor Achievement Badges</Label>
                    </div>
                  </div>
                </div>
              </TabsContent>

              <TabsContent value="marketing" className="space-y-4">
                <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p className="text-sm text-blue-700 text-center italic">
                    Coming Soon
                  </p>
                </div>
                <div className="space-y-4">
                  <h4 className="font-medium">Promotion Templates</h4>

                  <div className="space-y-3">
                    <div>
                      <Label htmlFor="promoTemplate">Template Message</Label>
                      <Textarea
                        id="promoTemplate"
                        placeholder="üé® New Course Alert! {courseName} starting {startDate}. Early bird discount: {discount}%"
                        rows={3}
                      />
                    </div>

                    <div>
                      <Label htmlFor="promoChannels">Marketing Channels</Label>
                      <div className="flex gap-4 mt-2">
                        <div className="flex items-center space-x-2">
                          <Checkbox id="emailChannel" />
                          <Label htmlFor="emailChannel">Email</Label>
                        </div>
                        <div className="flex items-center space-x-2">
                          <Checkbox id="socialChannel" />
                          <Label htmlFor="socialChannel">Social Media</Label>
                        </div>
                        <div className="flex items-center space-x-2">
                          <Checkbox id="websiteChannel" />
                          <Label htmlFor="websiteChannel">Website</Label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <Separator />

                <div className="space-y-4">
                  <h4 className="font-medium">Seasonal Promotions</h4>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="promoName">Promotion Name</Label>
                      <Input id="promoName" placeholder="Diwali Special" />
                    </div>
                    <div>
                      <Label htmlFor="discountPercent">Discount Percentage</Label>
                      <Input id="discountPercent" placeholder="25" type="number" min="0" max="100" />
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor="promoStart">Start Date</Label>
                      <Input id="promoStart" type="date" />
                    </div>
                    <div>
                      <Label htmlFor="promoEnd">End Date</Label>
                      <Input id="promoEnd" type="date" />
                    </div>
                  </div>

                  <div>
                    <Label htmlFor="promoConditions">Conditions</Label>
                    <Textarea
                      id="promoConditions"
                      placeholder="New enrollments only, Valid for first 50 students"
                      rows={2}
                    />
                  </div>
                </div>
              </TabsContent>
            </Tabs>
            <DialogFooter>
              {isEditMode 
                ? ' '
                : <Button
                  variant="outline"
                  title='Save Draft'
                  className="border-white text-purple-700 hover:bg-gray-100 bg-white"
                                    onClick={handleSaveDraft}
                >
                  <Save className="h-4 w-4" />
                  Save Draft
                </Button>
              }
              <Button
                disabled={isCreateCourseDisabled}
                               onClick={async () => {
                  if (isEditMode && editCourseId) {
                                       const updatedCourse = {
                      ...newCourseForm,
                      id: editCourseId,
                      priceINR: parseInt(newCourseForm.priceINR || '0'),
                      maxStudents: parseInt(newCourseForm.maxStudents || '0'),
                      courseCategory: newCourseForm.courseCategory as "Regular" | "Special",
                    }
                    await fetch('/api/courses', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(updatedCourse),
                    })
                    setCourses(prevCourses => prevCourses.map(course => course.id === editCourseId ? { ...course, ...updatedCourse } : course))
                    toast({
                      title: "Course Updated Successfully!",
                      description: "Your course has been updated with the new information.",
                      action: <ToastAction altText="View Course">View Course</ToastAction>,
                    })
                    setIsEditMode(false)
                    setEditCourseId(null)
                  } else {
                    const newCourse: Course = {
                      id: newCourseForm.id || uuidv4(),
                      name: newCourseForm.name || '',
                      instructor: newCourseForm.instructor || '',
                      instructorId: '',
                      description: newCourseForm.description || '',
                      level: newCourseForm.level || '',
                      type: newCourseForm.type || '',
                      duration: newCourseForm.duration || '',
                      priceINR: parseInt(newCourseForm.priceINR || '0'),
                      price: parseInt(newCourseForm.priceINR || '0'),
                      currency: 'INR',
                      enrolledStudents: 0,
                      maxStudents: parseInt(newCourseForm.maxStudents || '0'),
                      location: newCourseForm.location || '',
                      tags: newCourseForm.tags || [],
                      schedule: newCourseForm.schedule || '',
                      schedulePeriod: newCourseForm.schedulePeriod || { startDate: '', endDate: '', totalWeeks: '18' },
                      sessionDetails: newCourseForm.sessionDetails || { sessionDuration: '', maxClasses: '18' },
                      frequencyDetails: newCourseForm.frequencyDetails || { selectedDays: [], dayTimes: {} },
                      frequencies: newCourseForm.frequencies || [],
                      chapters: newCourseForm.chapters || [],
                      referralCode: newCourseForm.referralCode || '',
                      commissionRate: newCourseForm.commissionRate || '',
                      referralStart: newCourseForm.referralStart || '',
                      referralEnd: newCourseForm.referralEnd || '',
                      referralStatus: newCourseForm.referralStatus || 'Inactive',
                      faqs: newCourseForm.faqs || [],
                      reminderSettings: newCourseForm.reminderSettings || {
                        pushEnabled: true,
                        emailEnabled: true,
                        smsEnabled: true,
                        customSchedule: [],
                        frequency: '',
                        customDays: '',
                        customInterval: ''
                      },
                      freeGifts: newCourseForm.freeGifts || [],
                      status: newCourseForm.status || 'Active',
                      courseCategory: newCourseForm.courseCategory || 'Regular',
                      rating: 0,
                      modules: [],
                      completionRate: 0,
                      cohortAnalysis: [],
                      learningBehavior: {
                        bestLearningTimes: [],
                        engagementWindows: [],
                        preferredContentTypes: [],
                        averageSessionDuration: 0,
                        peakActivityDays: [],
                      },
                      roiCalculator: {
                        courseCost: 0,
                        expectedSalaryIncrease: 0,
                        timeToROI: 0,
                        industryAverageSalary: 0,
                        skillDemandScore: 0,
                      },
                      dropoffPrediction: {
                        riskScore: 0,
                        riskFactors: [],
                        interventionSuggestions: [],
                      },
                      sharedResources: [],
                      versionControl: [],
                      materialAnalytics: {
                        resourceId: '',
                        views: 0,
                        downloads: 0,
                        averageRating: 0,
                        successRate: 0,
                        engagementTime: 0,
                      },
                      credentialVerification: false,
                      marketplaceEnabled: false,
                      ltiIntegration: false,
                      contentSecurity: {
                        watermarkEnabled: false,
                        downloadProtection: false,
                        screenRecordingProtection: false,
                        accessLogging: false,
                        licenseTracking: false,
                      },
                      offlineAccess: {
                        enabled: false,
                        downloadLimit: 0,
                        currentDownloads: 0,
                        expiryDays: 0,
                        accessLogs: [],
                      },
                      industryPartners: [],
                      events: [],
                      alumniNetwork: [],
                      promotionTemplates: [],
                      seasonalPromos: [],
                      growthAnalytics: {
                        enrollmentTrend: [],
                        revenueTrend: [],
                        completionTrend: [],
                        satisfactionTrend: [],
                      },
                    }
                    await fetch('/api/courses', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(newCourse),
                    })
                    setCourses([
                      ...courses,
                      {
                        ...newCourse,
                        instructorId: newCourse.instructorId || '',
                        enrolledStudents: newCourse.enrolledStudents || 0,
                        price: Number(newCourse.priceINR) || 0,
                        currency: 'INR',
                        rating: newCourse.rating || 0,
                        tags: newCourse.tags || [],
                        modules: newCourse.modules || [],
                        completionRate: newCourse.completionRate || 0,
                        chapters: newCourse.chapters || [],
                        schedulePeriod: newCourse.schedulePeriod || { startDate: '', endDate: '', totalWeeks: '18' },
                        sessionDetails: newCourse.sessionDetails || { sessionDuration: '', maxClasses: '18' },
                        frequencies: newCourse.frequencies || [],
                        referralCode: newCourse.referralCode || '',
                        commissionRate: newCourse.commissionRate || '',
                        referralStart: newCourse.referralStart || '',
                        referralEnd: newCourse.referralEnd || '',
                        referralStatus: newCourse.referralStatus || 'Inactive',
                        courseCategory: newCourse.courseCategory || 'Regular',
                        frequencyDetails: newCourse.frequencyDetails || { selectedDays: [], dayTimes: {} },
                        faqs: newCourse.faqs || [],
                        reminderSettings: newCourse.reminderSettings || {
                          pushEnabled: true,
                          emailEnabled: true,
                          smsEnabled: true,
                          customSchedule: [],
                          frequency: '',
                          customDays: '',
                          customInterval: ''
                        },
                        freeGifts: newCourse.freeGifts || [],
                        cohortAnalysis: newCourse.cohortAnalysis || [],
                        learningBehavior: newCourse.learningBehavior || {},
                        roiCalculator: newCourse.roiCalculator || {},
                        dropoffPrediction: newCourse.dropoffPrediction || {},
                        sharedResources: newCourse.sharedResources || [],
                        versionControl: newCourse.versionControl || [],
                        materialAnalytics: newCourse.materialAnalytics || {},
                        credentialVerification: newCourse.credentialVerification || false,
                        marketplaceEnabled: newCourse.marketplaceEnabled || false,
                        ltiIntegration: newCourse.ltiIntegration || false,
                        contentSecurity: newCourse.contentSecurity || {},
                        offlineAccess: newCourse.offlineAccess || {},
                        industryPartners: newCourse.industryPartners || [],
                        events: newCourse.events || [],
                        alumniNetwork: newCourse.alumniNetwork || [],
                        promotionTemplates: newCourse.promotionTemplates || [],
                        seasonalPromos: newCourse.seasonalPromos || [],
                        growthAnalytics: newCourse.growthAnalytics || {},
                      } as Course
                    ])
                    toast({
                      title: "Course Created Successfully!",
                      description: "Your new course has been created with all advanced features.",
                      action: <ToastAction altText="View Course">View Course</ToastAction>,
                    })
                  }
                  setIsAddCourseDialogOpen(false)
                  setIsEditMode(false)
                  setEditCourseId(null)

                  setNewCourseForm({
                    name: '',
                    instructor: '',
                    description: '',
                    level: '',
                    type: '',
                    duration: '',
                    priceINR: '',
                    schedule: '',
                    maxStudents: '',
                    location: '',
                    tags: [],
                    schedulePeriod: { startDate: '', endDate: '', totalWeeks: '18' },
                    sessionDetails: { sessionDuration: '', maxClasses: '18' },
                    frequencyDetails: { selectedDays: [], dayTimes: {} },
                    frequencies: [],
                    referralCode: '',
                    commissionRate: '',
                    referralStart: '',
                    referralEnd: '',
                    referralStatus: 'Inactive',
                    faqs: [{ question: '', answer: '', isEditing: false }],
                    chapters: [{ name: '', description: '', referencePdf: undefined, assignmentPdf: undefined }],
                    reminderSettings: {
                      pushEnabled: true,
                      emailEnabled: true,
                      smsEnabled: true,
                      customSchedule: [],
                      frequency: '',
                      customDays: '',
                      customInterval: ''
                    },
                    freeGifts: [],
                    status: 'Active',
                    courseCategory: 'Regular',
                  })
                }}
              >
                {isEditMode 
                  ? 'Save Changes'
                  : 'Create Course'
                }
              </Button>
            </DialogFooter>
          </DialogContent>
          
        </Dialog>
        {/* Enhanced Feature Cards */}
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
          <Card
            className="hover:shadow-md transition-shadow cursor-pointer"
            onClick={() => setIsFinancialDialogOpen(true)}
          >
            <CardContent className="p-4 text-center">
              <CreditCard className="h-8 w-8 text-purple-600 mx-auto mb-2" />
              <h3 className="font-medium text-sm">Financial Tools <span title="Coming Soon"> üîú</span></h3>
              <p className="text-xs text-gray-500">EMI, Tax</p>
            </CardContent>
          </Card>

          

          <Card className="hover:shadow-md transition-shadow cursor-pointer">
            <CardContent className="p-4 text-center">
              <Zap className="h-8 w-8 text-yellow-600 mx-auto mb-2" />
              <h3 className="font-medium text-sm">AI Assistant <span title="Coming Soon"> üîú</span></h3>
              <p className="text-xs text-gray-500">Smart scheduling</p>
            </CardContent>
          </Card>

          <Card className="hover:shadow-md transition-shadow cursor-pointer">
            <CardContent className="p-4 text-center">
              <Target className="h-8 w-8 text-green-600 mx-auto mb-2" />
              <h3 className="font-medium text-sm">Gamification <span title="Coming Soon"> üîú</span></h3>
              <p className="text-xs text-gray-500">Badges & rewards</p>
            </CardContent>
          </Card>

          <Card className="hover:shadow-md transition-shadow cursor-pointer">
            <CardContent className="p-4 text-center">
              <Shield className="h-8 w-8 text-blue-600 mx-auto mb-2" />
              <h3 className="font-medium text-sm">Content Security <span title="Coming Soon"> üîú</span></h3>
              <p className="text-xs text-gray-500">Piracy protection</p>
            </CardContent>
          </Card>

          <Card className="hover:shadow-md transition-shadow cursor-pointer">
            <CardContent className="p-4 text-center">
              <Briefcase className="h-8 w-8 text-indigo-600 mx-auto mb-2" />
              <h3 className="font-medium text-sm">Industry Partners <span title="Coming Soon"> üîú</span></h3>
              <p className="text-xs text-gray-500">Jobs & internships</p>
            </CardContent>
          </Card>
        </div>

        {/* Delete Confirmation Dialog */}
        <Dialog open={deleteConfirmDialog.isOpen} onOpenChange={(open) => setDeleteConfirmDialog(prev => ({ ...prev, isOpen: open }))}>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2 text-red-600">
                <AlertCircle className="h-5 w-5" />
                {deleteConfirmDialog.title}
              </DialogTitle>
              <DialogDescription asChild className="pt-2">
                <div>
                  {deleteConfirmDialog.message}
                  {deleteConfirmDialog.itemName && (
                    <div className="mt-2 p-2 bg-gray-50 rounded border-l-4 border-red-400">
                      <span className="font-semibold text-red-700">{deleteConfirmDialog.itemName}</span>
                    </div>
                  )}
                </div>
              </DialogDescription>
            </DialogHeader>
            <DialogFooter className="flex gap-2">
              <Button
                variant="outline"
                onClick={() => setDeleteConfirmDialog(prev => ({ ...prev, isOpen: false }))}
              >
                Cancel
              </Button>
              <Button
                variant="destructive"
                onClick={() => {
                  deleteConfirmDialog.onConfirm();
                  setDeleteConfirmDialog(prev => ({ ...prev, isOpen: false }));
                }}
              >
                <Trash2 className="mr-2 h-4 w-4" />
                Delete
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </MainLayout>
  )
}
